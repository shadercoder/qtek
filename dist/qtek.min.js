!function(a){"undefined"!=typeof define&&define.amd?define(["exports"],a.bind(window)):a(window.qtek={})}(function(a){var b,c,d;!function(a){function e(a,b){return u.call(a,b)}function f(a,b){var c,d,e,f,g,h,i,j,k,l,m=b&&b.split("/"),n=s.map,o=n&&n["*"]||{};if(a&&"."===a.charAt(0))if(b){for(m=m.slice(0,m.length-1),a=m.concat(a.split("/")),j=0;j<a.length;j+=1)if(l=a[j],"."===l)a.splice(j,1),j-=1;else if(".."===l){if(1===j&&(".."===a[2]||".."===a[0]))break;j>0&&(a.splice(j-1,2),j-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((m||o)&&n){for(c=a.split("/"),j=c.length;j>0;j-=1){if(d=c.slice(0,j).join("/"),m)for(k=m.length;k>0;k-=1)if(e=n[m.slice(0,k).join("/")],e&&(e=e[d])){f=e,g=j;break}if(f)break;!h&&o&&o[d]&&(h=o[d],i=j)}!f&&h&&(f=h,g=i),f&&(c.splice(0,g,f),a=c.join("/"))}return a}function g(b,c){return function(){return n.apply(a,v.call(arguments,0).concat([b,c]))}}function h(a){return function(b){return f(b,a)}}function i(a){return function(b){q[a]=b}}function j(b){if(e(r,b)){var c=r[b];delete r[b],t[b]=!0,m.apply(a,c)}if(!e(q,b)&&!e(t,b))throw new Error("No "+b);return q[b]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice;o=function(a,b){var c,d=k(a),e=d[0];return a=d[1],e&&(e=f(e,b),c=j(e)),e?a=c&&c.normalize?c.normalize(a,h(b)):f(a,b):(a=f(a,b),d=k(a),e=d[0],a=d[1],e&&(c=j(e))),{f:e?e+"!"+a:a,n:a,pr:e,p:c}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(b,c,d,f){var h,k,l,m,n,s,u=[];if(f=f||b,"function"==typeof d){for(c=!c.length&&d.length?["require","exports","module"]:c,n=0;n<c.length;n+=1)if(m=o(c[n],f),k=m.f,"require"===k)u[n]=p.require(b);else if("exports"===k)u[n]=p.exports(b),s=!0;else if("module"===k)h=u[n]=p.module(b);else if(e(q,k)||e(r,k)||e(t,k))u[n]=j(k);else{if(!m.p)throw new Error(b+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=d.apply(q[b],u),b&&(h&&h.exports!==a&&h.exports!==q[b]?q[b]=h.exports:l===a&&s||(q[b]=l))}else b&&(q[b]=d)},b=c=n=function(b,c,d,e,f){return"string"==typeof b?p[b]?p[b](c):j(o(b,c).f):(b.splice||(s=b,c.splice?(b=c,c=d,d=null):b=a),c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(a,b,c,d):setTimeout(function(){m(a,b,c,d)},4),n)},n.config=function(a){return s=a,s.deps&&n(s.deps,s.callback),n},d=function(a,b,c){b.splice||(c=b,b=[]),e(q,a)||e(r,a)||(r[a]=[a,b,c])},d.amd={jQuery:!0}}(),d("core/mixin/derive",["require"],function(){function a(a,c,d){"object"==typeof c&&(d=c,c=null);var e=this,f=function(c){if(e.call(this),b(this,"function"==typeof a?a.call(this):a),c&&b(this,c),this.constructor===f){for(var d=f,g=[];d;)d.__initialize__&&g.push(d.__initialize__),d=d.__super__;for(var h=g.length-1;h>=0;h--)g[h].call(this)}};f.__super__=e,f.__initialize__=c;var g=function(){};return g.prototype=e.prototype,f.prototype=new g,f.prototype.constructor=f,b(f.prototype,d),f.derive=e.derive,f}function b(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}return{derive:a}}),d("core/mixin/notifier",[],function(){function a(a,b){this.action=a,this.context=b}return{trigger:function(a){if(this.hasOwnProperty("__handlers__")&&this.__handlers__.hasOwnProperty(a)){var b=this.__handlers__[a],c=b.length,d=-1,e=arguments;switch(e.length){case 1:for(;++d<c;)b[d].action.call(b[d].context);return;case 2:for(;++d<c;)b[d].action.call(b[d].context,e[1]);return;case 3:for(;++d<c;)b[d].action.call(b[d].context,e[1],e[2]);return;case 4:for(;++d<c;)b[d].action.call(b[d].context,e[1],e[2],e[3]);return;case 5:for(;++d<c;)b[d].action.call(b[d].context,e[1],e[2],e[3],e[4]);return;default:for(;++d<c;)b[d].action.apply(b[d].context,Array.prototype.slice.call(e,1));return}}},on:function(b,c,d){if(b&&c){var e=this.__handlers__||(this.__handlers__={});if(e[b]){if(this.has(b,c))return}else e[b]=[];var f=new a(c,d||this);return e[b].push(f),f}},once:function(a,b,c){function d(){e.off(a,d),b.apply(this,arguments)}if(a&&b){var e=this;return this.on(a,d,c)}},before:function(a,b,c){return a&&b?(a="before"+a,this.on(a,b,c)):void 0},after:function(a,b,c){return a&&b?(a="after"+a,this.on(a,b,c)):void 0},success:function(a,b){return this.once("success",a,b)},error:function(){return this.once("error",action,context)},off:function(a,b){var c=this.__handlers__||(this.__handlers__={});if(!b)return c[a]=[],void 0;if(c[a]){for(var d=c[a],e=[],f=0;f<d.length;f++)b&&d[f].action!==b&&e.push(d[f]);c[a]=e}},has:function(a,b){var c=this.__handlers__;if(!c||!c[a])return!1;for(var d=c[a],e=0;e<d.length;e++)if(d[e].action===b)return!0}}}),d("core/Cache",[],function(){var a=function(){this._contextId=0,this._caches=[],this._context={}};return a.prototype={use:function(a,b){this._caches[a]||(this._caches[a]={},b&&(this._caches[a]=b())),this._contextId=a,this._context=this._caches[a]},put:function(a,b){this._context[a]=b},get:function(a){return this._context[a]},dirty:function(a){a=a||"";var b="__dirty__"+a;this.put(b,!0)},dirtyAll:function(a){a=a||"";for(var b="__dirty__"+a,c=0;c<this._caches.length;c++)this._caches[c]&&(this._caches[c][b]=!0)},fresh:function(a){a=a||"";var b="__dirty__"+a;this.put(b,!1)},freshAll:function(a){a=a||"";for(var b="__dirty__"+a,c=0;c<this._caches.length;c++)this._caches[c]&&(this._caches[c][b]=!1)},isDirty:function(a){a=a||"";var b="__dirty__"+a;return!this._context.hasOwnProperty(b)||this._context[b]===!0},clearContext:function(){this._caches[this._contextId]={},this._context={}},deleteContext:function(a){this._caches[a]={},this._context={}},"delete":function(a){delete this._context[a]},clearAll:function(){this._caches={}},getContext:function(){return this._context},miss:function(a){return!this._context.hasOwnProperty(a)}},a.prototype.constructor=a,a}),function(a){function b(d){function e(a){return a&&"object"==typeof a&&!td(a)&&Zc.call(a,"__wrapped__")?a:new R(a)}function g(a,b,c){var d=a.length,e=d-b>=c;if(e)for(var f={},g=b-1;++g<d;){var h=Oc(a[g]);(Zc.call(f,h)?f[h]:f[h]=[]).push(a[g])}return function(c){if(e){var d=Oc(c);return Zc.call(f,d)&&Tb(f[d],c)>-1}return Tb(a,c,b)>-1}}function K(a){return a.charCodeAt(0)}function L(a,b){var c=a.index,d=b.index;if(a=a.criteria,b=b.criteria,a!==b){if(a>b||"undefined"==typeof a)return 1;if(b>a||"undefined"==typeof b)return-1}return d>c?-1:1}function M(a,b,c,d){function e(){var d=arguments,j=g?this:b;if(f||(a=b[h]),c.length&&(d=d.length?(d=U(d),i?d.concat(c):c.concat(d)):c),this instanceof e){S.prototype=a.prototype,j=new S,S.prototype=null;var k=a.apply(j,d);return ib(k)?k:j}return a.apply(j,d)}var f=hb(a),g=!c,h=b;if(g){var i=d;c=b}else if(!f){if(!d)throw new Pc;b=a}return e}function N(){for(var a,b={shadowedProps:v,arrays:"isArray(iterable)",bottom:"",init:"iterable",loop:"",top:"",useHas:!0,useKeys:!!vd},c=0;a=arguments[c];c++)for(var d in a)b[d]=a[d];var f=b.args;b.firstArg=/^[^,]+/.exec(f)[0];var g=Jc("hasOwnProperty, isArguments, isArray, isString, keys, lodash, objectTypes","return function("+f+") {\n"+pd(b)+"\n}");return g(Zc,W,td,nb,vd,e,H)}function O(a){return"\\"+I[a]}function P(a){return xd[a]}function Q(a){return"function"!=typeof a.toString&&"string"==typeof(a+"")}function R(a){this.__wrapped__=a}function S(){}function T(a){var b=!1;if(!a||bd.call(a)!=D||!od.argsClass&&W(a))return b;var c=a.constructor;return(hb(c)?c instanceof c:od.nodeClass||!Q(a))?od.ownLast?(Bd(a,function(a,c,d){return b=Zc.call(d,c),!1}),b===!0):(Bd(a,function(a,c){b=c}),b===!1||Zc.call(a,b)):b}function U(a,b,c){b||(b=0),"undefined"==typeof c&&(c=a?a.length:0);for(var d=-1,e=c-b||0,f=Gc(0>e?0:e);++d<e;)f[d]=a[b+d];return f}function V(a){return yd[a]}function W(a){return bd.call(a)==x}function X(a,b,d,f,g,h){var i=a;if("function"==typeof b&&(f=d,d=b,b=!1),"function"==typeof d){if(d="undefined"==typeof f?d:e.createCallback(d,f,1),i=d(i),"undefined"!=typeof i)return i;i=a}var j=ib(i);if(j){var k=bd.call(i);if(!G[k]||!od.nodeClass&&Q(i))return i;var l=td(i)}if(!j||!b)return j?l?U(i):zd({},i):i;var m=nd[k];switch(k){case z:case A:return new m(+i);case C:case F:return new m(i);case E:return m(i.source,o.exec(i))}g||(g=[]),h||(h=[]);for(var n=g.length;n--;)if(g[n]==a)return h[n];return i=l?m(i.length):{},l&&(Zc.call(a,"index")&&(i.index=a.index),Zc.call(a,"input")&&(i.input=a.input)),g.push(a),h.push(i),(l?Ab:Cd)(a,function(a,e){i[e]=X(a,b,d,c,g,h)}),i}function Y(a,b,c){return X(a,!0,b,c)}function Z(a,b,c){var d;return b=e.createCallback(b,c),Cd(a,function(a,c,e){return b(a,c,e)?(d=c,!1):void 0}),d}function $(a){var b=[];return Bd(a,function(a,c){hb(a)&&b.push(c)}),b.sort()}function _(a,b){return a?Zc.call(a,b):!1}function ab(a){for(var b=-1,c=vd(a),d=c.length,e={};++b<d;){var f=c[b];e[a[f]]=f}return e}function bb(a){return a===!0||a===!1||bd.call(a)==z}function cb(a){return a instanceof Ic||bd.call(a)==A}function db(a){return a?1===a.nodeType:!1}function eb(a){var b=!0;if(!a)return b;var c=bd.call(a),d=a.length;return c==y||c==F||(od.argsClass?c==x:W(a))||c==D&&"number"==typeof d&&hb(a.splice)?!d:(Cd(a,function(){return b=!1}),b)}function fb(a,b,c,d,f,g){var h=c===i;if(c&&!h){c="undefined"==typeof d?c:e.createCallback(c,d,2);var j=c(a,b);if("undefined"!=typeof j)return!!j}if(a===b)return 0!==a||1/a==1/b;var k=typeof a,l=typeof b;if(a===a&&(!a||"function"!=k&&"object"!=k)&&(!b||"function"!=l&&"object"!=l))return!1;if(null==a||null==b)return a===b;var m=bd.call(a),n=bd.call(b);if(m==x&&(m=D),n==x&&(n=D),m!=n)return!1;switch(m){case z:case A:return+a==+b;case C:return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case E:case F:return a==Oc(b)}var o=m==y;if(!o){if(Zc.call(a,"__wrapped__ ")||Zc.call(b,"__wrapped__"))return fb(a.__wrapped__||a,b.__wrapped__||b,c,d,f,g);if(m!=D||!od.nodeClass&&(Q(a)||Q(b)))return!1;var p=!od.argsObject&&W(a)?Mc:a.constructor,q=!od.argsObject&&W(b)?Mc:b.constructor;if(p!=q&&!(hb(p)&&p instanceof p&&hb(q)&&q instanceof q))return!1}f||(f=[]),g||(g=[]);for(var r=f.length;r--;)if(f[r]==a)return g[r]==b;var s=0;if(j=!0,f.push(a),g.push(b),o){if(r=a.length,s=b.length,j=s==a.length,!j&&!h)return j;for(;s--;){var t=r,u=b[s];if(h)for(;t--&&!(j=fb(a[t],u,c,d,f,g)););else if(!(j=fb(a[s],u,c,d,f,g)))break}return j}return Bd(b,function(b,e,h){return Zc.call(h,e)?(s++,j=Zc.call(a,e)&&fb(a[e],b,c,d,f,g)):void 0}),j&&!h&&Bd(a,function(a,b,c){return Zc.call(c,b)?j=--s>-1:void 0}),j}function gb(a){return ed(a)&&!fd(parseFloat(a))}function hb(a){return"function"==typeof a}function ib(a){return a?H[typeof a]:!1}function jb(a){return lb(a)&&a!=+a}function kb(a){return null===a}function lb(a){return"number"==typeof a||bd.call(a)==C}function mb(a){return a instanceof Nc||bd.call(a)==E}function nb(a){return"string"==typeof a||bd.call(a)==F}function ob(a){return"undefined"==typeof a}function pb(a,b,c){var d=arguments,f=0,g=2;if(!ib(a))return a;if(c===i)var h=d[3],j=d[4],k=d[5];else j=[],k=[],"number"!=typeof c&&(g=d.length),g>3&&"function"==typeof d[g-2]?h=e.createCallback(d[--g-1],d[g--],2):g>2&&"function"==typeof d[g-1]&&(h=d[--g]);for(;++f<g;)(td(d[f])?Ab:Cd)(d[f],function(b,c){var d,e,f=b,g=a[c];if(b&&((e=td(b))||Dd(b))){for(var l=j.length;l--;)if(d=j[l]==b){g=k[l];break}d||(g=e?td(g)?g:[]:Dd(g)?g:{},h&&(f=h(g,b),"undefined"!=typeof f&&(g=f)),j.push(b),k.push(g),h||(g=pb(g,b,i,h,j,k)))}else h&&(f=h(g,b),"undefined"==typeof f&&(f=b)),"undefined"!=typeof f&&(g=f);a[c]=g});return a}function qb(a,b,c){var d="function"==typeof b,f={};if(d)b=e.createCallback(b,c);else var g=Wc.apply(Qc,arguments);return Bd(a,function(a,c,e){(d?!b(a,c,e):Tb(g,c,1)<0)&&(f[c]=a)}),f}function rb(a){for(var b=-1,c=vd(a),d=c.length,e=Gc(d);++b<d;){var f=c[b];e[b]=[f,a[f]]}return e}function sb(a,b,c){var d={};if("function"!=typeof b)for(var f=0,g=Wc.apply(Qc,arguments),h=ib(a)?g.length:0;++f<h;){var i=g[f];i in a&&(d[i]=a[i])}else b=e.createCallback(b,c),Bd(a,function(a,c,e){b(a,c,e)&&(d[c]=a)});return d}function tb(a){for(var b=-1,c=vd(a),d=c.length,e=Gc(d);++b<d;)e[b]=a[c[b]];return e}function ub(a){var b=-1,c=Wc.apply(Qc,U(arguments,1)),d=c.length,e=Gc(d);for(od.unindexedChars&&nb(a)&&(a=a.split(""));++b<d;)e[b]=a[c[b]];return e}function vb(a,b,c){var d=-1,e=a?a.length:0,f=!1;return c=(0>c?hd(0,e+c):c)||0,"number"==typeof e?f=(nb(a)?a.indexOf(b,c):Tb(a,b,c))>-1:wd(a,function(a){return++d>=c?!(f=a===b):void 0}),f}function wb(a,b,c){var d={};return b=e.createCallback(b,c),Ab(a,function(a,c,e){c=Oc(b(a,c,e)),Zc.call(d,c)?d[c]++:d[c]=1}),d}function xb(a,b,c){var d=!0;if(b=e.createCallback(b,c),td(a))for(var f=-1,g=a.length;++f<g&&(d=!!b(a[f],f,a)););else wd(a,function(a,c,e){return d=!!b(a,c,e)});return d}function yb(a,b,c){var d=[];if(b=e.createCallback(b,c),td(a))for(var f=-1,g=a.length;++f<g;){var h=a[f];b(h,f,a)&&d.push(h)}else wd(a,function(a,c,e){b(a,c,e)&&d.push(a)});return d}function zb(a,b,c){if(b=e.createCallback(b,c),!td(a)){var d;return wd(a,function(a,c,e){return b(a,c,e)?(d=a,!1):void 0}),d}for(var f=-1,g=a.length;++f<g;){var h=a[f];if(b(h,f,a))return h}}function Ab(a,b,c){if(b&&"undefined"==typeof c&&td(a))for(var d=-1,e=a.length;++d<e&&b(a[d],d,a)!==!1;);else wd(a,b,c);return a}function Bb(a,b,c){var d={};return b=e.createCallback(b,c),Ab(a,function(a,c,e){c=Oc(b(a,c,e)),(Zc.call(d,c)?d[c]:d[c]=[]).push(a)}),d}function Cb(a,b){var c=U(arguments,2),d=-1,e="function"==typeof b,f=a?a.length:0,g=Gc("number"==typeof f?f:0);return Ab(a,function(a){g[++d]=(e?b:a[b]).apply(a,c)}),g}function Db(a,b,c){var d=-1,f=a?a.length:0,g=Gc("number"==typeof f?f:0);if(b=e.createCallback(b,c),td(a))for(;++d<f;)g[d]=b(a[d],d,a);else wd(a,function(a,c,e){g[++d]=b(a,c,e)});return g}function Eb(a,b,c){var d=-1/0,f=d;if(!b&&td(a))for(var g=-1,h=a.length;++g<h;){var i=a[g];i>f&&(f=i)}else b=!b&&nb(a)?K:e.createCallback(b,c),wd(a,function(a,c,e){var g=b(a,c,e);g>d&&(d=g,f=a)});return f}function Fb(a,b,c){var d=1/0,f=d;if(!b&&td(a))for(var g=-1,h=a.length;++g<h;){var i=a[g];f>i&&(f=i)}else b=!b&&nb(a)?K:e.createCallback(b,c),wd(a,function(a,c,e){var g=b(a,c,e);d>g&&(d=g,f=a)});return f}function Gb(a,b,c,d){var f=arguments.length<3;if(b=e.createCallback(b,d,4),td(a)){var g=-1,h=a.length;for(f&&(c=a[++g]);++g<h;)c=b(c,a[g],g,a)}else wd(a,function(a,d,e){c=f?(f=!1,a):b(c,a,d,e)});return c}function Hb(a,b,c,d){var f=a,g=a?a.length:0,h=arguments.length<3;if("number"!=typeof g){var i=vd(a);g=i.length}else od.unindexedChars&&nb(a)&&(f=a.split(""));return b=e.createCallback(b,d,4),Ab(a,function(a,d,e){d=i?i[--g]:--g,c=h?(h=!1,f[d]):b(c,f[d],d,e)}),c}function Ib(a,b,c){return b=e.createCallback(b,c),yb(a,function(a,c,d){return!b(a,c,d)})}function Jb(a){var b=-1,c=a?a.length:0,d=Gc("number"==typeof c?c:0);return Ab(a,function(a){var c=Xc(kd()*(++b+1));d[b]=d[c],d[c]=a}),d}function Kb(a){var b=a?a.length:0;return"number"==typeof b?b:vd(a).length}function Lb(a,b,c){var d;if(b=e.createCallback(b,c),td(a))for(var f=-1,g=a.length;++f<g&&!(d=b(a[f],f,a)););else wd(a,function(a,c,e){return!(d=b(a,c,e))});return!!d}function Mb(a,b,c){var d=-1,f=a?a.length:0,g=Gc("number"==typeof f?f:0);for(b=e.createCallback(b,c),Ab(a,function(a,c,e){g[++d]={criteria:b(a,c,e),index:d,value:a}}),f=g.length,g.sort(L);f--;)g[f]=g[f].value;return g}function Nb(a){return a&&"number"==typeof a.length?od.unindexedChars&&nb(a)?a.split(""):U(a):tb(a)}function Ob(a){for(var b=-1,c=a?a.length:0,d=[];++b<c;){var e=a[b];e&&d.push(e)}return d}function Pb(a){for(var b=-1,c=a?a.length:0,d=Wc.apply(Qc,arguments),e=g(d,c,100),f=[];++b<c;){var h=a[b];e(h)||f.push(h)}return f}function Qb(a,b,c){var d=-1,f=a?a.length:0;for(b=e.createCallback(b,c);++d<f;)if(b(a[d],d,a))return d;return-1}function Rb(a,b,c){if(a){var d=0,f=a.length;if("number"!=typeof b&&null!=b){var g=-1;for(b=e.createCallback(b,c);++g<f&&b(a[g],g,a);)d++}else if(d=b,null==d||c)return a[0];return U(a,0,id(hd(0,d),f))}}function Sb(a,b,c,d){var f=-1,g=a?a.length:0,h=[];for("boolean"!=typeof b&&null!=b&&(d=c,c=b,b=!1),null!=c&&(c=e.createCallback(c,d));++f<g;){var i=a[f];c&&(i=c(i,f,a)),td(i)?$c.apply(h,b?i:Sb(i)):h.push(i)}return h}function Tb(a,b,c){var d=-1,e=a?a.length:0;if("number"==typeof c)d=(0>c?hd(0,e+c):c||0)-1;else if(c)return d=$b(a,b),a[d]===b?d:-1;for(;++d<e;)if(a[d]===b)return d;return-1}function Ub(a,b,c){if(!a)return[];var d=0,f=a.length;if("number"!=typeof b&&null!=b){var g=f;for(b=e.createCallback(b,c);g--&&b(a[g],g,a);)d++}else d=null==b||c?1:b||d;return U(a,0,id(hd(0,f-d),f))}function Vb(a){var b=arguments,c=b.length,d={0:{}},e=-1,f=a?a.length:0,h=f>=100,i=[],j=i;a:for(;++e<f;){var k=a[e];if(h)var l=Oc(k),m=Zc.call(d[0],l)?!(j=d[0][l]):j=d[0][l]=[];if(m||Tb(j,k)<0){h&&j.push(k);for(var n=c;--n;)if(!(d[n]||(d[n]=g(b[n],0,100)))(k))continue a;i.push(k)}}return i}function Wb(a,b,c){if(a){var d=0,f=a.length;if("number"!=typeof b&&null!=b){var g=f;for(b=e.createCallback(b,c);g--&&b(a[g],g,a);)d++}else if(d=b,null==d||c)return a[f-1];return U(a,hd(0,f-d))}}function Xb(a,b,c){var d=a?a.length:0;for("number"==typeof c&&(d=(0>c?hd(0,d+c):id(c,d-1))+1);d--;)if(a[d]===b)return d;return-1}function Yb(a,b,c){a=+a||0,c=+c||1,null==b&&(b=a,a=0);for(var d=-1,e=hd(0,Uc((b-a)/c)),f=Gc(e);++d<e;)f[d]=a,a+=c;return f}function Zb(a,b,c){if("number"!=typeof b&&null!=b){var d=0,f=-1,g=a?a.length:0;for(b=e.createCallback(b,c);++f<g&&b(a[f],f,a);)d++}else d=null==b||c?1:hd(0,b);return U(a,d)}function $b(a,b,c,d){var f=0,g=a?a.length:f;for(c=c?e.createCallback(c,d,1):uc,b=c(b);g>f;){var h=f+g>>>1;c(a[h])<b?f=h+1:g=h}return f}function _b(){return ac(Wc.apply(Qc,arguments))}function ac(a,b,c,d){var f=-1,g=a?a.length:0,h=[],i=h;"boolean"!=typeof b&&null!=b&&(d=c,c=b,b=!1);var j=!b&&g>=75;if(j)var k={};for(null!=c&&(i=[],c=e.createCallback(c,d));++f<g;){var l=a[f],m=c?c(l,f,a):l;if(j)var n=Oc(m),o=Zc.call(k,n)?!(i=k[n]):i=k[n]=[];(b?!f||i[i.length-1]!==m:o||Tb(i,m)<0)&&((c||j)&&i.push(m),h.push(l))}return h}function bc(a){for(var b=-1,c=a?a.length:0,d=g(arguments,1,30),e=[];++b<c;){var f=a[b];d(f)||e.push(f)}return e}function cc(a){for(var b=-1,c=a?Eb(Ed(arguments,"length")):0,d=Gc(c);++b<c;)d[b]=Ed(arguments,b);return d}function dc(a,b){for(var c=-1,d=a?a.length:0,e={};++c<d;){var f=a[c];b?e[f]=b[c]:e[f[0]]=f[1]}return e}function ec(a,b){return 1>a?b():function(){return--a<1?b.apply(this,arguments):void 0}}function fc(a,b){return od.fastBind||cd&&arguments.length>2?cd.call.apply(cd,arguments):M(a,b,U(arguments,2))}function gc(a){for(var b=Wc.apply(Qc,arguments),c=b.length>1?0:(b=$(a),-1),d=b.length;++c<d;){var e=b[c];a[e]=fc(a[e],a)}return a}function hc(a,b){return M(a,b,U(arguments,2),i)}function ic(){var a=arguments;return function(){for(var b=arguments,c=a.length;c--;)b=[a[c].apply(this,b)];return b[0]}}function jc(a,b,c){if(null==a)return uc;var d=typeof a;if("function"!=d){if("object"!=d)return function(b){return b[a]};var e=vd(a);return function(b){for(var c=e.length,d=!1;c--&&(d=fb(b[e[c]],a[e[c]],i)););return d}}return"undefined"!=typeof b?1===c?function(c){return a.call(b,c)}:2===c?function(c,d){return a.call(b,c,d)}:4===c?function(c,d,e,f){return a.call(b,c,d,e,f)}:function(c,d,e){return a.call(b,c,d,e)}:a}function kc(a,b,c){function d(){h=null,c||(f=a.apply(g,e))}var e,f,g,h;return function(){var i=c&&!h;return e=arguments,g=this,Vc(h),h=ad(d,b),i&&(f=a.apply(g,e)),f}}function lc(a){var b=U(arguments,1);return ad(function(){a.apply(c,b)},1)}function mc(a,b){var d=U(arguments,2);return ad(function(){a.apply(c,d)},b)}function nc(a,b){var c={};return function(){var d=Oc(b?b.apply(this,arguments):arguments[0]);return Zc.call(c,d)?c[d]:c[d]=a.apply(this,arguments)}}function oc(a){var b,c;return function(){return b?c:(b=!0,c=a.apply(this,arguments),a=null,c)}}function pc(a){return M(a,U(arguments,1))}function qc(a){return M(a,U(arguments,1),null,i)}function rc(a,b){function c(){h=new Ic,g=null,e=a.apply(f,d)}var d,e,f,g,h=0;return function(){var i=new Ic,j=b-(i-h);return d=arguments,f=this,0>=j?(Vc(g),g=null,h=i,e=a.apply(f,d)):g||(g=ad(c,j)),e}}function sc(a,b){return function(){var c=[a];return $c.apply(c,arguments),b.apply(this,c)}}function tc(a){return null==a?"":Oc(a).replace(s,P)}function uc(a){return a}function vc(a){Ab($(a),function(b){var c=e[b]=a[b];e.prototype[b]=function(){var a=this.__wrapped__,b=[a];$c.apply(b,arguments);var d=c.apply(e,b);return a&&"object"==typeof a&&a==d?this:new R(d)}})}function wc(){return d._=Sc,this}function xc(a,b){return null==a&&null==b&&(b=1),a=+a||0,null==b&&(b=a,a=0),a+Xc(kd()*((+b||0)-a+1))}function yc(a,b){var d=a?a[b]:c;return hb(d)?a[b]():d}function zc(a,b,d){var f=e.templateSettings;a||(a=""),d=Ad({},d,f);var g,h=Ad({},d.imports,f.imports),i=vd(h),m=tb(h),o=0,q=d.interpolate||r,s="__p += '",u=Nc((d.escape||r).source+"|"+q.source+"|"+(q===p?n:r).source+"|"+(d.evaluate||r).source+"|$","g");a.replace(u,function(b,c,d,e,f,h){return d||(d=e),s+=a.slice(o,h).replace(t,O),c&&(s+="' +\n__e("+c+") +\n'"),f&&(g=!0,s+="';\n"+f+";\n__p += '"),d&&(s+="' +\n((__t = ("+d+")) == null ? '' : __t) +\n'"),o=h+b.length,b}),s+="';\n";var v=d.variable,x=v;x||(v="obj",s="with ("+v+") {\n"+s+"\n}\n"),s=(g?s.replace(j,""):s).replace(k,"$1").replace(l,"$1;"),s="function("+v+") {\n"+(x?"":v+" || ("+v+" = {});\n")+"var __t, __p = '', __e = _.escape"+(g?", __j = Array.prototype.join;\nfunction print() { __p += __j.call(arguments, '') }\n":";\n")+s+"return __p\n}";var y="\n/*\n//@ sourceURL="+(d.sourceURL||"/lodash/template/source["+w++ +"]")+"\n*/";try{var z=Jc(i,"return "+s+y).apply(c,m)}catch(A){throw A.source=s,A}return b?z(b):(z.source=s,z)}function Ac(a,b,c){a=(a=+a)>-1?a:0;var d=-1,f=Gc(a);for(b=e.createCallback(b,c,1);++d<a;)f[d]=b(d);return f}function Bc(a){return null==a?"":Oc(a).replace(m,V)}function Cc(a){var b=++h;return Oc(null==a?"":a)+b}function Dc(a,b){return b(a),a}function Ec(){return Oc(this.__wrapped__)}function Fc(){return this.__wrapped__}d=d?J.defaults(a.Object(),d,J.pick(a,u)):a;var Gc=d.Array,Hc=d.Boolean,Ic=d.Date,Jc=d.Function,Kc=d.Math,Lc=d.Number,Mc=d.Object,Nc=d.RegExp,Oc=d.String,Pc=d.TypeError,Qc=Gc(),Rc=Mc(),Sc=d._,Tc=Nc("^"+Oc(Rc.valueOf).replace(/[.*+?^${}()|[\]\\]/g,"\\$&").replace(/valueOf|for [^\]]+/g,".+?")+"$"),Uc=Kc.ceil,Vc=d.clearTimeout,Wc=Qc.concat,Xc=Kc.floor,Yc=Tc.test(Yc=Mc.getPrototypeOf)&&Yc,Zc=Rc.hasOwnProperty,$c=Qc.push,_c=d.setImmediate,ad=d.setTimeout,bd=Rc.toString,cd=Tc.test(cd=U.bind)&&cd,dd=Tc.test(dd=Gc.isArray)&&dd,ed=d.isFinite,fd=d.isNaN,gd=Tc.test(gd=Mc.keys)&&gd,hd=Kc.max,id=Kc.min,jd=d.parseInt,kd=Kc.random,ld=Tc.test(d.attachEvent),md=cd&&!/\n|true/.test(cd+ld),nd={};nd[y]=Gc,nd[z]=Hc,nd[A]=Ic,nd[D]=Mc,nd[C]=Lc,nd[E]=Nc,nd[F]=Oc;var od=e.support={};!function(){var a=function(){this.x=1},b={0:1,length:1},c=[];a.prototype={valueOf:1,y:1};for(var d in new a)c.push(d);for(d in arguments);od.argsObject=arguments.constructor==Mc,od.argsClass=W(arguments),od.enumPrototypes=a.propertyIsEnumerable("prototype"),od.fastBind=cd&&!md,od.ownLast="x"!=c[0],od.nonEnumArgs=0!=d,od.nonEnumShadows=!/valueOf/.test(c),od.spliceObjects=(Qc.splice.call(b,0,1),!b[0]),od.unindexedChars="xx"!="x"[0]+Mc("x")[0];try{od.nodeClass=!(bd.call(document)==D&&!({toString:0}+""))}catch(e){od.nodeClass=!0}}(1),e.templateSettings={escape:/<%-([\s\S]+?)%>/g,evaluate:/<%([\s\S]+?)%>/g,interpolate:p,variable:"",imports:{_:e}};var pd=function(a){var b="var index, iterable = "+a.firstArg+", result = "+a.init+";\nif (!iterable) return result;\n"+a.top+";\n";if(a.arrays?(b+="var length = iterable.length; index = -1;\nif ("+a.arrays+") {  ",od.unindexedChars&&(b+="\n  if (isString(iterable)) {\n    iterable = iterable.split('')\n  }  "),b+="\n  while (++index < length) {\n    "+a.loop+"\n  }\n}\nelse {  "):od.nonEnumArgs&&(b+="\n  var length = iterable.length; index = -1;\n  if (length && isArguments(iterable)) {\n    while (++index < length) {\n      index += '';\n      "+a.loop+"\n    }\n  } else {  "),od.enumPrototypes&&(b+="\n  var skipProto = typeof iterable == 'function';\n  "),a.useHas&&a.useKeys)b+="\n  var ownIndex = -1,\n      ownProps = objectTypes[typeof iterable] ? keys(iterable) : [],\n      length = ownProps.length;\n\n  while (++ownIndex < length) {\n    index = ownProps[ownIndex];\n    ",od.enumPrototypes&&(b+="if (!(skipProto && index == 'prototype')) {\n  "),b+=a.loop,od.enumPrototypes&&(b+="}\n"),b+="  }  ";else if(b+="\n  for (index in iterable) {",(od.enumPrototypes||a.useHas)&&(b+="\n    if (",od.enumPrototypes&&(b+="!(skipProto && index == 'prototype')"),od.enumPrototypes&&a.useHas&&(b+=" && "),a.useHas&&(b+="hasOwnProperty.call(iterable, index)"),b+=") {    "),b+=a.loop+";    ",(od.enumPrototypes||a.useHas)&&(b+="\n    }"),b+="\n  }    ",od.nonEnumShadows){b+="\n\n  var ctor = iterable.constructor;\n      ";for(var c=0;7>c;c++)b+="\n  index = '"+a.shadowedProps[c]+"';\n  if (","constructor"==a.shadowedProps[c]&&(b+="!(ctor && ctor.prototype === iterable) && "),b+="hasOwnProperty.call(iterable, index)) {\n    "+a.loop+"\n  }      "}return(a.arrays||od.nonEnumArgs)&&(b+="\n}"),b+=a.bottom+";\nreturn result"},qd={args:"object, source, guard",top:"var args = arguments,\n    argsIndex = 0,\n    argsLength = typeof guard == 'number' ? 2 : args.length;\nwhile (++argsIndex < argsLength) {\n  iterable = args[argsIndex];\n  if (iterable && objectTypes[typeof iterable]) {",loop:"if (typeof result[index] == 'undefined') result[index] = iterable[index]",bottom:"  }\n}"},rd={args:"collection, callback, thisArg",top:"callback = callback && typeof thisArg == 'undefined' ? callback : lodash.createCallback(callback, thisArg)",arrays:"typeof length == 'number'",loop:"if (callback(iterable[index], index, collection) === false) return result"},sd={top:"if (!objectTypes[typeof iterable]) return result;\n"+rd.top,arrays:!1};R.prototype=e.prototype,od.argsClass||(W=function(a){return a?Zc.call(a,"callee"):!1});var td=dd||function(a){return od.argsObject&&a instanceof Gc||bd.call(a)==y},ud=N({args:"object",init:"[]",top:"if (!(objectTypes[typeof object])) return result",loop:"result.push(index)",arrays:!1}),vd=gd?function(a){return ib(a)?od.enumPrototypes&&"function"==typeof a||od.nonEnumArgs&&a.length&&W(a)?ud(a):gd(a):[]}:ud,wd=N(rd),xd={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"},yd=ab(xd),zd=N(qd,{top:qd.top.replace(";",";\nif (argsLength > 3 && typeof args[argsLength - 2] == 'function') {\n  var callback = lodash.createCallback(args[--argsLength - 1], args[argsLength--], 2);\n} else if (argsLength > 2 && typeof args[argsLength - 1] == 'function') {\n  callback = args[--argsLength];\n}"),loop:"result[index] = callback ? callback(result[index], iterable[index]) : iterable[index]"}),Ad=N(qd),Bd=N(rd,sd,{useHas:!1}),Cd=N(rd,sd);hb(/x/)&&(hb=function(a){return a instanceof Jc||bd.call(a)==B});var Dd=Yc?function(a){if(!a||bd.call(a)!=D||!od.argsClass&&W(a))return!1;var b=a.valueOf,c="function"==typeof b&&(c=Yc(b))&&Yc(c);return c?a==c||Yc(a)==c:T(a)}:T,Ed=Db,Fd=yb;md&&f&&"function"==typeof _c&&(lc=fc(_c,d));var Gd=8==jd("08")?jd:function(a,b){return jd(nb(a)?a.replace(q,""):a,b||0)};return e.after=ec,e.assign=zd,e.at=ub,e.bind=fc,e.bindAll=gc,e.bindKey=hc,e.compact=Ob,e.compose=ic,e.countBy=wb,e.createCallback=jc,e.debounce=kc,e.defaults=Ad,e.defer=lc,e.delay=mc,e.difference=Pb,e.filter=yb,e.flatten=Sb,e.forEach=Ab,e.forIn=Bd,e.forOwn=Cd,e.functions=$,e.groupBy=Bb,e.initial=Ub,e.intersection=Vb,e.invert=ab,e.invoke=Cb,e.keys=vd,e.map=Db,e.max=Eb,e.memoize=nc,e.merge=pb,e.min=Fb,e.omit=qb,e.once=oc,e.pairs=rb,e.partial=pc,e.partialRight=qc,e.pick=sb,e.pluck=Ed,e.range=Yb,e.reject=Ib,e.rest=Zb,e.shuffle=Jb,e.sortBy=Mb,e.tap=Dc,e.throttle=rc,e.times=Ac,e.toArray=Nb,e.union=_b,e.uniq=ac,e.values=tb,e.where=Fd,e.without=bc,e.wrap=sc,e.zip=cc,e.zipObject=dc,e.collect=Db,e.drop=Zb,e.each=Ab,e.extend=zd,e.methods=$,e.object=dc,e.select=yb,e.tail=Zb,e.unique=ac,vc(e),e.clone=X,e.cloneDeep=Y,e.contains=vb,e.escape=tc,e.every=xb,e.find=zb,e.findIndex=Qb,e.findKey=Z,e.has=_,e.identity=uc,e.indexOf=Tb,e.isArguments=W,e.isArray=td,e.isBoolean=bb,e.isDate=cb,e.isElement=db,e.isEmpty=eb,e.isEqual=fb,e.isFinite=gb,e.isFunction=hb,e.isNaN=jb,e.isNull=kb,e.isNumber=lb,e.isObject=ib,e.isPlainObject=Dd,e.isRegExp=mb,e.isString=nb,e.isUndefined=ob,e.lastIndexOf=Xb,e.mixin=vc,e.noConflict=wc,e.parseInt=Gd,e.random=xc,e.reduce=Gb,e.reduceRight=Hb,e.result=yc,e.runInContext=b,e.size=Kb,e.some=Lb,e.sortedIndex=$b,e.template=zc,e.unescape=Bc,e.uniqueId=Cc,e.all=xb,e.any=Lb,e.detect=zb,e.foldl=Gb,e.foldr=Hb,e.include=vb,e.inject=Gb,Cd(e,function(a,b){e.prototype[b]||(e.prototype[b]=function(){var b=[this.__wrapped__];return $c.apply(b,arguments),a.apply(e,b)})}),e.first=Rb,e.last=Wb,e.take=Rb,e.head=Rb,Cd(e,function(a,b){e.prototype[b]||(e.prototype[b]=function(b,c){var d=a(this.__wrapped__,b,c);return null==b||c&&"function"!=typeof b?d:new R(d)})}),e.VERSION="1.1.1",e.prototype.toString=Ec,e.prototype.value=Fc,e.prototype.valueOf=Fc,wd(["join","pop","shift"],function(a){var b=Qc[a];e.prototype[a]=function(){return b.apply(this.__wrapped__,arguments)}}),wd(["push","reverse","sort","unshift"],function(a){var b=Qc[a];e.prototype[a]=function(){return b.apply(this.__wrapped__,arguments),this}}),wd(["concat","slice","splice"],function(a){var b=Qc[a];e.prototype[a]=function(){return new R(b.apply(this.__wrapped__,arguments))}}),od.spliceObjects||wd(["pop","shift","splice"],function(a){var b=Qc[a],c="splice"==a;e.prototype[a]=function(){var a=this.__wrapped__,d=b.apply(a,arguments);return 0===a.length&&delete a[0],c?new R(d):d}}),e}var c,e="object"==typeof exports&&exports,f="object"==typeof module&&module&&module.exports==e&&module,g="object"==typeof global&&global;g.global===g&&(a=g);var h=0,i={},j=/\b__p \+= '';/g,k=/\b(__p \+=) '' \+/g,l=/(__e\(.*?\)|\b__t\)) \+\n'';/g,m=/&(?:amp|lt|gt|quot|#39);/g,n=/\$\{([^\\}]*(?:\\.[^\\}]*)*)\}/g,o=/\w*$/,p=/<%=([\s\S]+?)%>/g,q=/^0+(?=.$)/,r=/($^)/,s=/[&<>"']/g,t=/['\n\r\t\u2028\u2029\\]/g,u=["Array","Boolean","Date","Function","Math","Number","Object","RegExp","String","_","attachEvent","clearTimeout","isFinite","isNaN","parseInt","setImmediate","setTimeout"],v=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],w=0,x="[object Arguments]",y="[object Array]",z="[object Boolean]",A="[object Date]",B="[object Function]",C="[object Number]",D="[object Object]",E="[object RegExp]",F="[object String]",G={};G[B]=!1,G[x]=G[y]=G[z]=G[A]=G[C]=G[D]=G[E]=G[F]=!0;var H={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},I={"\\":"\\","'":"'","\n":"n","\r":"r","	":"t","\u2028":"u2028","\u2029":"u2029"},J=b();"function"==typeof d&&"object"==typeof d.amd&&d.amd?(a._=J,d("_",[],function(){return J})):e&&!e.nodeType?f?(f.exports=J)._=J:e._=J:a._=J}(this),d("core/Base",["require","./mixin/derive","./mixin/notifier","./Cache","_"],function(a){var b=a("./mixin/derive"),c=a("./mixin/notifier"),d=a("./Cache"),e=a("_"),f=function(){this.cache=new d};return e.extend(f,b),e.extend(f.prototype,c),f}),d("core/util",["require"],function(){var a=0;return{genGUID:function(){return++a},relative2absolute:function(a,b){if(!b||a.match(/^\//))return a;for(var c=a.split("/"),d=b.split("/"),e=c[0];"."===e||".."===e;)".."===e&&d.pop(),c.shift(),e=c[0];return d.join("/")+"/"+c.join("/")}}}),function(a){var b={};"undefined"==typeof exports?"function"==typeof d&&"object"==typeof d.amd&&d.amd?(b.exports={},d("glmatrix",[],function(){return b.exports})):b.exports="undefined"!=typeof window?window:a:b.exports=exports,function(a){if(!b)var b=1e-6;if(!c)var c="undefined"!=typeof Float32Array?Float32Array:Array;if(!d)var d=Math.random;var e={};e.setMatrixArrayType=function(a){c=a},"undefined"!=typeof a&&(a.glMatrix=e);var f={};f.create=function(){var a=new c(2);return a[0]=0,a[1]=0,a},f.clone=function(a){var b=new c(2);return b[0]=a[0],b[1]=a[1],b},f.fromValues=function(a,b){var d=new c(2);return d[0]=a,d[1]=b,d},f.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a},f.set=function(a,b,c){return a[0]=b,a[1]=c,a},f.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a
},f.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a},f.sub=f.subtract,f.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a},f.mul=f.multiply,f.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a},f.div=f.divide,f.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a},f.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a},f.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a},f.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a},f.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},f.dist=f.distance,f.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return c*c+d*d},f.sqrDist=f.squaredDistance,f.length=function(a){var b=a[0],c=a[1];return Math.sqrt(b*b+c*c)},f.len=f.length,f.squaredLength=function(a){var b=a[0],c=a[1];return b*b+c*c},f.sqrLen=f.squaredLength,f.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a},f.normalize=function(a,b){var c=b[0],d=b[1],e=c*c+d*d;return e>0&&(e=1/Math.sqrt(e),a[0]=b[0]*e,a[1]=b[1]*e),a},f.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]},f.cross=function(a,b,c){var d=b[0]*c[1]-b[1]*c[0];return a[0]=a[1]=0,a[2]=d,a},f.lerp=function(a,b,c,d){var e=b[0],f=b[1];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a},f.random=function(a,b){b=b||1;var c=2*d()*Math.PI;return a[0]=Math.cos(c)*b,a[1]=Math.sin(c)*b,a},f.transformMat2=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e,a[1]=c[1]*d+c[3]*e,a},f.transformMat2d=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e+c[4],a[1]=c[1]*d+c[3]*e+c[5],a},f.transformMat3=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[3]*e+c[6],a[1]=c[1]*d+c[4]*e+c[7],a},f.transformMat4=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[4]*e+c[12],a[1]=c[1]*d+c[5]*e+c[13],a},f.forEach=function(){var a=f.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=2),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;i>h;h+=c)a[0]=b[h],a[1]=b[h+1],f(a,a,g),b[h]=a[0],b[h+1]=a[1];return b}}(),f.str=function(a){return"vec2("+a[0]+", "+a[1]+")"},"undefined"!=typeof a&&(a.vec2=f);var g={};g.create=function(){var a=new c(3);return a[0]=0,a[1]=0,a[2]=0,a},g.clone=function(a){var b=new c(3);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b},g.fromValues=function(a,b,d){var e=new c(3);return e[0]=a,e[1]=b,e[2]=d,e},g.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a},g.set=function(a,b,c,d){return a[0]=b,a[1]=c,a[2]=d,a},g.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a},g.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a},g.sub=g.subtract,g.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a},g.mul=g.multiply,g.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a},g.div=g.divide,g.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a},g.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a},g.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a},g.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a},g.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)},g.dist=g.distance,g.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return c*c+d*d+e*e},g.sqrDist=g.squaredDistance,g.length=function(a){var b=a[0],c=a[1],d=a[2];return Math.sqrt(b*b+c*c+d*d)},g.len=g.length,g.squaredLength=function(a){var b=a[0],c=a[1],d=a[2];return b*b+c*c+d*d},g.sqrLen=g.squaredLength,g.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a},g.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=c*c+d*d+e*e;return f>0&&(f=1/Math.sqrt(f),a[0]=b[0]*f,a[1]=b[1]*f,a[2]=b[2]*f),a},g.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},g.cross=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2];return a[0]=e*i-f*h,a[1]=f*g-d*i,a[2]=d*h-e*g,a},g.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a},g.random=function(a,b){b=b||1;var c=2*d()*Math.PI,e=2*d()-1,f=Math.sqrt(1-e*e)*b;return a[0]=Math.cos(c)*f,a[1]=Math.sin(c)*f,a[2]=e*b,a},g.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12],a[1]=c[1]*d+c[5]*e+c[9]*f+c[13],a[2]=c[2]*d+c[6]*e+c[10]*f+c[14],a},g.transformMat3=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=d*c[0]+e*c[3]+f*c[6],a[1]=d*c[1]+e*c[4]+f*c[7],a[2]=d*c[2]+e*c[5]+f*c[8],a},g.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},g.forEach=function(){var a=g.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=3),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;i>h;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2];return b}}(),g.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"},"undefined"!=typeof a&&(a.vec3=g);var h={};h.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a},h.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},h.fromValues=function(a,b,d,e){var f=new c(4);return f[0]=a,f[1]=b,f[2]=d,f[3]=e,f},h.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},h.set=function(a,b,c,d,e){return a[0]=b,a[1]=c,a[2]=d,a[3]=e,a},h.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a[3]=b[3]+c[3],a},h.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a[3]=b[3]-c[3],a},h.sub=h.subtract,h.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a[3]=b[3]*c[3],a},h.mul=h.multiply,h.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a[3]=b[3]/c[3],a},h.div=h.divide,h.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a[3]=Math.min(b[3],c[3]),a},h.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a[3]=Math.max(b[3],c[3]),a},h.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a[3]=b[3]*c,a},h.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a[3]=b[3]+c[3]*d,a},h.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return Math.sqrt(c*c+d*d+e*e+f*f)},h.dist=h.distance,h.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return c*c+d*d+e*e+f*f},h.sqrDist=h.squaredDistance,h.length=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return Math.sqrt(b*b+c*c+d*d+e*e)},h.len=h.length,h.squaredLength=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return b*b+c*c+d*d+e*e},h.sqrLen=h.squaredLength,h.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=-b[3],a},h.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f;return g>0&&(g=1/Math.sqrt(g),a[0]=b[0]*g,a[1]=b[1]*g,a[2]=b[2]*g,a[3]=b[3]*g),a},h.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},h.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2],h=b[3];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a[3]=h+d*(c[3]-h),a},h.random=function(a,b){return b=b||1,a[0]=d(),a[1]=d(),a[2]=d(),a[3]=d(),h.normalize(a,a),h.scale(a,a,b),a},h.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12]*g,a[1]=c[1]*d+c[5]*e+c[9]*f+c[13]*g,a[2]=c[2]*d+c[6]*e+c[10]*f+c[14]*g,a[3]=c[3]*d+c[7]*e+c[11]*f+c[15]*g,a},h.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},h.forEach=function(){var a=h.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=4),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;i>h;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],a[3]=b[h+3],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2],b[h+3]=a[3];return b}}(),h.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},"undefined"!=typeof a&&(a.vec4=h);var i={};i.create=function(){var a=new c(4);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},i.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},i.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},i.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},i.transpose=function(a,b){if(a===b){var c=b[1];a[1]=b[2],a[2]=c}else a[0]=b[0],a[1]=b[2],a[2]=b[1],a[3]=b[3];return a},i.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*f-e*d;return g?(g=1/g,a[0]=f*g,a[1]=-d*g,a[2]=-e*g,a[3]=c*g,a):null},i.adjoint=function(a,b){var c=b[0];return a[0]=b[3],a[1]=-b[1],a[2]=-b[2],a[3]=c,a},i.determinant=function(a){return a[0]*a[3]-a[2]*a[1]},i.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*h+e*j,a[1]=d*i+e*k,a[2]=f*h+g*j,a[3]=f*i+g*k,a},i.mul=i.multiply,i.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+e*h,a[1]=d*-h+e*i,a[2]=f*i+g*h,a[3]=f*-h+g*i,a},i.scale=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1];return a[0]=d*h,a[1]=e*i,a[2]=f*h,a[3]=g*i,a},i.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},"undefined"!=typeof a&&(a.mat2=i);var j={};j.create=function(){var a=new c(6);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},j.clone=function(a){var b=new c(6);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b},j.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a},j.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},j.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=c*f-d*e;return i?(i=1/i,a[0]=f*i,a[1]=-d*i,a[2]=-e*i,a[3]=c*i,a[4]=(e*h-f*g)*i,a[5]=(d*g-c*h)*i,a):null},j.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},j.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=c[0],k=c[1],l=c[2],m=c[3],n=c[4],o=c[5];return a[0]=d*j+e*l,a[1]=d*k+e*m,a[2]=f*j+g*l,a[3]=f*k+g*m,a[4]=j*h+l*i+n,a[5]=k*h+m*i+o,a},j.mul=j.multiply,j.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=Math.sin(c),k=Math.cos(c);return a[0]=d*k+e*j,a[1]=-d*j+e*k,a[2]=f*k+g*j,a[3]=-f*j+k*g,a[4]=k*h+j*i,a[5]=k*i-j*h,a},j.scale=function(a,b,c){var d=c[0],e=c[1];return a[0]=b[0]*d,a[1]=b[1]*e,a[2]=b[2]*d,a[3]=b[3]*e,a[4]=b[4]*d,a[5]=b[5]*e,a},j.translate=function(a,b,c){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4]+c[0],a[5]=b[5]+c[1],a},j.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"},"undefined"!=typeof a&&(a.mat2d=j);var k={};k.create=function(){var a=new c(9);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},k.fromMat4=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[4],a[4]=b[5],a[5]=b[6],a[6]=b[8],a[7]=b[9],a[8]=b[10],a},k.clone=function(a){var b=new c(9);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b},k.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},k.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},k.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[5];a[1]=b[3],a[2]=b[6],a[3]=c,a[5]=b[7],a[6]=d,a[7]=e}else a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8];return a},k.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=k*g-h*j,m=-k*f+h*i,n=j*f-g*i,o=c*l+d*m+e*n;return o?(o=1/o,a[0]=l*o,a[1]=(-k*d+e*j)*o,a[2]=(h*d-e*g)*o,a[3]=m*o,a[4]=(k*c-e*i)*o,a[5]=(-h*c+e*f)*o,a[6]=n*o,a[7]=(-j*c+d*i)*o,a[8]=(g*c-d*f)*o,a):null},k.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8];return a[0]=g*k-h*j,a[1]=e*j-d*k,a[2]=d*h-e*g,a[3]=h*i-f*k,a[4]=c*k-e*i,a[5]=e*f-c*h,a[6]=f*j-g*i,a[7]=d*i-c*j,a[8]=c*g-d*f,a},k.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8];return b*(j*f-g*i)+c*(-j*e+g*h)+d*(i*e-f*h)},k.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1],o=c[2],p=c[3],q=c[4],r=c[5],s=c[6],t=c[7],u=c[8];return a[0]=m*d+n*g+o*j,a[1]=m*e+n*h+o*k,a[2]=m*f+n*i+o*l,a[3]=p*d+q*g+r*j,a[4]=p*e+q*h+r*k,a[5]=p*f+q*i+r*l,a[6]=s*d+t*g+u*j,a[7]=s*e+t*h+u*k,a[8]=s*f+t*i+u*l,a},k.mul=k.multiply,k.translate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1];return a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=m*d+n*g+j,a[7]=m*e+n*h+k,a[8]=m*f+n*i+l,a},k.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=Math.sin(c),n=Math.cos(c);return a[0]=n*d+m*g,a[1]=n*e+m*h,a[2]=n*f+m*i,a[3]=n*g-m*d,a[4]=n*h-m*e,a[5]=n*i-m*f,a[6]=j,a[7]=k,a[8]=l,a},k.scale=function(a,b,c){var d=c[0],e=c[1];return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=e*b[3],a[4]=e*b[4],a[5]=e*b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},k.fromMat2d=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=0,a[3]=b[2],a[4]=b[3],a[5]=0,a[6]=b[4],a[7]=b[5],a[8]=1,a},k.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-(m+o),a[3]=k+r,a[6]=l-q,a[1]=k-r,a[4]=1-(j+o),a[7]=n+p,a[2]=l+q,a[5]=n-p,a[8]=1-(j+m),a},k.normalFromMat4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(i*A-g*D-j*z)*E,a[2]=(g*C-h*A+j*y)*E,a[3]=(e*C-d*D-f*B)*E,a[4]=(c*D-e*A+f*z)*E,a[5]=(d*A-c*C-f*y)*E,a[6]=(p*x-q*w+r*v)*E,a[7]=(q*u-o*x-r*t)*E,a[8]=(o*w-p*u+r*s)*E,a):null},k.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"},"undefined"!=typeof a&&(a.mat3=k);var l={};l.create=function(){var a=new c(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.clone=function(a){var b=new c(16);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},l.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},l.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[3],f=b[6],g=b[7],h=b[11];a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=c,a[6]=b[9],a[7]=b[13],a[8]=d,a[9]=f,a[11]=b[14],a[12]=e,a[13]=g,a[14]=h}else a[0]=b[0],a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=b[1],a[5]=b[5],a[6]=b[9],a[7]=b[13],a[8]=b[2],a[9]=b[6],a[10]=b[10],a[11]=b[14],a[12]=b[3],a[13]=b[7],a[14]=b[11],a[15]=b[15];return a},l.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(e*C-d*D-f*B)*E,a[2]=(p*x-q*w+r*v)*E,a[3]=(m*w-l*x-n*v)*E,a[4]=(i*A-g*D-j*z)*E,a[5]=(c*D-e*A+f*z)*E,a[6]=(q*u-o*x-r*t)*E,a[7]=(k*x-m*u+n*t)*E,a[8]=(g*C-h*A+j*y)*E,a[9]=(d*A-c*C-f*y)*E,a[10]=(o*w-p*u+r*s)*E,a[11]=(l*u-k*w-n*s)*E,a[12]=(h*z-g*B-i*y)*E,a[13]=(c*B-d*z+e*y)*E,a[14]=(p*t-o*v-q*s)*E,a[15]=(k*v-l*t+m*s)*E,a):null},l.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15];return a[0]=h*(m*r-n*q)-l*(i*r-j*q)+p*(i*n-j*m),a[1]=-(d*(m*r-n*q)-l*(e*r-f*q)+p*(e*n-f*m)),a[2]=d*(i*r-j*q)-h*(e*r-f*q)+p*(e*j-f*i),a[3]=-(d*(i*n-j*m)-h*(e*n-f*m)+l*(e*j-f*i)),a[4]=-(g*(m*r-n*q)-k*(i*r-j*q)+o*(i*n-j*m)),a[5]=c*(m*r-n*q)-k*(e*r-f*q)+o*(e*n-f*m),a[6]=-(c*(i*r-j*q)-g*(e*r-f*q)+o*(e*j-f*i)),a[7]=c*(i*n-j*m)-g*(e*n-f*m)+k*(e*j-f*i),a[8]=g*(l*r-n*p)-k*(h*r-j*p)+o*(h*n-j*l),a[9]=-(c*(l*r-n*p)-k*(d*r-f*p)+o*(d*n-f*l)),a[10]=c*(h*r-j*p)-g*(d*r-f*p)+o*(d*j-f*h),a[11]=-(c*(h*n-j*l)-g*(d*n-f*l)+k*(d*j-f*h)),a[12]=-(g*(l*q-m*p)-k*(h*q-i*p)+o*(h*m-i*l)),a[13]=c*(l*q-m*p)-k*(d*q-e*p)+o*(d*m-e*l),a[14]=-(c*(h*q-i*p)-g*(d*q-e*p)+o*(d*i-e*h)),a[15]=c*(h*m-i*l)-g*(d*m-e*l)+k*(d*i-e*h),a},l.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15],r=b*g-c*f,s=b*h-d*f,t=b*i-e*f,u=c*h-d*g,v=c*i-e*g,w=d*i-e*h,x=j*o-k*n,y=j*p-l*n,z=j*q-m*n,A=k*p-l*o,B=k*q-m*o,C=l*q-m*p;return r*C-s*B+t*A+u*z-v*y+w*x},l.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c[0],u=c[1],v=c[2],w=c[3];return a[0]=t*d+u*h+v*l+w*p,a[1]=t*e+u*i+v*m+w*q,a[2]=t*f+u*j+v*n+w*r,a[3]=t*g+u*k+v*o+w*s,t=c[4],u=c[5],v=c[6],w=c[7],a[4]=t*d+u*h+v*l+w*p,a[5]=t*e+u*i+v*m+w*q,a[6]=t*f+u*j+v*n+w*r,a[7]=t*g+u*k+v*o+w*s,t=c[8],u=c[9],v=c[10],w=c[11],a[8]=t*d+u*h+v*l+w*p,a[9]=t*e+u*i+v*m+w*q,a[10]=t*f+u*j+v*n+w*r,a[11]=t*g+u*k+v*o+w*s,t=c[12],u=c[13],v=c[14],w=c[15],a[12]=t*d+u*h+v*l+w*p,a[13]=t*e+u*i+v*m+w*q,a[14]=t*f+u*j+v*n+w*r,a[15]=t*g+u*k+v*o+w*s,a},l.mul=l.multiply,l.translate=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p=c[0],q=c[1],r=c[2];return b===a?(a[12]=b[0]*p+b[4]*q+b[8]*r+b[12],a[13]=b[1]*p+b[5]*q+b[9]*r+b[13],a[14]=b[2]*p+b[6]*q+b[10]*r+b[14],a[15]=b[3]*p+b[7]*q+b[11]*r+b[15]):(d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=j,a[7]=k,a[8]=l,a[9]=m,a[10]=n,a[11]=o,a[12]=d*p+h*q+l*r+b[12],a[13]=e*p+i*q+m*r+b[13],a[14]=f*p+j*q+n*r+b[14],a[15]=g*p+k*q+o*r+b[15]),a},l.scale=function(a,b,c){var d=c[0],e=c[1],f=c[2];return a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a[3]=b[3]*d,a[4]=b[4]*e,a[5]=b[5]*e,a[6]=b[6]*e,a[7]=b[7]*e,a[8]=b[8]*f,a[9]=b[9]*f,a[10]=b[10]*f,a[11]=b[11]*f,a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},l.rotate=function(a,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=e[0],E=e[1],F=e[2],G=Math.sqrt(D*D+E*E+F*F);return Math.abs(G)<b?null:(G=1/G,D*=G,E*=G,F*=G,f=Math.sin(d),g=Math.cos(d),h=1-g,i=c[0],j=c[1],k=c[2],l=c[3],m=c[4],n=c[5],o=c[6],p=c[7],q=c[8],r=c[9],s=c[10],t=c[11],u=D*D*h+g,v=E*D*h+F*f,w=F*D*h-E*f,x=D*E*h-F*f,y=E*E*h+g,z=F*E*h+D*f,A=D*F*h+E*f,B=E*F*h-D*f,C=F*F*h+g,a[0]=i*u+m*v+q*w,a[1]=j*u+n*v+r*w,a[2]=k*u+o*v+s*w,a[3]=l*u+p*v+t*w,a[4]=i*x+m*y+q*z,a[5]=j*x+n*y+r*z,a[6]=k*x+o*y+s*z,a[7]=l*x+p*y+t*z,a[8]=i*A+m*B+q*C,a[9]=j*A+n*B+r*C,a[10]=k*A+o*B+s*C,a[11]=l*A+p*B+t*C,c!==a&&(a[12]=c[12],a[13]=c[13],a[14]=c[14],a[15]=c[15]),a)},l.rotateX=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[4],g=b[5],h=b[6],i=b[7],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[4]=f*e+j*d,a[5]=g*e+k*d,a[6]=h*e+l*d,a[7]=i*e+m*d,a[8]=j*e-f*d,a[9]=k*e-g*d,a[10]=l*e-h*d,a[11]=m*e-i*d,a},l.rotateY=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e-j*d,a[1]=g*e-k*d,a[2]=h*e-l*d,a[3]=i*e-m*d,a[8]=f*d+j*e,a[9]=g*d+k*e,a[10]=h*d+l*e,a[11]=i*d+m*e,a},l.rotateZ=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[4],k=b[5],l=b[6],m=b[7];return b!==a&&(a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e+j*d,a[1]=g*e+k*d,a[2]=h*e+l*d,a[3]=i*e+m*d,a[4]=j*e-f*d,a[5]=k*e-g*d,a[6]=l*e-h*d,a[7]=m*e-i*d,a},l.fromRotationTranslation=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=d+d,i=e+e,j=f+f,k=d*h,l=d*i,m=d*j,n=e*i,o=e*j,p=f*j,q=g*h,r=g*i,s=g*j;return a[0]=1-(n+p),a[1]=l+s,a[2]=m-r,a[3]=0,a[4]=l-s,a[5]=1-(k+p),a[6]=o+q,a[7]=0,a[8]=m+r,a[9]=o-q,a[10]=1-(k+n),a[11]=0,a[12]=c[0],a[13]=c[1],a[14]=c[2],a[15]=1,a},l.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-(m+o),a[1]=k+r,a[2]=l-q,a[3]=0,a[4]=k-r,a[5]=1-(j+o),a[6]=n+p,a[7]=0,a[8]=l+q,a[9]=n-p,a[10]=1-(j+m),a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.frustum=function(a,b,c,d,e,f,g){var h=1/(c-b),i=1/(e-d),j=1/(f-g);return a[0]=2*f*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*f*i,a[6]=0,a[7]=0,a[8]=(c+b)*h,a[9]=(e+d)*i,a[10]=(g+f)*j,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*g*f*j,a[15]=0,a},l.perspective=function(a,b,c,d,e){var f=1/Math.tan(b/2),g=1/(d-e);return a[0]=f/c,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(e+d)*g,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*e*d*g,a[15]=0,a},l.ortho=function(a,b,c,d,e,f,g){var h=1/(b-c),i=1/(d-e),j=1/(f-g);return a[0]=-2*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*i,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*j,a[11]=0,a[12]=(b+c)*h,a[13]=(e+d)*i,a[14]=(g+f)*j,a[15]=1,a},l.lookAt=function(a,c,d,e){var f,g,h,i,j,k,m,n,o,p,q=c[0],r=c[1],s=c[2],t=e[0],u=e[1],v=e[2],w=d[0],x=d[1],y=d[2];return Math.abs(q-w)<b&&Math.abs(r-x)<b&&Math.abs(s-y)<b?l.identity(a):(m=q-w,n=r-x,o=s-y,p=1/Math.sqrt(m*m+n*n+o*o),m*=p,n*=p,o*=p,f=u*o-v*n,g=v*m-t*o,h=t*n-u*m,p=Math.sqrt(f*f+g*g+h*h),p?(p=1/p,f*=p,g*=p,h*=p):(f=0,g=0,h=0),i=n*h-o*g,j=o*f-m*h,k=m*g-n*f,p=Math.sqrt(i*i+j*j+k*k),p?(p=1/p,i*=p,j*=p,k*=p):(i=0,j=0,k=0),a[0]=f,a[1]=i,a[2]=m,a[3]=0,a[4]=g,a[5]=j,a[6]=n,a[7]=0,a[8]=h,a[9]=k,a[10]=o,a[11]=0,a[12]=-(f*q+g*r+h*s),a[13]=-(i*q+j*r+k*s),a[14]=-(m*q+n*r+o*s),a[15]=1,a)},l.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"},"undefined"!=typeof a&&(a.mat4=l);var m={};m.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},m.rotationTo=function(){var a=g.create(),b=g.fromValues(1,0,0),c=g.fromValues(0,1,0);return function(d,e,f){var h=g.dot(e,f);return-.999999>h?(g.cross(a,b,e),g.length(a)<1e-6&&g.cross(a,c,e),g.normalize(a,a),m.setAxisAngle(d,a,Math.PI),d):h>.999999?(d[0]=0,d[1]=0,d[2]=0,d[3]=1,d):(g.cross(a,e,f),d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=1+h,m.normalize(d,d))}}(),m.setAxes=function(){var a=k.create();return function(b,c,d,e){return a[0]=d[0],a[3]=d[1],a[6]=d[2],a[1]=e[0],a[4]=e[1],a[7]=e[2],a[2]=c[0],a[5]=c[1],a[8]=c[2],m.normalize(b,m.fromMat3(b,a))}}(),m.clone=h.clone,m.fromValues=h.fromValues,m.copy=h.copy,m.set=h.set,m.identity=function(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},m.setAxisAngle=function(a,b,c){c=.5*c;var d=Math.sin(c);return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=Math.cos(c),a},m.add=h.add,m.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*k+g*h+e*j-f*i,a[1]=e*k+g*i+f*h-d*j,a[2]=f*k+g*j+d*i-e*h,a[3]=g*k-d*h-e*i-f*j,a},m.mul=m.multiply,m.scale=h.scale,m.rotateX=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+g*h,a[1]=e*i+f*h,a[2]=f*i-e*h,a[3]=g*i-d*h,a},m.rotateY=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i-f*h,a[1]=e*i+g*h,a[2]=f*i+d*h,a[3]=g*i-e*h,a},m.rotateZ=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+e*h,a[1]=e*i-d*h,a[2]=f*i+g*h,a[3]=g*i-f*h,a},m.calculateW=function(a,b){var c=b[0],d=b[1],e=b[2];return a[0]=c,a[1]=d,a[2]=e,a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a},m.dot=h.dot,m.lerp=h.lerp,m.slerp=function(a,b,c,d){var e,f,g,h,i,j=b[0],k=b[1],l=b[2],m=b[3],n=c[0],o=c[1],p=c[2],q=c[3];return f=j*n+k*o+l*p+m*q,0>f&&(f=-f,n=-n,o=-o,p=-p,q=-q),1-f>1e-6?(e=Math.acos(f),g=Math.sin(e),h=Math.sin((1-d)*e)/g,i=Math.sin(d*e)/g):(h=1-d,i=d),a[0]=h*j+i*n,a[1]=h*k+i*o,a[2]=h*l+i*p,a[3]=h*m+i*q,a},m.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f,h=g?1/g:0;return a[0]=-c*h,a[1]=-d*h,a[2]=-e*h,a[3]=f*h,a},m.conjugate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=b[3],a},m.length=h.length,m.len=m.length,m.squaredLength=h.squaredLength,m.sqrLen=m.squaredLength,m.normalize=h.normalize,m.fromMat3=function(){var a="undefined"!=typeof Int8Array?new Int8Array([1,2,0]):[1,2,0];return function(b,c){var d,e=c[0]+c[4]+c[8];if(e>0)d=Math.sqrt(e+1),b[3]=.5*d,d=.5/d,b[0]=(c[7]-c[5])*d,b[1]=(c[2]-c[6])*d,b[2]=(c[3]-c[1])*d;else{var f=0;c[4]>c[0]&&(f=1),c[8]>c[3*f+f]&&(f=2);var g=a[f],h=a[g];d=Math.sqrt(c[3*f+f]-c[3*g+g]-c[3*h+h]+1),b[f]=.5*d,d=.5/d,b[3]=(c[3*h+g]-c[3*g+h])*d,b[g]=(c[3*g+f]+c[3*f+g])*d,b[h]=(c[3*h+f]+c[3*f+h])*d}return b}}(),m.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},"undefined"!=typeof a&&(a.quat=m)}(b.exports)}(this),d("math/Vector2",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.vec2,d=function(a,b){a=a||0,b=b||0,this._array=c.fromValues(a,b),this._dirty=!0};return d.prototype={constructor:d,get x(){return this._array[0]},set x(a){this._array[0]=a,this._dirty=!0},get y(){return this._array[1]},set y(a){this._array[1]=a,this._dirty=!0},add:function(a){return c.add(this._array,this._array,a._array),this._dirty=!0,this},set:function(a,b){return this._array[0]=a,this._array[1]=b,this._dirty=!0,this},clone:function(){return new d(this.x,this.y)},copy:function(a){return c.copy(this._array,a._array),this._dirty=!0,this},cross:function(a,b){return c.cross(a._array,this._array,b._array),this},dist:function(a){return c.dist(this._array,a._array)},distance:function(a){return c.distance(this._array,a._array)},div:function(a){return c.div(this._array,this._array,a._array),this._dirty=!0,this},divide:function(a){return c.divide(this._array,this._array,a._array),this._dirty=!0,this},dot:function(a){return c.dot(this._array,a._array)},len:function(){return c.len(this._array)},length:function(){return c.length(this._array)},lerp:function(a,b,d){return c.lerp(this._array,a._array,b._array,d),this._dirty=!0,this},min:function(a){return c.min(this._array,this._array,a._array),this._dirty=!0,this},max:function(a){return c.max(this._array,this._array,a._array),this._dirty=!0,this},mul:function(a){return c.mul(this._array,this._array,a._array),this._dirty=!0,this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this._dirty=!0,this},negate:function(){return c.negate(this._array,this._array),this._dirty=!0,this},normalize:function(){return c.normalize(this._array,this._array),this._dirty=!0,this},random:function(a){return c.random(this._array,a),this._dirty=!0,this},scale:function(a){return c.scale(this._array,this._array,a),this._dirty=!0,this},scaleAndAdd:function(a,b){return c.scaleAndAdd(this._array,this._array,a._array,b),this._dirty=!0,this},sqrDist:function(a){return c.sqrDist(this._array,a._array)},squaredDistance:function(a){return c.squaredDistance(this._array,a._array)},sqrLen:function(){return c.sqrLen(this._array)},squaredLength:function(){return c.squaredLength(this._array)},sub:function(a){return c.sub(this._array,this._array,a._array),this._dirty=!0,this},subtract:function(a){return c.subtract(this._array,this._array,a._array),this._dirty=!0,this},transformMat2:function(a){return c.transformMat2(this._array,this._array,a._array),this._dirty=!0,this},transformMat2d:function(a){return c.transformMat2d(this._array,this._array,a._array),this._dirty=!0,this},transformMat3:function(a){return c.transformMat3(this._array,this._array,a._array),this._dirty=!0,this},transformMat4:function(a){return c.transformMat4(this._array,this._array,a._array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}},d}),d("math/Matrix2d",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.mat2d,d=function(){this._array=c.create()};return d.prototype={constructor:d,clone:function(){return(new d).copy(this)},copy:function(a){return c.copy(this._array,a._array),this},determinant:function(){return c.determinant(this._array)},identity:function(){return c.identity(this._array),this},invert:function(){return c.invert(this._array,this._array),this},mul:function(a){return c.mul(this._array,this._array,a._array),this},mulLeft:function(a){return c.mul(this._array,a._array,this._array),this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this},multiplyLeft:function(a){return c.multiply(this._array,a._array,this._array),this},rotate:function(a){return c.rotate(this._array,this._array,a),this},scale:function(a){c.scale(this._array,this._array,a._array)},translate:function(a){c.translate(this._array,this._array,a._array)},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}},d}),d("2d/Style",["require","../core/Base","_"],function(a){function b(a){return(a||"").replace(/^(\s|\u00A0)+|(\s|\u00A0)+$/g,"")}var c=a("../core/Base");a("_");var d=/([0-9\-]+)\s+([0-9\-]+)\s+([0-9]+)\s+(.+)/,e=c.derive({},{bind:function(a){var c=this.fillStyle||this.fill,e=this.strokeStyle||this.stroke,f=this.globalAlpha||this.alpha,g=this.globalCompositeOperation||this.composite;if(this.shadow){var h=d.exec(b(this.shadow));if(h)var i=parseInt(h[1]),j=parseInt(h[2]),k=h[3],l=h[4]}i=this.shadowOffsetX||i,j=this.shadowOffsetY||j,k=this.shadowBlur||k,l=this.shadowColor||l,void 0!==f&&(a.globalAlpha=f),g&&(a.globalCompositeOperation=g),void 0!==this.lineWidth&&(a.lineWidth=this.lineWidth),void 0!==this.lineCap&&(a.lineCap=this.lineCap),void 0!==this.lineJoin&&(a.lineJoin=this.lineJoin),void 0!==this.miterLimit&&(a.miterLimit=this.miterLimit),void 0!==i&&(a.shadowOffsetX=i),void 0!==j&&(a.shadowOffsetY=j),void 0!==k&&(a.shadowBlur=k),void 0!==l&&(a.shadowColor=l),this.font&&(a.font=this.font),this.textAlign&&(a.textAlign=this.textAlign),this.textBaseline&&(a.textBaseline=this.textBaseline),c&&(a.fillStyle=c.getInstance?c.getInstance(a):c),e&&(a.strokeStyle=e.getInstance?e.getInstance(a):e),this.lineDash&&(a.setLineDash?(a.setLineDash(this.lineDash),"number"==typeof this.lineDashOffset&&(a.lineDashOffset=this.lineDashOffset)):console.warn("Browser does not support setLineDash method"))}});return e}),d("2d/Node",["require","../core/Base","../core/util","../math/Vector2","../math/Matrix2d","./Style","glmatrix"],function(a){function b(a,b){return a.z===b.z?a.__GUID__>b.__GUID__?1:-1:a.z>b.z?1:-1}var c=a("../core/Base"),d=a("../core/util"),e=a("../math/Vector2"),f=a("../math/Matrix2d");a("./Style");var g=a("glmatrix"),h=g.mat2d;g.vec2;var i=c.derive(function(){return{__GUID__:d.genGUID(),name:"",boundingBox:{min:new e,max:new e},z:0,style:null,position:new e(0,0),rotation:0,scale:new e(1,1),autoUpdate:!0,transform:new f,transformInverse:new f,_prevRotation:0,visible:!0,_children:[],intersectLineWidth:0,clip:!1,fill:!0,stroke:!1,enablePicking:!0}},{updateTransform:function(){var a=this.transform._array;this.autoUpdate&&(this.scale._dirty||this.position._dirty||this.rotation!==this._prevRotation)&&(h.identity(a,a),h.scale(a,a,this.scale._array),h.rotate(a,a,this.rotation),h.translate(a,a,this.position._array),this._prevRotation=this.rotation,this.scale._dirty=!1,this.position._dirty=!1)},updateTransformInverse:function(){h.invert(this.transformInverse._array,this.transform._array)},intersectBoundingBox:function(a,b){var c=this.boundingBox;return c.min.x<a&&a<c.max.x&&c.min.y<b&&b<c.max.y},add:function(a){a&&(this._children.push(a),a.parent&&a.parent.remove(a),a.parent=this)},remove:function(a){a&&(this._children.splice(this._children.indexOf(a),1),a.parent=null)},children:function(){return this._children.slice()},childAt:function(a){return this._children[a]
},draw:null,render:function(a){this.trigger("beforerender",a);var b=this.getSortedRenderQueue();if(this.style)if(!this.style instanceof Array)for(var c=0;c<this.style.length;c++)this.style[c].bind(a);else this.style.bind&&this.style.bind(a);a.save(),this.updateTransform();var d=this.transform._array;a.transform(d[0],d[1],d[2],d[3],d[4],d[5]),this.draw&&(this.trigger("beforedraw",a),this.draw(a),this.trigger("afterdraw",a)),this.clip&&a.clip();for(var c=0;c<b.length;c++)b[c].render(a);a.restore(),this.trigger("afterrender",a)},traverse:function(a){var b=a&&a(this);if(!b)for(var c=this._children,d=0,e=c.length;e>d;d++)c[d].traverse(a)},intersect:function(){},getSortedRenderQueue:function(){var a=this._children.slice();return a.sort(b),a}});return i}),d("2d/Camera",["require","./Node","../math/Matrix2d","glmatrix"],function(a){var b=a("./Node");a("../math/Matrix2d");var c=a("glmatrix");c.mat2d;var d=b.derive(function(){return{}},{getViewMatrix:function(){return this.updateTransform(),this.updateTransformInverse(),this.transformInverse}});return d}),d("2d/CanvasRenderer",["require","../core/Base"],function(a){var b=a("../core/Base"),c=b.derive(function(){return{canvas:null,ctx:null,width:0,height:0}},function(){this.canvas||(this.canvas=document.createElement("canvas")),this.width?this.canvas.width=this.width:this.width=this.canvas.width,this.height?this.canvas.height=this.height:this.height=this.canvas.height,this.canvas.style.zIndex=this.z,this.ctx=this.canvas.getContext("2d"),this.ctx.__GUID__=this.__GUID__},{resize:function(a,b){this.canvas.width=a,this.canvas.height=b,this.width=a,this.height=b},render:function(a,b){if(this.clearColor?(this.ctx.fillStyle=this.clearColor,this.ctx.fillRect(0,0,this.width,this.height)):this.ctx.clearRect(0,0,this.width,this.height),b){var c=b.getViewMatrix()._array;this.ctx.transform(c[0],c[1],c[2],c[3],c[4],c[5])}a.render(this.ctx)}});return c}),d("2d/Gradient",["require","../core/Base","../math/Vector2"],function(a){var b=a("../core/Base");a("../math/Vector2");var c=b.derive(function(){return{stops:[]}},{addColorStop:function(a,b){this.stops.push([a,b]),this.dirty()},removeAt:function(a){this.stops.splice(a,1),this.dirty()},dirty:function(){for(var a in this.cache._caches)this.cache._caches[a].dirty=!0},getInstance:function(a){return this.cache.use(a.__GUID__),(this.cache.get("dirty")||this.cache.miss("gradient"))&&this.update(a),this.cache.get("gradient")},update:function(){}});return c}),d("2d/LinearGradient",["require","./Gradient","../math/Vector2"],function(a){var b=a("./Gradient"),c=a("../math/Vector2"),d=b.derive(function(){return{start:new c,end:new c(100,0)}},{update:function(a){for(var b=a.createLinearGradient(this.start.x,this.start.y,this.end.x,this.end.y),c=0;c<this.stops.length;c++){var d=this.stops[c];b.addColorStop(d[0],d[1])}this.cache.put("gradient",b)}});return d}),d("2d/Pattern",["require","../core/Base","../math/Vector2"],function(a){var b=a("../core/Base");a("../math/Vector2");var c=b.derive(function(){return{image:null,repetition:"repeat"}},{getInstance:function(a){if(this.cache.use(a.__GUID__),this.cache.get("dirty")||this.cache.miss("pattern")){var b=a.createPattern(this.image,this.repetition);return this.cache.put("pattern",b),b}return this.cache.get("pattern")}});return c}),d("2d/RadialGradient",["require","./Gradient","../math/Vector2"],function(a){var b=a("./Gradient"),c=a("../math/Vector2"),d=b.derive(function(){return{start:new c,startRadius:0,end:new c,endRadius:0}},{update:function(a){for(var b=a.createRadialGradient(this.start.x,this.start.y,this.startRadius,this.end.x,this.end.y,this.endRadius),c=0;c<this.stops.length;c++){var d=this.stops[c];b.addColorStop(d[0],d[1])}this.cache.put("gradient",b)}});return d}),d("2d/Scene",["require","./Node"],function(a){var b=a("./Node"),c=b.derive(function(){return{}},{});return c}),d("2d/picking/Box",function(){}),d("2d/picking/Pixel",["require","../../core/Base"],function(a){function b(a){var b=a>>16,c=a-(b<<8)>>8,d=a-(b<<16)-(c<<8);return[b,c,d]}function c(a,b,c){return(a<<16)+(b<<8)+c}var d=a("../../core/Base"),e=d.derive(function(){return{downSampleRatio:1,width:100,height:100,lookupOffset:1,_canvas:null,_context:null,_imageData:null,_lookupTable:[]}},function(){this.init()},{init:function(){var a=document.createElement("canvas");this._canvas=a,this._context=a.getContext("2d"),this.resize(this.width,this.height)},setPrecision:function(a){this._canvas.width=this.width*a,this._canvas.height=this.height*a,this.downSampleRatio=a},resize:function(a,b){this._canvas.width=a*this.downSampleRatio,this._canvas.height=b*this.downSampleRatio,this.width=a,this.height=b},update:function(a,b){var c=this._context;if(c.clearRect(0,0,this._canvas.width,this._canvas.height),c.save(),c.scale(this.downSampleRatio,this.downSampleRatio),this._lookupTable.length=0,b){var d=b.getViewMatrix()._array;c.transform(d[0],d[1],d[2],d[3],d[4],d[5])}this._renderNode(a,c),c.restore();var e=c.getImageData(0,0,this._canvas.width,this._canvas.height);this._imageData=e.data},_renderNode:function(a,c){c.save(),a.updateTransform();var d=a.transform._array;if(c.transform(d[0],d[1],d[2],d[3],d[4],d[5]),a.clip&&c.clip(),a.draw&&a.enablePicking===!0){var e=this._lookupTable,f=b(e.length+this.lookupOffset),g="rgb("+f.join(",")+")";this._lookupTable.push(a),c.fillStyle=g,c.strokeStyle=g,a.draw(c,!0)}for(var h=a.getSortedRenderQueue(),i=0;i<h.length;i++){var j=h[i];this._renderNode(j,c)}c.restore()},pick:function(a,b){var c=this.downSampleRatio;this._canvas.width,this._canvas.height,a=Math.ceil(c*a),b=Math.ceil(c*b);for(var d,e=[this._sample(a,b),this._sample(a-1,b),this._sample(a+1,b),this._sample(a,b-1),this._sample(a,b+1)],f={},g=0,h=0;h<e.length;h++){var i=e[h];f[i]?f[i]++:f[i]=1,f[i]>g&&(g=f[i],d=i)}var i=d-this.lookupOffset;if(i&&g>=2){var j=this._lookupTable[i];return j}},_sample:function(a,b){a=Math.max(Math.min(a,this._canvas.width),1),b=Math.max(Math.min(b,this._canvas.height),1);var d=4*((b-1)*this._canvas.width+(a-1)),e=this._imageData,f=e[d],g=e[d+1],h=e[d+2];return c(f,g,h)}});return e}),d("2d/shape/Arc",["require","../Node","../../math/Vector2"],function(a){var b=a("../Node"),c=a("../../math/Vector2"),d=b.derive(function(){return{center:new c,radius:0,startAngle:0,endAngle:2*Math.PI,clockwise:!0}},{computeBoundingBox:function(){util.computeArcBoundingBox(this.center,this.radius,this.startAngle,this.endAngle,this.clockwise,this.boundingBox.min,this.boundingBox.max)},draw:function(){ctx.beginPath(),ctx.arc(this.center.x,this.center.y,this.radius,this.startAngle,this.endAngle,!this.clockwise),this.stroke&&ctx.stroke(),this.fill&&ctx.fill()},intersect:function(){return!1}});return d}),d("2d/shape/Circle",["require","../Node","../../math/Vector2"],function(a){var b=a("../Node"),c=a("../../math/Vector2"),d=b.derive(function(){return{center:new c,radius:0}},{computeBoundingBox:function(){this.boundingBox={min:new c(this.center.x-this.radius,this.center.y-this.radius),max:new c(this.center.x+this.radius,this.center.y+this.radius)}},draw:function(a){a.beginPath(),a.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI,!1),this.stroke&&a.stroke(),this.fill&&a.fill()},intersect:function(){return vec2.len([this.center[0]-x,this.center[1]-y])<this.radius}});return d}),d("2d/shape/Ellipse",["require","../Node","../../math/Vector2"],function(a){var b=a("../Node"),c=a("../../math/Vector2"),d=b.derive(function(){return{center:new c,radius:new c}},{computeBoundingBox:function(){this.boundingBox={min:this.center.clone().sub(this.radius),max:this.center.clone().add(this.radius)}},draw:function(a){a.save(),a.translate(this.center.x,this.center.y),a.scale(1,this.radius.y/this.radius.x),a.beginPath(),a.arc(0,0,this.radius.x,0,2*Math.PI,!1),this.stroke&&a.stroke(),this.fill&&a.fill(),a.restore()},intersect:function(){return vec2.len([this.center[0]-x,this.center[1]-y])<this.radius}});return d}),d("2d/shape/HTML",["require","../Node"],function(a){var b=a("../Node"),c='<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200">                    <foreignObject>                        {html}                    </foreignObject>',d=b.derive(function(){return{html:"",_img:null}},{draw:function(a){var b=this.html;c.replace("{html}",b),this._img||this.update(),this._img.complete&&a.drawImage(this._img,0,0)},update:function(){var a=new Blob([svg],{type:"image/svg+xml;charset=utf-8"}),b=new Image,c=window.URL||window.webkitURL||window,d=c.createObjectURL(a);b.onload=function(){this.trigger("load"),c.revokeObjectURL(d)},b.src=d}});return d}),d("2d/shape/Image",["require","../Node","../../math/Vector2","_"],function(a){var b=a("../Node"),c=a("../../math/Vector2"),d=a("_"),e={},f=b.derive(function(){return{image:null,start:new c,size:null}},{computeBoundingBox:function(){this.size&&(this.boundingBox={min:this.start.clone(),max:this.start.clone().add(this.size)})},draw:function(a,b){this.image&&!b&&(this.size?a.drawImage(this.image,this.start.x,this.start.y,this.size.x,this.size.y):a.drawImage(this.image,this.start.x,this.start.y))},intersect:function(a,b){return this.intersectBoundingBox(a,b)}});return f.load=function(a,b){if(e[a]){var c=e[a];c.constructor==Array?c.push(b):b(c)}else{e[a]=[b];var c=new Image;c.onload=function(){d.each(e[a],function(a){a(c)}),e[a]=c,c.onload=null},c.src=a}},f}),d("2d/util",["require","../math/Vector2","glmatrix"],function(a){var b=a("../math/Vector2"),c=a("glmatrix");c.vec2,new b;var d={fixPos:function(a){return a.x+=.5,a.y+=.5,a},fixPosArray:function(a){for(var b=a.length,c=0;b>c;c++)this.fixPos(a[c]);return a},computeBoundingBox:function(a,b,c){for(var d=a[0].x,e=a[0].x,f=a[0].y,g=a[0].y,h=1;h<a.length;h++){var i=a[h];i.x<d&&(d=i.x),i.x>e&&(e=i.x),i.y<f&&(f=i.y),i.y>g&&(g=i.y)}b.set(d,f),c.set(e,g)},computeCubeBezierBoundingBox:function(a,b,c,e,f,g){var h=d._computeCubeBezierExtremitiesDim(a.x,b.x,c.x,e.x),i=d._computeCubeBezierExtremitiesDim(a.y,b.y,c.y,e.y);h.push(a.x,e.x),i.push(a.y,e.y);var j=Math.min.apply(null,h),k=Math.max.apply(null,h),l=Math.min.apply(null,i),m=Math.max.apply(null,i);f.set(j,l),g.set(k,m)},_computeCubeBezierExtremitiesDim:function(a,b,c,d){var e=[],f=6*c-12*b+6*a,g=9*b+3*d-3*a-9*c,h=3*b-3*a,i=f*f-4*g*h;if(i>0){var j=Math.sqrt(i),k=(-f+j)/(2*g),l=(-f-j)/(2*g);e.push(k,l)}else 0==i&&e.push(-f/(2*g));for(var m=[],n=0;n<e.length;n++){var o=e[n];if(Math.abs(2*g*o+f)>1e-4&&1>o&&o>0){var p=1-o,q=p*p*p*a+3*p*p*o*b+3*p*o*o*c+o*o*o*d;m.push(q)}}return m},computeQuadraticBezierBoundingBox:function(a,c,e,f,g){var h=a.x+e.x-2*c.x;if(0===h)var i=.5;else var i=(a.x-c.x)/h;if(h=a.y+e.y-2*c.y,0===h)var j=.5;else var j=(a.y-c.y)/h;i=Math.max(Math.min(i,1),0),j=Math.max(Math.min(j,1),0);var k=1-i,l=1-j,m=k*k*a.x+2*k*i*c.x+i*i*e.x,n=k*k*a.y+2*k*i*c.y+i*i*e.y,o=l*l*a.x+2*l*j*c.x+j*j*e.x,p=l*l*a.y+2*l*j*c.y+j*j*e.y;return d.computeBoundingBox([a.clone(),e.clone(),new b(m,n),new b(o,p)],f,g)},computeArcBoundingBox:function(){var a=new b,c=new b,e=[new b,new b,new b,new b];return function(b,f,g,h,i,j,k){i=i?1:-1,a.set(Math.cos(g),Math.sin(g)*i).scale(f).add(b),c.set(Math.cos(h),Math.sin(h)*i).scale(f).add(b),g%=2*Math.PI,0>g&&(g+=2*Math.PI),h%=2*Math.PI,0>h&&(h+=2*Math.PI),g>h&&(h+=2*Math.PI);for(var l=0,m=0;h>m;m+=Math.PI/2)m>g&&e[l++].set(Math.cos(m),Math.sin(m)*i).scale(f).add(b);var n=e.slice(0,l);n.push(a,c),d.computeBoundingBox(n,j,k)}}()};return d}),d("2d/shape/Line",["require","../Node","../util","../../math/Vector2"],function(a){var b=a("../Node"),c=a("../util"),d=a("../../math/Vector2"),e=b.derive(function(){return{start:new d,end:new d,width:0}},{computeBoundingBox:function(){this.boundingBox=c.computeBoundingBox([this.start,this.end],this.boundingBox.min,this.boundingBox.max),this.boundingBox.min.x==this.boundingBox.max.x&&(this.boundingBox.min.x-=this.width/2,this.boundingBox.max.x+=this.width/2),this.boundingBox.min.y==this.boundingBox.max.y&&(this.boundingBox.min.y-=this.width/2,this.boundingBox.max.y+=this.width/2)},draw:function(a){var b=this.start,c=this.end;a.beginPath(),a.moveTo(b.x,b.y),a.lineTo(c.x,c.y),a.stroke()},intersect:function(){var a=new d,b=new d,c=new d;return function(d,e){if(!this.intersectBoundingBox(d,e))return!1;var f=this.start,g=this.end;a.set(d,e),b.copy(a).sub(f),c.copy(g).sub(f);var h=b.length(),i=c.length();return h*b.scale(1/h).dot(i.scale(1/i)),distance<.25*this.width*this.width}}});return e}),d("2d/shape/Path",["require","../Node","../util","../../math/Vector2"],function(a){var b=a("../Node"),c=a("../util"),d=a("../../math/Vector2"),e=new d,f=new d,g=b.derive(function(){return{segments:[],closePath:!1}},{computeBoundingBox:function(){var a=this.segments.length,b=this.segments,d=this.boundingBox.min,g=this.boundingBox.max;d.set(999999,999999),g.set(-999999,-999999);for(var h=1;a>h;h++)b[h-1].handleOut||b[h].handleIn?(c.computeCubeBezierBoundingBox(b[h-1].point,b[h-1].handleOut||b[h-1].point,b[h].handleIn||b[h].point,b[h].point,e,f),d.min(e),g.max(f)):(d.min(b[h-1].point),d.min(b[h].point),g.max(b[h-1].point),g.max(b[h].point))},draw:function(a){var b=this.segments.length,c=this.segments;a.beginPath(),a.moveTo(c[0].point.x,c[0].point.y);for(var d=1;b>d;d++)if(c[d-1].handleOut||c[d].handleIn){var e=c[d-1].handleOut||c[d-1].point,f=c[d].handleIn||c[d].point;a.bezierCurveTo(e.x,e.y,f.x,f.y,c[d].point.x,c[d].point.y)}else a.lineTo(c[d].point.x,c[d].point.y);if(this.closePath)if(c[b-1].handleOut||c[0].handleIn){var e=c[b-1].handleOut||c[b-1].point,f=c[0].handleIn||c[0].point;a.bezierCurveTo(e.x,e.y,f.x,f.y,c[0].point.x,c[0].point.y)}else a.lineTo(c[0].point.x,c[0].point.y);this.fill&&a.fill(),this.stroke&&a.stroke()},smooth:function(a){for(var b=this.segments.length,c=this.segments,e=new d,f=0;b>f;f++){var g=c[f].point,h=0==f?c[b-1].point:c[f-1].point,i=f==b-1?c[0].point:c[f+1].point,a=c[f].smoothLevel||a||1;e.copy(i).sub(h).scale(.25),e.scale(a),c[f].handleIn?c[f].handleIn.copy(g).sub(e):c[f].handleIn=g.clone().sub(e),c[f].handleOut?c[f].handleOut.copy(g).add(e):c[f].handleOut=g.clone().add(e)}},pushPoints:function(a){for(var b=0;b<a.length;b++)this.segments.push({point:a[b],handleIn:null,handleOut:null})}});return g}),d("2d/shape/Polygon",["require","../Node","../util","../../math/Vector2"],function(a){var b=a("../Node"),c=a("../util"),d=a("../../math/Vector2"),e=b.derive(function(){return{points:[]}},{computeBoundingBox:function(){this.boundingBox=c.computeBoundingBox(this.points,this.boundingBox.min,this.boundingBox.max)},draw:function(a){var b=this.points;a.beginPath(),a.moveTo(b[0].x,b[0].y);for(var c=1;c<b.length;c++)a.lineTo(b[c].x,b[c].y);a.closePath(),this.stroke&&a.stroke(),this.fill&&a.fill()},intersect:function(a,b){if(!this.intersectBoundingBox(a,b))return!1;for(var c=this.points.length,e=0,f=this.points,g=new d,h=new d,i=0;c>i;i++){g.set(a,b).sub(f[i]).normalize().negate();var j=(i+1)%c;h.set(a,b).sub(f[j]).normalize().negate();var k=Math.acos(g.dot(h));e+=k}return Math.length(e-2*Math.PI)<.001}});return e}),d("2d/shape/Rectangle",["require","../Node","../util","../../math/Vector2"],function(a){var b=a("../Node");a("../util");var c=a("../../math/Vector2"),d=b.derive(function(){return{start:new c(0,0),size:new c(0,0)}},{computeBoundingBox:function(){return{min:this.start.clone(),max:this.size.clone().add(this.start)}},draw:function(a){var b=this.start;a.beginPath(),a.rect(b.x,b.y,this.size.x,this.size.y),this.stroke&&a.stroke(),this.fill&&a.fill()},intersect:function(a,b){return this.intersectBoundingBox(a,b)}});return d}),d("2d/shape/RoundedRectangle",["require","../Node","../util","../../math/Vector2"],function(a){var b=a("../Node"),c=a("../util"),d=a("../../math/Vector2"),e=b.derive(function(){return{start:new d,size:new d,radius:0}},{computeBoundingBox:function(){this.boundingBox={min:this.start.clone(),max:this.size.clone().add(this.start)}},draw:function(a){if(this.radius.constructor==Number)var b=[this.radius,this.radius,this.radius,this.radius];else if(2==this.radius.length)var b=[this.radius[0],this.radius[1],this.radius[0],this.radius[1]];else var b=this.radius;var e=this.fixAA?c.fixPos(this.start.clone()):this.start,f=this.size,g=(new d).copy(e).add(new d(b[0],0)),h=(new d).copy(e).add(new d(f.x,0)),i=(new d).copy(e).add(f),j=(new d).copy(e).add(new d(0,f.y));a.beginPath(),a.moveTo(g.x,g.y),b[1]?a.arcTo(h.x,h.y,i.x,i.y,b[1]):a.lineTo(h.x,h.y),b[2]?a.arcTo(i.x,i.y,j.x,j.y,b[2]):a.lineTo(i.x,i.y),b[3]?a.arcTo(j.x,j.y,e.x,e.y,b[3]):a.lineTo(j.x,j.y),b[0]?a.arcTo(e.x,e.y,h.x,h.y,b[0]):a.lineTo(e.x,e.y),this.stroke&&a.stroke(),this.fill&&a.fill()},intersect:function(){return!1}});return e}),d("2d/shape/SVGPath",["require","../Node","../util","../../math/Vector2"],function(a){var b=a("../Node"),c=a("../util"),d=a("../../math/Vector2"),e={m:1,M:1,z:1,Z:1,l:1,L:1,h:1,H:1,v:1,V:1,c:1,C:1,s:1,S:1,q:1,Q:1,t:1,T:1,a:1,A:1},f=b.derive(function(){return{description:"",_ops:[]}},{draw:function(a){this._ops.length||this.parse(),a.beginPath();for(var b=0;b<this._ops.length;b++){var c=this._ops[b];switch(c[0]){case"m":a.moveTo(c[1],c[2]);break;case"l":a.lineTo(c[1],c[2]);break;case"c":a.bezierCurveTo(c[1],c[2],c[3],c[4],c[5],c[6]);break;case"q":a.quadraticCurveTo(c[1],c[2],c[3],c[4]);break;case"z":a.closePath(),this.fill&&a.fill(),this.stroke&&a.stroke(),a.beginPath()}}this.fill&&a.fill(),this.stroke&&a.stroke()},computeBoundingBox:function(){var a=new d,b=new d,e=new d,f=new d,g=new d,h=new d;return function(){this._ops.length||this.parse();for(var i=new d(999999,999999),j=new d(-999999,-999999),k=0;k<this._ops.length;k++){var l=this._ops[k];switch(l[0]){case"m":a.set(l[1],l[2]);break;case"l":b.set(l[1],l[2]),a.copy(b),i.min(a).min(b),j.max(a).max(b);break;case"c":b.set(l[1],l[2]),e.set(l[3],l[4]),f.set(l[5],l[6]),c.computeCubeBezierBoundingBox(a,b,e,f,g,h),a.copy(f),i.min(g),j.max(h);break;case"q":b.set(l[1],l[2]),e.set(l[3],l[4]),c.computeQuadraticBezierBoundingBox(a,b,e,g,h),a.copy(e),i.min(g),i.max(h);break;case"z":}}this.boundingBox={min:i,max:j}}}(),parse:function(a){function b(){return p=k[n+1],k[n++]}function c(){return p=k[n+1],q=k[n++],parseFloat(q)}var d=0,f=0,g=0,h=0,i=0,j=0;a=a||this.description;var k=a.replace(/\s*,\s*/g," ");k=k.replace(/(-)/g," $1"),k=k.replace(/([mMzZlLhHvVcCsSqQtTaA])/g," $1 "),k=k.split(/\s+/);for(var l="",m="",n=0,o=k.length,p=k[0];o>=n;)if(p)switch(e[p]&&(m=l,l=p,n++),l){case"m":d=c()+d,f=c()+f,this._ops.push(["m",d,f]);break;case"M":d=c(),f=c(),this._ops.push(["m",d,f]);break;case"z":case"Z":p=k[n],this._ops.push(["z"]);break;case"l":d=c()+d,f=c()+f,this._ops.push(["l",d,f]);break;case"L":d=c(),f=c(),this._ops.push(["l",d,f]);break;case"h":d=c()+d,this._ops.push(["l",d,f]);break;case"H":d=c(),this._ops.push(["l",d,f]);break;case"v":f=c()+f,this._ops.push(["l",d,f]);break;case"V":f=c(),this._ops.push(["l",d,f]);break;case"c":g=c()+d,h=c()+f,i=c()+d,j=c()+f,d=c()+d,f=c()+f,this._ops.push(["c",g,h,i,j,d,f]);break;case"C":g=c(),h=c(),i=c(),j=c(),d=c(),f=c(),this._ops.push(["c",g,h,i,j,d,f]);break;case"s":"c"===m||"C"===m||"s"===m||"S"===m?(g=2*d-i,h=2*f-j):(g=d,h=f),i=c()+d,j=c()+f,d=c()+d,f=c()+f,this._ops.push(["c",g,h,i,j,d,f]);break;case"S":"c"===m||"C"===m||"s"===m||"S"===m?(g=2*d-i,h=2*f-j):(g=d,h=f),i=c(),j=c(),d=c(),f=c(),this._ops.push(["c",g,h,i,j,d,f]);break;case"q":g=c()+d,h=c()+f,d=c()+d,f=c()+f,this._ops.push(["q",g,h,d,f]);break;case"Q":g=c(),h=c(),d=c(),f=c(),this._ops.push(["q",g,h,d,f]);break;case"t":"q"===m||"Q"===m||"t"===m||"T"===m?(g=2*d-g,h=2*f-h):(g=d,h=f),d=c()+d,f=c()+f,this._ops.push(["q",g,h,d,f]);break;case"T":"q"===m||"Q"===m||"t"===m||"T"===m?(g=2*d-g,h=2*f-h):(g=d,h=f),d=c(),f=c(),this._ops.push(["q",g,h,d,f]);break;case"a":case"A":c(),c(),c(),c(),c(),c(),c(),console.warn("Elliptical arc is not supported yet");break;default:b();continue}else p=k[++n];var q}});return f}),d("2d/shape/Sector",["require","../Node","../util","../../math/Vector2"],function(a){var b=a("../Node"),c=a("../util"),d=a("../../math/Vector2"),e=b.derive(function(){return{center:new d,innerRadius:0,outerRadius:0,startAngle:0,endAngle:0,clockwise:!0}},{computeBoundingBox:function(){var a=new d,b=new d;c.computeArcBoundingBox(this.center,this.innerRadius,this.startAngle,this.endAngle,this.clockwise,a,b),this.boundingBox.min.set(99999,99999).min(a),this.boundingBox.max.set(-99999,-99999).max(b),c.computeArcBoundingBox(this.center,this.outerRadius,this.startAngle,this.endAngle,this.clockwise,a,b),this.boundingBox.min.min(a),this.boundingBox.max.max(b)},intersect:function(a,b){var c=this.startAngle,e=this.endAngle,f=this.innerRadius,g=this.outerRadius,h=this.center,i=new d(a,b).sub(h),j=i.length(),k=2*Math.PI;if(f>j||j>g)return!1;var l=Math.atan2(i.y,i.x);return 0>l&&(l+=k),this.clockwise?e>l&&l>c:(c=k-c,e=k-e,l>e&&c>l)},draw:function(a){var b=this.startAngle,c=this.endAngle,e=this.innerRadius,f=this.outerRadius,g=this.center;this.clockwise||(b=2*Math.PI-b,c=2*Math.PI-c);var h=new d(e*Math.cos(b),e*Math.sin(b)).add(g),i=new d(f*Math.cos(b),f*Math.sin(b)).add(g),j=new d(e*Math.cos(c),e*Math.sin(c)).add(g);new d(f*Math.cos(c),f*Math.sin(c)).add(g),a.beginPath(),a.moveTo(h.x,h.y),a.lineTo(i.x,i.y),a.arc(g.x,g.y,f,b,c,!this.clockwise),a.lineTo(j.x,j.y),a.arc(g.x,g.y,e,c,b,this.clockwise),a.closePath(),this.stroke&&a.stroke(),this.fill&&a.fill()}});return e}),d("2d/shape/Text",["require","../Node","../util","../../math/Vector2"],function(a){var b=a("../Node");a("../util");var c=a("../../math/Vector2"),d=b.derive(function(){return{text:"",start:new c,size:new c}},{computeBoundingBox:function(){this.boundingBox={min:this.start.clone(),max:this.start.clone().add(this.size)}},draw:function(a){var b=this.start;this.fill&&(this.size.length&&this.size.x?a.fillText(this.text,b.x,b.y,this.size.x):a.fillText(this.text,b.x,b.y)),this.stroke&&(this.size.length&&this.size.x?a.strokeText(this.text,b.x,b.y,this.size.x):a.strokeText(this.text,b.x,b.y))},resize:function(a){(!this.size.x||this.needResize)&&(this.size.x=a.measureText(this.text).width,this.size.y=a.measureText("m").width)},intersect:function(a,b){return this.intersectBoundingBox(a,b)}});return d}),d("2d/shape/TextBox",["require","../Node","../../math/Vector2","./Text","_"],function(a){var b=a("../Node"),c=a("../../math/Vector2"),d=a("./Text"),e=a("_"),f=b.derive(function(){return{start:new c,width:0,wordWrap:!1,wordBreak:!1,lineHeight:0,stroke:!1,_texts:[]}},function(){this._oldText=""},{computeBoundingBox:function(){},draw:function(a){if(this.text!=this._oldText)if(this._oldText=this.text,this.font&&(a.font=this.font),this.wordBreak)this._texts=this.computeWordBreak(a);else if(this.wordWrap)this._texts=this.computeWordWrap(a);else{var b=new d({text:this.text});this.extendCommonProperties(b),this._texts=[b]}a.save(),a.textBaseline="top",e.each(this._texts,function(b){b.draw(a)}),a.restore()},computeWordWrap:function(a){if(this.text){for(var b,e,f,g=this.text.split(" "),h=g.length,i=0,j=[],k=a.measureText("m").width,l=0;h>l;l++)e=l==h-1?g[l]:g[l]+" ",b=a.measureText(e).width,i+b>this.width||!f?(f=new d({text:e,start:this.start.clone().add(new c(0,this.lineHeight*(j.length+1)-k))}),this.extendCommonProperties(f),j.push(f),i=b):(i+=b,f.text+=e);return j}},computeWordBreak:function(a){if(this.text){for(var b,e,f,g=this.text.length,h=a.measureText(this.text[0]).width,i=[],j=a.measureText("m").width,k=0;g>k;k++)if(e=this.text[k],b=a.measureText(e).width,h+b>this.width||!f){var f=new d({text:e,start:this.start.clone().add(new c(0,this.lineHeight*(i.length+1)-j))});this.extendCommonProperties(f),i.push(f),h=b}else h+=b,f.text+=e;return i}},extendCommonProperties:function(a){e.extend(a,{fill:this.fill,stroke:this.stroke})},intersect:function(){}});return f}),d("math/Vector3",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.vec3,d=function(a,b,d){a=a||0,b=b||0,d=d||0,this._array=c.fromValues(a,b,d),this._dirty=!0};return d.prototype={constructor:d,get x(){return this._array[0]},set x(a){this._array[0]=a,this._dirty=!0},get y(){return this._array[1]},set y(a){this._array[1]=a,this._dirty=!0},get z(){return this._array[2]},set z(a){this._array[2]=a,this._dirty=!0},add:function(a){return c.add(this._array,this._array,a._array),this._dirty=!0,this},set:function(a,b,c){return this._array[0]=a,this._array[1]=b,this._array[2]=c,this._dirty=!0,this},clone:function(){return new d(this.x,this.y,this.z)},copy:function(a){return c.copy(this._array,a._array),this._dirty=!0,this},cross:function(a,b){return c.cross(a._array,this._array,b._array),this},dist:function(a){return c.dist(this._array,a._array)},distance:function(a){return c.distance(this._array,a._array)},div:function(a){return c.div(this._array,this._array,a._array),this._dirty=!0,this},divide:function(a){return c.divide(this._array,this._array,a._array),this._dirty=!0,this},dot:function(a){return c.dot(this._array,a._array)},len:function(){return c.len(this._array)},length:function(){return c.length(this._array)},lerp:function(a,b,d){return c.lerp(this._array,a._array,b._array,d),this._dirty=!0,this},min:function(a){return vec2.min(this._array,this._array,a._array),this._dirty=!0,this},max:function(a){return vec2.max(this._array,this._array,a._array),this._dirty=!0,this},mul:function(a){return c.mul(this._array,this._array,a._array),this._dirty=!0,this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this._dirty=!0,this},negate:function(){return c.negate(this._array,this._array),this._dirty=!0,this},normalize:function(){return c.normalize(this._array,this._array),this._dirty=!0,this},random:function(a){return c.random(this._array,a),this._dirty=!0,this},scale:function(a){return c.scale(this._array,this._array,a),this._dirty=!0,this},scaleAndAdd:function(a,b){return c.scaleAndAdd(this._array,this._array,a._array,b),this._dirty=!0,this},sqrDist:function(a){return c.sqrDist(this._array,a._array)},squaredDistance:function(a){return c.squaredDistance(this._array,a._array)},sqrLen:function(){return c.sqrLen(this._array)},squaredLength:function(){return c.squaredLength(this._array)},sub:function(a){return c.sub(this._array,this._array,a._array),this._dirty=!0,this},subtract:function(a){return c.subtract(this._array,this._array,a._array),this._dirty=!0,this},transformMat3:function(a){return c.transformMat3(this._array,this._array,a._array),this._dirty=!0,this},transformMat4:function(a){return c.transformMat4(this._array,this._array,a._array),this._dirty=!0,this},transformQuat:function(a){return c.transformQuat(this._array,this._array,a._array),this._dirty=!0,this},setEulerFromQuaternion:function(){},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}},d.POSITIVE_X=new d(1,0,0),d.NEGATIVE_X=new d(-1,0,0),d.POSITIVE_Y=new d(0,1,0),d.NEGATIVE_Y=new d(0,-1,0),d.POSITIVE_Z=new d(0,0,1),d.NEGATIVE_Z=new d(0,0,-1),d.UP=new d(0,1,0),d.ZERO=new d(0,0,0),d}),d("math/Quaternion",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.quat,d=function(a,b,d,e){a=a||0,b=b||0,d=d||0,e=void 0===e?1:e,this._array=c.fromValues(a,b,d,e),this._dirty=!0};return d.prototype={constructor:d,get x(){return this._array[0]},set x(a){this._array[0]=a,this._dirty=!0},get y(){this._array[1]=value,this._dirty=!0},set y(){return this._array[1]},get z(){return this._array[2]},set z(a){this._array[2]=a,this._dirty=!0},get w(){return this._array[3]},set w(a){this._array[3]=a,this._dirty=!0},add:function(a){return c.add(this._array,this._array,a._array),this._dirty=!0,this},calculateW:function(){return c.calculateW(this._array,this._array),this._dirty=!0,this},set:function(a,b,c,d){return this._array[0]=a,this._array[1]=b,this._array[2]=c,this._array[3]=d,this._dirty=!0,this},clone:function(){return new d(this.x,this.y,this.z,this.w)},conjugate:function(){return c.conjugate(this._array,this._array),this._dirty=!0,this},copy:function(a){return c.copy(this._array,a._array),this._dirty=!0,this},dot:function(a){return c.dot(this._array,a._array)},fromMat3:function(a){return c.fromMat3(this._array,a._array),this._dirty=!0,this},fromMat4:function(){var a=b.mat3,d=a.create();return function(b){return a.fromMat4(d,b._array),a.transpose(d,d),c.fromMat3(this._array,d),this._dirty=!0,this}}(),identity:function(){return c.identity(this._array),this._dirty=!0,this},invert:function(){return c.invert(this._array,this._array),this._dirty=!0,this},len:function(){return c.len(this._array)},length:function(){return c.length(this._array)},lerp:function(a,b,d){return c.lerp(this._array,a._array,b._array,d),this._dirty=!0,this},mul:function(a){return c.mul(this._array,this._array,a._array),this._dirty=!0,this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this._dirty=!0,this},normalize:function(){return c.normalize(this._array,this._array),this._dirty=!0,this},rotateX:function(a){return c.rotateX(this._array,this._array,a),this._dirty=!0,this},rotateY:function(a){return c.rotateY(this._array,this._array,a),this._dirty=!0,this},rotateZ:function(a){return c.rotateZ(this._array,this._array,a),this._dirty=!0,this},setAxisAngle:function(a,b){return c.setAxisAngle(this._array,a._array,b),this._dirty=!0,this},slerp:function(a,b,d){return c.slerp(this._array,a._array,b._array,d),this._dirty=!0,this},sqrLen:function(){return c.sqrLen(this._array)},squaredLength:function(){return c.squaredLength(this._array)},setFromEuler:function(){},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}},d}),d("math/Matrix4",["require","glmatrix","./Vector3"],function(a){var b=a("glmatrix"),c=a("./Vector3"),d=b.mat4,e=b.vec3,f=b.mat3,g=b.quat,h=function(){this._axisX=new c,this._axisY=new c,this._axisZ=new c,this._array=d.create()};return h.prototype={constructor:h,get forward(){var a=this._array;return this._axisZ.set(a[8],a[9],a[10]),this._axisZ},set forward(a){var b=this._array;a=a._array,b[8]=a[8],b[9]=a[9],b[10]=a[10]},get up(){var a=this._array;return this._axisY.set(a[4],a[5],a[6]),this._axisY},set up(a){var b=this._array;a=a._array,b[4]=a[4],b[5]=a[5],b[6]=a[6]},get right(){var a=this._array;return this._axisX.set(a[0],a[1],a[2]),this._axisX},set right(a){var b=this._array;a=a._array,b[0]=a[0],b[1]=a[1],b[2]=a[2]},adjoint:function(){return d.adjoint(this._array,this._array),this},clone:function(){return(new h).copy(this)},copy:function(a){return d.copy(this._array,a._array),this},determinant:function(){return d.determinant(this._array)},fromQuat:function(a){return d.fromQuat(this._array,a._array),this},fromRotationTranslation:function(a,b){return d.fromRotationTranslation(this._array,a._array,b._array),this},frustum:function(a,b,c,e,f,g){return d.frustum(this._array,a,b,c,e,f,g),this},identity:function(){return d.identity(this._array),this},invert:function(){return d.invert(this._array,this._array),this},lookAt:function(a,b,c){return d.lookAt(this._array,a._array,b._array,c._array),this},mul:function(a){return d.mul(this._array,this._array,a._array),this},mulLeft:function(a){return d.mul(this._array,a._array,this._array),this},multiply:function(a){return d.multiply(this._array,this._array,a._array),this},multiplyLeft:function(a){return d.multiply(this._array,a._array,this._array),this},ortho:function(a,b,c,e,f,g){return d.ortho(this._array,a,b,c,e,f,g),this},perspective:function(a,b,c,e){return d.perspective(this._array,a,b,c,e),this},rotate:function(a,b){return d.rotate(this._array,this._array,a,b._array),this},rotateX:function(a){return d.rotateX(this._array,this._array,a),this},rotateY:function(a){return d.rotateY(this._array,this._array,a),this},rotateZ:function(a){return d.rotateZ(this._array,this._array,a),this},scale:function(a){return d.scale(this._array,this._array,a._array),this},translate:function(a){return d.translate(this._array,this._array,a._array),this},transpose:function(){return d.transpose(this._array,this._array),this},decomposeMatrix:function(){var a=e.create(),b=e.create(),c=e.create(),d=f.create();return function(h,i,j){var k=this._array;e.set(a,k[0],k[1],k[2]),e.set(b,k[4],k[5],k[6]),e.set(c,k[8],k[9],k[10]),h.x=e.length(a),h.y=e.length(b),h.z=e.length(c),j.set(k[12],k[13],k[14]),f.fromMat4(d,k),f.transpose(d,d),d[0]/=h.x,d[1]/=h.x,d[2]/=h.x,d[3]/=h.y,d[4]/=h.y,d[5]/=h.y,d[6]/=h.z,d[7]/=h.z,d[8]/=h.z,g.fromMat3(i._array,d),i.normalize()
}}(),toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}},h}),d("math/Matrix3",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.mat3,d=function(){this._array=c.create()};return d.prototype={constructor:d,adjoint:function(){return c.adjoint(this._array,this._array),this},clone:function(){return(new d).copy(this)},copy:function(a){return c.copy(this._array,a._array),this},determinant:function(){return c.determinant(this._array)},fromMat2d:function(a){return c.fromMat2d(this._array,a._array)},fromMat4:function(a){return c.fromMat4(this._array,a._array)},fromQuat:function(a){return c.fromQuat(this._array,a._array),this},identity:function(){return c.identity(this._array),this},invert:function(){return c.invert(this._array,this._array),this},mul:function(a){return c.mul(this._array,this._array,a._array),this},mulLeft:function(a){return c.mul(this._array,a._array,this._array),this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this},multiplyLeft:function(a){return c.multiply(this._array,a._array,this._array),this},normalFromMat4:function(a){return c.normalFromMat4(this._array,a._array),this},transpose:function(){return c.transpose(this._array,this._array),this},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}},d}),d("Node",["require","./core/Base","./core/util","./math/Vector3","./math/Quaternion","./math/Matrix4","./math/Matrix3","glmatrix"],function(a){var b=a("./core/Base"),c=a("./core/util"),d=a("./math/Vector3"),e=a("./math/Quaternion"),f=a("./math/Matrix4");a("./math/Matrix3");var g=a("glmatrix"),h=g.mat4,i=b.derive(function(){var a=c.genGUID();return{__GUID__:a,name:"NODE_"+a,position:new d,rotation:new e,scale:new d(1,1,1),parent:null,scene:null,worldTransform:new f,localTransform:new f,autoUpdateLocalTransform:!0,_children:[],_needsUpdateWorldTransform:!0,__depth:0}},{visible:!0,isRenderable:function(){return!1},setName:function(a){this.scene&&(this.scene._nodeRepository[a]=null,this.scene._nodeRepository[newName]=this),a=newName},add:function(a){if(a.parent!==this){a.parent&&a.parent.remove(a),a.parent=this,this._children.push(a);var b=this.scene;b&&a.traverse(function(a){b.addToScene(a),a.scene=b})}},remove:function(a){this._children.splice(this._children.indexOf(a),1),a.parent=null;var b=this.scene;b&&a.traverse(function(a){b.removeFromScene(a),a.scene=null})},children:function(){return this._children.slice()},childAt:function(a){return this._children[a]},traverse:function(a,b){var c=a(this,b);if(!c)for(var d=this._children,e=0,f=d.length;f>e;e++)d[e].traverse(a,this)},decomposeLocalTransform:function(){this.localTransform.decomposeMatrix(this.scale,this.rotation,this.position),this.rotation._dirty=!1,this.scale._dirty=!1,this.position._dirty=!1},updateLocalTransform:function(){var a=this.position,b=this.rotation,c=this.scale;if(a._dirty||c._dirty||b._dirty){var d=this.localTransform._array;h.fromRotationTranslation(d,b._array,a._array),h.scale(d,d,c._array),b._dirty=!1,c._dirty=!1,a._dirty=!1,this._needsUpdateWorldTransform=!0}},updateWorldTransform:function(){this.parent?h.multiply(this.worldTransform._array,this.parent.worldTransform._array,this.localTransform._array):h.copy(this.worldTransform._array,this.localTransform._array)},update:function(a){this.autoUpdateLocalTransform?this.updateLocalTransform():a=!0,(a||this._needsUpdateWorldTransform)&&(this.updateWorldTransform(),a=!0,this._needsUpdateWorldTransform=!1);for(var b=0,c=this._children.length;c>b;b++){var d=this._children[b];d.visible&&d.update(a)}},getWorldPosition:function(a){var b=this.worldTransform._array;return a?(a._array[0]=b[12],a._array[1]=b[13],a._array[2]=b[14],a):new d(b[12],b[13],b[14])},rotateAround:function(){var a=new d,b=new f;return function(c,d,e){a.copy(this.position).subtract(c),this.localTransform.identity(),this.localTransform.translate(c),this.localTransform.rotate(e,d),b.fromRotationTranslation(this.rotation,a),this.localTransform.multiply(b),this.localTransform.scale(this.scale),this.decomposeLocalTransform(),this._needsUpdateWorldTransform=!0}}(),lookAt:function(){var a=new f,b=new d;return function(c,d){a.lookAt(this.position,c,d||this.localTransform.up).invert(),a.decomposeMatrix(b,this.rotation,this.position)}}()});return i}),d("math/BoundingBox",["require","../core/Base","./Vector3","glmatrix"],function(a){a("../core/Base");var b=a("./Vector3"),c=a("glmatrix");c.mat4;var d=c.vec3,e=d.transformMat4,f=d.copy,g=d.set,h=function(a,c){this.min=a||new b(1/0,1/0,1/0),this.max=c||new b(-1/0,-1/0,-1/0);for(var e=[],f=0;8>f;f++)e[f]=d.fromValues(0,0,0);this.vertices=e};return h.prototype={constructor:h,updateFromVertices:function(a){if(a.length>0){var b=this.min._array,c=this.max._array;f(b,a[0]),f(c,a[0]);for(var d=1;d<a.length;d++){var e=a[d];b[0]=Math.min(e[0],b[0]),b[1]=Math.min(e[1],b[1]),b[2]=Math.min(e[2],b[2]),c[0]=Math.max(e[0],c[0]),c[1]=Math.max(e[1],c[1]),c[2]=Math.max(e[2],c[2])}this.min._dirty=!0,this.max._dirty=!0}},union:function(a){d.min(this.min._array,this.min._array,a.min._array),d.max(this.max._array,this.max._array,a.max._array),this.min._dirty=!0,this.max._dirty=!0},intersectBoundingBox:function(a){var b=this.min._array,c=this.max._array,d=a.min._array,e=a.max._array;return!(b[0]>e[0]||b[1]>e[1]||b[2]>e[1]||c[0]<d[0]||c[1]<d[1]||c[2]<d[2])},applyTransform:function(a){(this.min._dirty||this.max._dirty)&&(this.updateVertices(),this.min._dirty=!1,this.max._dirty=!1);var b=a._array,c=this.min._array,d=this.max._array,g=this.vertices,h=g[0];e(h,h,b),f(c,h),f(d,h);for(var i=1;8>i;i++)h=g[i],e(h,h,b),c[0]=Math.min(h[0],c[0]),c[1]=Math.min(h[1],c[1]),c[2]=Math.min(h[2],c[2]),d[0]=Math.max(h[0],d[0]),d[1]=Math.max(h[1],d[1]),d[2]=Math.max(h[2],d[2]);this.min._dirty=!0,this.max._dirty=!0},applyProjection:function(a){(this.min._dirty||this.max._dirty)&&(this.updateVertices(),this.min._dirty=!1,this.max._dirty=!1);var b=a._array,c=this.vertices[0],d=this.vertices[3],e=this.vertices[7],f=this.min._array,g=this.max._array;if(1===b[15])f[0]=b[0]*c[0]+b[12],f[1]=b[5]*c[1]+b[13],g[2]=b[10]*c[2]+b[14],g[0]=b[0]*e[0]+b[12],g[1]=b[5]*e[1]+b[13],f[2]=b[10]*e[2]+b[14];else{var h=-1/c[2];f[0]=b[0]*c[0]*h,f[1]=b[5]*c[1]*h,g[2]=(b[10]*c[2]+b[14])*h,h=-1/d[2],g[0]=b[0]*d[0]*h,g[1]=b[5]*d[1]*h,h=-1/e[2],f[2]=(b[10]*e[2]+b[14])*h}this.min._dirty=!0,this.max._dirty=!0},updateVertices:function(){var a=this.min._array,b=this.max._array,c=this.vertices;g(c[0],a[0],a[1],a[2]),g(c[1],a[0],b[1],a[2]),g(c[2],b[0],a[1],a[2]),g(c[3],b[0],b[1],a[2]),g(c[4],a[0],a[1],b[2]),g(c[5],a[0],b[1],b[2]),g(c[6],b[0],a[1],b[2]),g(c[7],b[0],b[1],b[2])},copy:function(a){f(this.min._array,a.min._array),f(this.max._array,a.max._array),this.min._dirty=!0,this.max._dirty=!0},clone:function(){var a=new h;return a.copy(this),a}},h}),d("math/Plane",["require","./Vector3","glmatrix"],function(a){var b=a("./Vector3"),c=a("glmatrix"),d=c.vec3,e=function(a,c){this.normal=a||new b,this.distance=c};return e.prototype={constructor:e,distanceToPoint:function(a){return d.dot(a._array,this.normal._array)-this.distance},normalize:function(){var a=1/d.len(this.normal._array);d.scale(this.normal._array,a),this.distance*=a}},e}),d("math/Frustum",["require","./Vector3","./BoundingBox","./Plane","glmatrix"],function(a){a("./Vector3");var b=a("./BoundingBox"),c=a("./Plane"),d=a("glmatrix"),e=d.vec3,f=function(){this.planes=[];for(var a=0;6>a;a++)this.planes.push(new c);this.boundingBox=new b,this.vertices=[];for(var a=0;8>a;a++)this.vertices[a]=e.fromValues(0,0,0)};return f.prototype={setFromProjection:function(a){var b=this.planes,c=a._array,d=c[0],f=c[1],g=c[2],h=c[3],i=c[4],j=c[5],k=c[6],l=c[7],m=c[8],n=c[9],o=c[10],p=c[11],q=c[12],r=c[13],s=c[14],t=c[15];if(e.set(b[0].normal._array,h-d,l-i,p-m),b[0].distance=t-q,b[0].normalize(),e.set(b[1].normal._array,h+d,l+i,p+m),b[1].distance=t+q,b[1].normalize(),e.set(b[2].normal._array,h+f,l+j,p+n),b[2].distance=t+r,b[2].normalize(),e.set(b[3].normal._array,h-f,l-j,p-n),b[3].distance=t-r,b[3].normalize(),e.set(b[4].normal._array,h-g,l-k,p-o),b[4].distance=t-s,b[4].normalize(),e.set(b[5].normal._array,h+g,l+k,p+o),b[5].distance=t+s,b[5].normalize(),0===t){var u=j/d,v=-s/(o-1),w=-s/(o+1),x=-w/j,y=-v/j;this.boundingBox.min.set(-x*u,-x,w),this.boundingBox.max.set(x*u,x,v);var z=this.vertices;e.set(z[0],-x*u,-x,w),e.set(z[1],-x*u,x,w),e.set(z[2],x*u,-x,w),e.set(z[3],x*u,x,w),e.set(z[4],-y*u,-y,v),e.set(z[5],-y*u,y,v),e.set(z[6],y*u,-y,v),e.set(z[7],y*u,y,v)}else{var A=(-1-q)/d,B=(1-q)/d,C=(1-r)/j,D=(-1-r)/j,E=(-1-s)/o,F=(1-s)/o;this.boundingBox.min.set(A,D,F),this.boundingBox.max.set(B,C,E);for(var G=0;8>G;G++)e.copy(this.vertices[G],this.boundingBox.vertices[G])}return this},getTransformedBoundingBox:function(){var a=e.create();return function(b,c){var d=this.vertices,f=c._array,g=b.min._array,h=b.max._array,i=d[0];e.transformMat4(a,i,f),e.copy(g,a),e.copy(h,a);for(var j=1;8>j;j++)i=d[j],e.transformMat4(a,i,f),g[0]=Math.min(a[0],g[0]),g[1]=Math.min(a[1],g[1]),g[2]=Math.min(a[2],g[2]),h[0]=Math.max(a[0],h[0]),h[1]=Math.max(a[1],h[1]),h[2]=Math.max(a[2],h[2]);b.min._dirty=!0,b.max._dirty=!0}}()},f}),d("Camera",["require","./Node","./math/Matrix4","./math/Frustum","./math/BoundingBox"],function(a){var b=a("./Node"),c=a("./math/Matrix4"),d=a("./math/Frustum"),e=a("./math/BoundingBox"),f=b.derive(function(){return{projectionMatrix:new c,frustum:new d,sceneBoundingBoxLastFrame:new e}},function(){this.update()},{update:function(){b.prototype.update.call(this),this.updateProjectionMatrix(),this.frustum.setFromProjection(this.projectionMatrix)},updateProjectionMatrix:function(){}});return f}),d("core/glenum",[],function(){return{DEPTH_BUFFER_BIT:256,STENCIL_BUFFER_BIT:1024,COLOR_BUFFER_BIT:16384,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,ZERO:0,ONE:1,SRC_COLOR:768,ONE_MINUS_SRC_COLOR:769,SRC_ALPHA:770,ONE_MINUS_SRC_ALPHA:771,DST_ALPHA:772,ONE_MINUS_DST_ALPHA:773,DST_COLOR:774,ONE_MINUS_DST_COLOR:775,SRC_ALPHA_SATURATE:776,FUNC_ADD:32774,BLEND_EQUATION:32777,BLEND_EQUATION_RGB:32777,BLEND_EQUATION_ALPHA:34877,FUNC_SUBTRACT:32778,FUNC_REVERSE_SUBTRACT:32779,BLEND_DST_RGB:32968,BLEND_SRC_RGB:32969,BLEND_DST_ALPHA:32970,BLEND_SRC_ALPHA:32971,CONSTANT_COLOR:32769,ONE_MINUS_CONSTANT_COLOR:32770,CONSTANT_ALPHA:32771,ONE_MINUS_CONSTANT_ALPHA:32772,BLEND_COLOR:32773,ARRAY_BUFFER:34962,ELEMENT_ARRAY_BUFFER:34963,ARRAY_BUFFER_BINDING:34964,ELEMENT_ARRAY_BUFFER_BINDING:34965,STREAM_DRAW:35040,STATIC_DRAW:35044,DYNAMIC_DRAW:35048,BUFFER_SIZE:34660,BUFFER_USAGE:34661,CURRENT_VERTEX_ATTRIB:34342,FRONT:1028,BACK:1029,FRONT_AND_BACK:1032,CULL_FACE:2884,BLEND:3042,DITHER:3024,STENCIL_TEST:2960,DEPTH_TEST:2929,SCISSOR_TEST:3089,POLYGON_OFFSET_FILL:32823,SAMPLE_ALPHA_TO_COVERAGE:32926,SAMPLE_COVERAGE:32928,NO_ERROR:0,INVALID_ENUM:1280,INVALID_VALUE:1281,INVALID_OPERATION:1282,OUT_OF_MEMORY:1285,CW:2304,CCW:2305,LINE_WIDTH:2849,ALIASED_POINT_SIZE_RANGE:33901,ALIASED_LINE_WIDTH_RANGE:33902,CULL_FACE_MODE:2885,FRONT_FACE:2886,DEPTH_RANGE:2928,DEPTH_WRITEMASK:2930,DEPTH_CLEAR_VALUE:2931,DEPTH_FUNC:2932,STENCIL_CLEAR_VALUE:2961,STENCIL_FUNC:2962,STENCIL_FAIL:2964,STENCIL_PASS_DEPTH_FAIL:2965,STENCIL_PASS_DEPTH_PASS:2966,STENCIL_REF:2967,STENCIL_VALUE_MASK:2963,STENCIL_WRITEMASK:2968,STENCIL_BACK_FUNC:34816,STENCIL_BACK_FAIL:34817,STENCIL_BACK_PASS_DEPTH_FAIL:34818,STENCIL_BACK_PASS_DEPTH_PASS:34819,STENCIL_BACK_REF:36003,STENCIL_BACK_VALUE_MASK:36004,STENCIL_BACK_WRITEMASK:36005,VIEWPORT:2978,SCISSOR_BOX:3088,COLOR_CLEAR_VALUE:3106,COLOR_WRITEMASK:3107,UNPACK_ALIGNMENT:3317,PACK_ALIGNMENT:3333,MAX_TEXTURE_SIZE:3379,MAX_VIEWPORT_DIMS:3386,SUBPIXEL_BITS:3408,RED_BITS:3410,GREEN_BITS:3411,BLUE_BITS:3412,ALPHA_BITS:3413,DEPTH_BITS:3414,STENCIL_BITS:3415,POLYGON_OFFSET_UNITS:10752,POLYGON_OFFSET_FACTOR:32824,TEXTURE_BINDING_2D:32873,SAMPLE_BUFFERS:32936,SAMPLES:32937,SAMPLE_COVERAGE_VALUE:32938,SAMPLE_COVERAGE_INVERT:32939,COMPRESSED_TEXTURE_FORMATS:34467,DONT_CARE:4352,FASTEST:4353,NICEST:4354,GENERATE_MIPMAP_HINT:33170,BYTE:5120,UNSIGNED_BYTE:5121,SHORT:5122,UNSIGNED_SHORT:5123,INT:5124,UNSIGNED_INT:5125,FLOAT:5126,DEPTH_COMPONENT:6402,ALPHA:6406,RGB:6407,RGBA:6408,LUMINANCE:6409,LUMINANCE_ALPHA:6410,UNSIGNED_SHORT_4_4_4_4:32819,UNSIGNED_SHORT_5_5_5_1:32820,UNSIGNED_SHORT_5_6_5:33635,FRAGMENT_SHADER:35632,VERTEX_SHADER:35633,MAX_VERTEX_ATTRIBS:34921,MAX_VERTEX_UNIFORM_VECTORS:36347,MAX_VARYING_VECTORS:36348,MAX_COMBINED_TEXTURE_IMAGE_UNITS:35661,MAX_VERTEX_TEXTURE_IMAGE_UNITS:35660,MAX_TEXTURE_IMAGE_UNITS:34930,MAX_FRAGMENT_UNIFORM_VECTORS:36349,SHADER_TYPE:35663,DELETE_STATUS:35712,LINK_STATUS:35714,VALIDATE_STATUS:35715,ATTACHED_SHADERS:35717,ACTIVE_UNIFORMS:35718,ACTIVE_ATTRIBUTES:35721,SHADING_LANGUAGE_VERSION:35724,CURRENT_PROGRAM:35725,NEVER:512,LESS:513,EQUAL:514,LEQUAL:515,GREATER:516,NOTEQUAL:517,GEQUAL:518,ALWAYS:519,KEEP:7680,REPLACE:7681,INCR:7682,DECR:7683,INVERT:5386,INCR_WRAP:34055,DECR_WRAP:34056,VENDOR:7936,RENDERER:7937,VERSION:7938,NEAREST:9728,LINEAR:9729,NEAREST_MIPMAP_NEAREST:9984,LINEAR_MIPMAP_NEAREST:9985,NEAREST_MIPMAP_LINEAR:9986,LINEAR_MIPMAP_LINEAR:9987,TEXTURE_MAG_FILTER:10240,TEXTURE_MIN_FILTER:10241,TEXTURE_WRAP_S:10242,TEXTURE_WRAP_T:10243,TEXTURE_2D:3553,TEXTURE:5890,TEXTURE_CUBE_MAP:34067,TEXTURE_BINDING_CUBE_MAP:34068,TEXTURE_CUBE_MAP_POSITIVE_X:34069,TEXTURE_CUBE_MAP_NEGATIVE_X:34070,TEXTURE_CUBE_MAP_POSITIVE_Y:34071,TEXTURE_CUBE_MAP_NEGATIVE_Y:34072,TEXTURE_CUBE_MAP_POSITIVE_Z:34073,TEXTURE_CUBE_MAP_NEGATIVE_Z:34074,MAX_CUBE_MAP_TEXTURE_SIZE:34076,TEXTURE0:33984,TEXTURE1:33985,TEXTURE2:33986,TEXTURE3:33987,TEXTURE4:33988,TEXTURE5:33989,TEXTURE6:33990,TEXTURE7:33991,TEXTURE8:33992,TEXTURE9:33993,TEXTURE10:33994,TEXTURE11:33995,TEXTURE12:33996,TEXTURE13:33997,TEXTURE14:33998,TEXTURE15:33999,TEXTURE16:34e3,TEXTURE17:34001,TEXTURE18:34002,TEXTURE19:34003,TEXTURE20:34004,TEXTURE21:34005,TEXTURE22:34006,TEXTURE23:34007,TEXTURE24:34008,TEXTURE25:34009,TEXTURE26:34010,TEXTURE27:34011,TEXTURE28:34012,TEXTURE29:34013,TEXTURE30:34014,TEXTURE31:34015,ACTIVE_TEXTURE:34016,REPEAT:10497,CLAMP_TO_EDGE:33071,MIRRORED_REPEAT:33648,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,INT_VEC2:35667,INT_VEC3:35668,INT_VEC4:35669,BOOL:35670,BOOL_VEC2:35671,BOOL_VEC3:35672,BOOL_VEC4:35673,FLOAT_MAT2:35674,FLOAT_MAT3:35675,FLOAT_MAT4:35676,SAMPLER_2D:35678,SAMPLER_CUBE:35680,VERTEX_ATTRIB_ARRAY_ENABLED:34338,VERTEX_ATTRIB_ARRAY_SIZE:34339,VERTEX_ATTRIB_ARRAY_STRIDE:34340,VERTEX_ATTRIB_ARRAY_TYPE:34341,VERTEX_ATTRIB_ARRAY_NORMALIZED:34922,VERTEX_ATTRIB_ARRAY_POINTER:34373,VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:34975,COMPILE_STATUS:35713,LOW_FLOAT:36336,MEDIUM_FLOAT:36337,HIGH_FLOAT:36338,LOW_INT:36339,MEDIUM_INT:36340,HIGH_INT:36341,FRAMEBUFFER:36160,RENDERBUFFER:36161,RGBA4:32854,RGB5_A1:32855,RGB565:36194,DEPTH_COMPONENT16:33189,STENCIL_INDEX:6401,STENCIL_INDEX8:36168,DEPTH_STENCIL:34041,RENDERBUFFER_WIDTH:36162,RENDERBUFFER_HEIGHT:36163,RENDERBUFFER_INTERNAL_FORMAT:36164,RENDERBUFFER_RED_SIZE:36176,RENDERBUFFER_GREEN_SIZE:36177,RENDERBUFFER_BLUE_SIZE:36178,RENDERBUFFER_ALPHA_SIZE:36179,RENDERBUFFER_DEPTH_SIZE:36180,RENDERBUFFER_STENCIL_SIZE:36181,FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE:36048,FRAMEBUFFER_ATTACHMENT_OBJECT_NAME:36049,FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL:36050,FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE:36051,COLOR_ATTACHMENT0:36064,DEPTH_ATTACHMENT:36096,STENCIL_ATTACHMENT:36128,DEPTH_STENCIL_ATTACHMENT:33306,NONE:0,FRAMEBUFFER_COMPLETE:36053,FRAMEBUFFER_INCOMPLETE_ATTACHMENT:36054,FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:36055,FRAMEBUFFER_INCOMPLETE_DIMENSIONS:36057,FRAMEBUFFER_UNSUPPORTED:36061,FRAMEBUFFER_BINDING:36006,RENDERBUFFER_BINDING:36007,MAX_RENDERBUFFER_SIZE:34024,INVALID_FRAMEBUFFER_OPERATION:1286,UNPACK_FLIP_Y_WEBGL:37440,UNPACK_PREMULTIPLY_ALPHA_WEBGL:37441,CONTEXT_LOST_WEBGL:37442,UNPACK_COLORSPACE_CONVERSION_WEBGL:37443,BROWSER_DEFAULT_WEBGL:37444}}),d("Texture",["require","./core/Base","./core/util","./core/glenum","_"],function(a){var b=a("./core/Base"),c=a("./core/util"),d=a("./core/glenum");a("_");var e=b.derive(function(){return{__GUID__:c.genGUID(),width:512,height:512,type:d.UNSIGNED_BYTE,format:d.RGBA,wrapS:d.CLAMP_TO_EDGE,wrapT:d.CLAMP_TO_EDGE,minFilter:d.LINEAR_MIPMAP_LINEAR,magFilter:d.LINEAR,useMipmap:!0,anisotropic:1,flipY:!0,unpackAlignment:4,premultiplyAlpha:!1,dynamic:!1,NPOT:!1}},{getWebGLTexture:function(a){return this.cache.use(a.__GLID__),this.cache.miss("webgl_texture")&&this.cache.put("webgl_texture",a.createTexture()),this.dynamic?this.update(a):this.cache.isDirty()&&(this.update(a),this.cache.fresh()),this.cache.get("webgl_texture")},bind:function(){},unbind:function(){},dirty:function(){this.cache.dirtyAll()},update:function(){},beforeUpdate:function(a){a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,this.flipY),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.premultiplyAlpha),a.pixelStorei(a.UNPACK_ALIGNMENT,this.unpackAlignment),this.fallBack()},fallBack:function(){var a=this.isPowerOfTwo();this.format===d.DEPTH_COMPONENT&&(this.useMipmap=!1),a&&this.useMipmap?(this._minFilterOriginal&&(this.minFilter=this._minFilterOriginal),this._magFilterOriginal&&(this.magFilter=this._magFilterOriginal),this._wrapSOriginal&&(this.wrapS=this._wrapSOriginal),this._wrapTOriginal&&(this.wrapT=this._wrapTOriginal)):(this.NPOT=!0,this._minFilterOriginal=this.minFilter,this._magFilterOriginal=this.magFilter,this._wrapSOriginal=this.wrapS,this._wrapTOriginal=this.wrapT,this.minFilter==d.NEAREST_MIPMAP_NEAREST||this.minFilter==d.NEAREST_MIPMAP_LINEAR?this.minFilter=d.NEAREST:(this.minFilter==d.LINEAR_MIPMAP_LINEAR||this.minFilter==d.LINEAR_MIPMAP_NEAREST)&&(this.minFilter=d.LINEAR),this.wrapS=d.CLAMP_TO_EDGE,this.wrapT=d.CLAMP_TO_EDGE)},nextHighestPowerOfTwo:function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},dispose:function(a){this.cache.use(a.__GLID__),this.cache.get("webgl_texture")&&a.deleteTexture(this.cache.get("webgl_texture")),this.cache.deleteContext(a.__GLID__)},isRenderable:function(){},isPowerOfTwo:function(){}});return e.BYTE=d.BYTE,e.UNSIGNED_BYTE=d.UNSIGNED_BYTE,e.SHORT=d.SHORT,e.UNSIGNED_SHORT=d.UNSIGNED_SHORT,e.INT=d.INT,e.UNSIGNED_INT=d.UNSIGNED_INT,e.FLOAT=d.FLOAT,e.DEPTH_COMPONENT=d.DEPTH_COMPONENT,e.ALPHA=d.ALPHA,e.RGB=d.RGB,e.RGBA=d.RGBA,e.LUMINANCE=d.LUMINANCE,e.LUMINANCE_ALPHA=d.LUMINANCE_ALPHA,e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776,e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777,e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778,e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779,e.NEAREST=d.NEAREST,e.LINEAR=d.LINEAR,e.NEAREST_MIPMAP_NEAREST=d.NEAREST_MIPMAP_NEAREST,e.LINEAR_MIPMAP_NEAREST=d.LINEAR_MIPMAP_NEAREST,e.NEAREST_MIPMAP_LINEAR=d.NEAREST_MIPMAP_LINEAR,e.LINEAR_MIPMAP_LINEAR=d.LINEAR_MIPMAP_LINEAR,e.TEXTURE_MAG_FILTER=d.TEXTURE_MAG_FILTER,e.TEXTURE_MIN_FILTER=d.TEXTURE_MIN_FILTER,e.REPEAT=d.REPEAT,e.CLAMP_TO_EDGE=d.CLAMP_TO_EDGE,e.MIRRORED_REPEAT=d.MIRRORED_REPEAT,e}),d("core/glinfo",[],function(){var a=["OES_texture_float","OES_texture_half_float","OES_texture_float_linear","OES_texture_half_float_linear","OES_standard_derivatives","OES_vertex_array_object","OES_element_index_uint","WEBGL_compressed_texture_s3tc","WEBGL_depth_texture","EXT_texture_filter_anisotropic","WEBGL_draw_buffers"],b={},c={initialize:function(c){if(!b[c.__GLID__]){b[c.__GLID__]={};for(var d=0;d<a.length;d++){var e=a[d],f=c.getExtension(e);f||(f=c.getExtension("MOZ_"+e)),f||(f=c.getExtension("WEBKIT_"+e)),b[c.__GLID__][e]=f}}},getExtension:function(a,c){var d=a.__GLID__;return b[d]?b[d][c]:void 0}};return c}),d("texture/Texture2D",["require","../Texture","../core/glinfo"],function(a){var b=a("../Texture"),c=a("../core/glinfo"),d=b.derive(function(){return{image:null,pixels:null,mipmaps:[]}},{update:function(a){a.bindTexture(a.TEXTURE_2D,this.cache.get("webgl_texture")),this.beforeUpdate(a);var d=this.format,e=this.type;a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,this.wrapS),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,this.wrapT),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,this.magFilter),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,this.minFilter);var f=c.getExtension(a,"EXT_texture_filter_anisotropic");if(f&&this.anisotropic>1&&a.texParameterf(a.TEXTURE_2D,f.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic),this.image?a.texImage2D(a.TEXTURE_2D,0,d,d,e,this.image):d<=b.COMPRESSED_RGBA_S3TC_DXT5_EXT&&d>=b.COMPRESSED_RGB_S3TC_DXT1_EXT?a.compressedTexImage2D(a.TEXTURE_2D,0,d,this.width,this.height,0,this.pixels):a.texImage2D(a.TEXTURE_2D,0,d,this.width,this.height,0,d,e,this.pixels),this.useMipmap)if(this.mipmaps.length){if(this.image)for(var g=0;g<this.mipmaps.length;g++)this.mipmaps[g]&&a.texImage2D(a.TEXTURE_2D,g,d,d,e,this.mipmaps[g]);else if(this.pixels)for(var h=this.width,i=this.height,g=0;g<this.mipmaps.length;g++)this.mipmaps[g]&&(d<=b.COMPRESSED_RGBA_S3TC_DXT5_EXT&&d>=b.COMPRESSED_RGB_S3TC_DXT1_EXT?a.compressedTexImage2D(a.TEXTURE_2D,0,d,h,i,0,this.mipmaps[g]):a.texImage2D(a.TEXTURE_2D,g,d,h,i,0,d,e,this.mipmaps[g])),h/=2,i/=2}else this.NPOT||this.mipmaps.length||a.generateMipmap(a.TEXTURE_2D);a.bindTexture(a.TEXTURE_2D,null)},generateMipmap:function(a){a.bindTexture(a.TEXTURE_2D,this.cache.get("webgl_texture")),a.generateMipmap(a.TEXTURE_2D)},isPowerOfTwo:function(){if(this.image)var a=this.image.width,b=this.image.height;else var a=this.width,b=this.height;return 0===(a&a-1)&&0===(b&b-1)},isRenderable:function(){return this.image?"CANVAS"===this.image.nodeName||this.image.complete:this.width&&this.height},bind:function(a){a.bindTexture(a.TEXTURE_2D,this.getWebGLTexture(a))},unbind:function(a){a.bindTexture(a.TEXTURE_2D,null)},load:function(a){var b=new Image,c=this;b.onload=function(){c.dirty(),c.trigger("success",c),b.onload=null},b.onerror=function(){c.trigger("error",c),b.onerror=null},b.src=a,this.image=b}});return d}),d("texture/TextureCube",["require","../Texture","../core/glinfo","_"],function(a){function b(a){return"CANVAS"===a.nodeName||a.complete}var c=a("../Texture"),d=a("../core/glinfo"),e=a("_"),f={px:"TEXTURE_CUBE_MAP_POSITIVE_X",py:"TEXTURE_CUBE_MAP_POSITIVE_Y",pz:"TEXTURE_CUBE_MAP_POSITIVE_Z",nx:"TEXTURE_CUBE_MAP_NEGATIVE_X",ny:"TEXTURE_CUBE_MAP_NEGATIVE_Y",nz:"TEXTURE_CUBE_MAP_NEGATIVE_Z"},g=c.derive(function(){return{image:{px:null,nx:null,py:null,ny:null,pz:null,nz:null},pixels:{px:null,nx:null,py:null,ny:null,pz:null,nz:null}}},{update:function(a){a.bindTexture(a.TEXTURE_CUBE_MAP,this.cache.get("webgl_texture")),this.beforeUpdate(a);var b=this.format,c=this.type;a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,this.wrapS),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,this.wrapT),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,this.magFilter),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,this.minFilter);var e=d.getExtension(a,"EXT_texture_filter_anisotropic");e&&this.anisotropic>1&&a.texParameterf(a.TEXTURE_CUBE_MAP,e.TEXTURE_MAX_ANISOTROPY_EXT,this.anisotropic);for(var g in this.image){var h=this.image[g];h?a.texImage2D(a[f[g]],0,b,b,c,h):a.texImage2D(a[f[g]],0,b,this.width,this.height,0,b,c,this.pixels[g])}!this.NPOT&&this.useMipmap&&a.generateMipmap(a.TEXTURE_CUBE_MAP),a.bindTexture(a.TEXTURE_CUBE_MAP,null)},generateMipmap:function(a){a.bindTexture(a.TEXTURE_CUBE_MAP,this.cache.get("webgl_texture")),a.generateMipmap(a.TEXTURE_CUBE_MAP)},bind:function(a){a.bindTexture(a.TEXTURE_CUBE_MAP,this.getWebGLTexture(a))},unbind:function(a){a.bindTexture(a.TEXTURE_CUBE_MAP,null)},isPowerOfTwo:function(){function a(a){return a&0===a-1}return this.image.px?a(this.image.px.width)&&a(this.image.px.height):a(this.width)&&a(this.height)},isRenderable:function(){return this.image.px?b(this.image.px)&&b(this.image.nx)&&b(this.image.py)&&b(this.image.ny)&&b(this.image.pz)&&b(this.image.nz):this.width&&this.height},load:function(a){var b=0,c=this;e.each(a,function(a,d){var e=new Image;e.onload=function(){b--,0===b&&(c.dirty(),c.trigger("success",c)),e.onload=null},e.onerror=function(){b--,e.onerror=null},b++,e.src=a,c.image[d]=e})}});return g}),d("FrameBuffer",["require","./core/Base","./texture/Texture2D","./texture/TextureCube","./core/glinfo","./core/glenum"],function(a){var b=a("./core/Base");a("./texture/Texture2D");var c=a("./texture/TextureCube"),d=a("./core/glinfo"),e=a("./core/glenum"),f=b.derive(function(){return{depthBuffer:!0,_attachedTextures:{},_width:0,_height:0,_depthTextureAttached:!1,_renderBufferWidth:0,_renderBufferHeight:0}},{bind:function(a){var b=a.gl;if(b.bindFramebuffer(b.FRAMEBUFFER,this.getFrameBuffer(b)),this.cache.put("viewport",a.viewportInfo),a.setViewport(0,0,this._width,this._height),this.cache.miss("renderbuffer")&&this.depthBuffer&&!this._depthTextureAttached&&this.cache.put("renderbuffer",b.createRenderbuffer()),!this._depthTextureAttached&&this.depthBuffer){var c=this._width,d=this._height,e=this.cache.get("renderbuffer");(c!==this._renderBufferWidth||d!==this._renderBufferHeight)&&(b.bindRenderbuffer(b.RENDERBUFFER,e),b.renderbufferStorage(b.RENDERBUFFER,b.DEPTH_COMPONENT16,c,d),this._renderBufferWidth=c,this._renderBufferHeight=d,b.bindRenderbuffer(b.RENDERBUFFER,null)),this.cache.get("renderbuffer_attached")||(b.framebufferRenderbuffer(b.FRAMEBUFFER,b.DEPTH_ATTACHMENT,b.RENDERBUFFER,e),this.cache.put("renderbuffer_attached",!0))}},unbind:function(a){var b=a.gl;b.bindFramebuffer(b.FRAMEBUFFER,null),this.cache.use(b.__GLID__);var d=this.cache.get("viewport");d&&a.setViewport(d.x,d.y,d.width,d.height);for(var e in this._attachedTextures){var f=this._attachedTextures[e];if(!f.NPOT&&f.useMipmap){var g=f instanceof c?b.TEXTURE_CUBE_MAP:b.TEXTURE_2D;b.bindTexture(g,f.getWebGLTexture(b)),b.generateMipmap(g),b.bindTexture(g,null)}}},getFrameBuffer:function(a){return this.cache.use(a.__GLID__),this.cache.miss("framebuffer")&&this.cache.put("framebuffer",a.createFramebuffer()),this.cache.get("framebuffer")},attach:function(a,b,c,f,g){if(!b.width)throw new Error("The texture attached to color buffer is not a valid.");if(a.bindFramebuffer(a.FRAMEBUFFER,this.getFrameBuffer(a)),this._width=b.width,this._height=b.height,c=c||a.COLOR_ATTACHMENT0,f=f||a.TEXTURE_2D,g=g||0,c===a.DEPTH_ATTACHMENT){var h=d.getExtension(a,"WEBGL_depth_texture");if(!h)return console.error(" Depth texture is not supported by the browser "),void 0;if(b.format!==e.DEPTH_COMPONENT)return console.error("The texture attached to depth buffer is not a valid."),void 0;this.cache.put("renderbuffer_attached",!1),this._depthTextureAttached=!0}this._attachedTextures[c]=b,a.framebufferTexture2D(a.FRAMEBUFFER,c,f,b.getWebGLTexture(a),g),a.bindFramebuffer(a.FRAMEBUFFER,null)},detach:function(){},dispose:function(a){this.cache.use(a.__GLID__),this.cache.get("renderbuffer")&&a.deleteRenderbuffer(this.cache.get("renderbuffer")),this.cache.get("framebuffer")&&a.deleteFramebuffer(this.cache.get("framebuffer")),this.cache.deleteContext(a.__GLID__)}});return f.COLOR_ATTACHMENT0=e.COLOR_ATTACHMENT0,f.DEPTH_ATTACHMENT=e.DEPTH_ATTACHMENT,f.STENCIL_ATTACHMENT=e.STENCIL_ATTACHMENT,f.DEPTH_STENCIL_ATTACHMENT=e.DEPTH_STENCIL_ATTACHMENT,f}),d("Geometry",["require","./core/Base","./core/util","./math/Vector3","./math/BoundingBox","./core/glenum","glmatrix"],function(a){"use strict";function b(a,b,c,d,e){this.name=a,this.type=b,this.buffer=c,this.size=d,this.semantic=e,this.symbol=""}function c(a,b){this.buffer=a,this.count=b}var d=a("./core/Base"),e=a("./core/util");a("./math/Vector3");var f=a("./math/BoundingBox"),g=a("./core/glenum"),h=a("glmatrix"),i=h.vec3;h.vec2,h.mat2;var j=h.mat4,k=Array.prototype.slice,l=d.derive(function(){return{__GUID__:e.genGUID(),attributes:{position:{type:"float",semantic:"POSITION",size:3,value:[]},texcoord0:{type:"float",semantic:"TEXCOORD_0",size:2,value:[]},texcoord1:{type:"float",semantic:"TEXCOORD_1",size:2,value:[]},normal:{type:"float",semantic:"NORMAL",size:3,value:[]},tangent:{type:"float",semantic:"TANGENT",size:4,value:[]},color:{type:"ubyte",semantic:"COLOR",size:3,value:[]},weight:{type:"float",semantic:"WEIGHT",size:3,value:[]},joint:{type:"float",semantic:"JOINT",size:4,value:[]},barycentric:{type:"float",size:3,value:[]}},boundingBox:null,useFace:!0,faces:[],hint:g.STATIC_DRAW,chunkSize:65535,_enabledAttributes:null,_normalType:"vertex",_arrayChunks:[],_verticesReorganizedMap:[],_reorganizedFaces:[]}},{updateBoundingBox:function(){this.boundingBox||(this.boundingBox=new f),this.boundingBox.updateFromVertices(this.attributes.position.value)},dirty:function(a){if(a)this.cache.dirtyAll(a),this._enabledAttributes=null;else{this.dirty("indices");for(var b in this.attributes)this.dirty(b)}},getVerticesNumber:function(){return this.attributes.position.value.length},isUseFace:function(){return this.useFace&&this.faces.length>0},isSplitted:function(){return this.getVerticesNumber()>this.chunkSize},getEnabledAttributes:function(){if(this._enabledAttributes)return this._enabledAttributes;var a={},b=this.getVerticesNumber();for(var c in this.attributes){var d=this.attributes[c];d.value.length&&d.value.length===b&&(a[c]=d)}return this._enabledAttributes=a,a},_getDirtyAttributes:function(){var a=this.getEnabledAttributes(),b=!0;if(this.hint===g.STATIC_DRAW)return this.cache.miss("chunks")?a:null;var c={};for(var d in a)a[d],this.cache.isDirty(d)&&(c[d]=a[d],b=!1);return b?void 0:c},getChunkNumber:function(){return this._arrayChunks.length},getBufferChunks:function(a){this.cache.use(a.__GLID__);var b=this._getDirtyAttributes(),c=this.cache.isDirty("indices");if(c=c&&this.isUseFace(),b){this._updateAttributesAndIndicesArrays(b,c),this._updateBuffer(a,b,c);for(var d in b)this.cache.fresh(d);this.cache.fresh("indices")}return this.cache.get("chunks")},_updateAttributesAndIndicesArrays:function(a,b){var c=this,d={},e=this.getVerticesNumber(),f=this._verticesReorganizedMap,g={};for(var h in a){switch(K){case"byte":g[h]=Int8Array;break;case"ubyte":g[h]=Uint8Array;break;case"short":g[h]=Int16Array;break;case"ushort":g[h]=Uint16Array;break;default:g[h]=Float32Array}d[h]=0}var i=function(b){if(c._arrayChunks[b])return c._arrayChunks[b];var g={attributeArrays:{},indicesArray:null};for(var h in a)g.attributeArrays[h]=null;for(var h in d)d[h]=0;for(var i=0;e>i;i++)f[i]=-1;return c._arrayChunks.push(g),g},j=Object.keys(a);if(e>this.chunkSize&&this.isUseFace()){var k,l=0,m=0,n=[0],o=[];for(p=0;e>p;p++)o[p]=-1,f[p]=-1;if(b&&this._reorganizedFaces.length!==this.faces.length)for(p=0;p<this.faces.length;p++)this._reorganizedFaces[p]=[0,0,0];k=i(m);for(var p=0;p<this.faces.length;p++){var q=this.faces[p],r=this._reorganizedFaces[p],s=q[0],t=q[1],u=q[2];l+3>this.chunkSize&&(m++,n[m]=p,l=0,k=i(m));for(var v=-1===f[s],w=-1===f[t],x=-1===f[u],y=0;y<j.length;y++){var h=j[y],z=k.attributeArrays[h],A=a[h].value,B=a[h].size;if(z||(z=k.attributeArrays[h]=[]),1===B)v&&(z[d[h]++]=A[s]),w&&(z[d[h]++]=A[t]),x&&(z[d[h]++]=A[u]);else{if(v)for(var C=0;B>C;C++)z[d[h]++]=A[s][C];if(w)for(var C=0;B>C;C++)z[d[h]++]=A[t][C];if(x)for(var C=0;B>C;C++)z[d[h]++]=A[u][C]}}v?(f[s]=l,r[0]=l,l++):r[0]=f[s],w?(f[t]=l,r[1]=l,l++):r[1]=f[t],x?(f[u]=l,r[2]=l,l++):r[2]=f[u]}for(var D=0;D<this._arrayChunks.length;D++){var E=this._arrayChunks[D];for(var h in E.attributeArrays){var F=E.attributeArrays[h];F instanceof Array&&(E.attributeArrays[h]=new g[h](F))}}if(b)for(var G,H,I,E,D=0;D<this._arrayChunks.length;D++){G=n[D],H=n[D+1]||this.faces.length,I=0,E=this._arrayChunks[D];var J=E.indicesArray;J||(J=E.indicesArray=new Uint16Array(3*(H-G)));for(var p=G;H>p;p++)J[I++]=this._reorganizedFaces[p][0],J[I++]=this._reorganizedFaces[p][1],J[I++]=this._reorganizedFaces[p][2]}}else{var E=i(0);if(b){var J=E.indicesArray;J||(J=E.indicesArray=new Uint16Array(3*this.faces.length));for(var I=0,p=0;p<this.faces.length;p++)J[I++]=this.faces[p][0],J[I++]=this.faces[p][1],J[I++]=this.faces[p][2]}for(var h in a){var A=a[h].value,K=a[h].type,B=a[h].size,z=E.attributeArrays[h],L=e*B;if(z&&z.length===L||(z=new g[h](L),E.attributeArrays[h]=z),1===B)for(var p=0;p<A.length;p++)z[p]=A[p];else for(var I=0,p=0;p<A.length;p++)for(var C=0;B>C;C++)z[I++]=A[p][C]}}},_updateBuffer:function(a,d,e){var f=this.cache.get("chunks");if(!f){f=[];
for(var g=0;g<this._arrayChunks.length;g++)f[g]={attributeBuffers:[],indicesBuffer:null};this.cache.put("chunks",f)}for(var g=0;g<this._arrayChunks.length;g++){var h=f[g];h||(h=f[g]={attributeBuffers:[],indicesBuffer:null});var i=h.attributeBuffers,j=h.indicesBuffer,k=this._arrayChunks[g],l=k.attributeArrays,m=k.indicesArray,n=0;for(var o in d){var p,q=d[o],r=q.type,s=q.semantic,t=q.size,u=i[o];p=u?u.buffer:a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,p),a.bufferData(a.ARRAY_BUFFER,l[o],this.hint),i[n++]=new b(o,r,p,t,s)}i.length=n,e&&(j||(j=new c(a.createBuffer(),m.length),h.indicesBuffer=j),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,j.buffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,m,this.hint))}},generateVertexNormals:function(){var a=this.faces,b=a.length,c=this.attributes.position.value,d=this.attributes.normal.value,e=i.create(),f=i.create(),g=i.create();c.length-d.length;for(var h=0;h<d.length;h++)i.set(d[h],0,0,0);for(var h=d.length;h<c.length;h++)d[h]=[0,0,0];for(var j=0;b>j;j++){var k=a[j],l=k[0],m=k[1],n=k[2],o=c[l],p=c[m],q=c[n];i.sub(f,o,p),i.sub(g,p,q),i.cross(e,f,g),i.add(d[l],d[l],e),i.add(d[m],d[m],e),i.add(d[n],d[n],e)}for(var h=0;h<d.length;h++)i.normalize(d[h],d[h]);this._normalType="vertex"},generateFaceNormals:function(){this.isUniqueVertex()||this.generateUniqueVertex();for(var a=this.faces,b=a.length,c=this.attributes.position.value,d=this.attributes.normal.value,e=i.create(),f=i.create(),g=i.create(),h=d.length===c.length,j=0;b>j;j++){var l=a[j],m=l[0],n=l[1],o=l[2],p=c[m],q=c[n],r=c[o];i.sub(f,p,q),i.sub(g,q,r),i.cross(e,f,g),h?(i.copy(d[m],e),i.copy(d[n],e),i.copy(d[o],e)):d[m]=d[n]=d[o]=k.call(e)}this._normalType="face"},generateTangents:function(){for(var a=this.attributes.texcoord0.value,b=this.attributes.position.value,c=this.attributes.tangent.value,d=this.attributes.normal.value,e=[],f=[],g=this.getVerticesNumber(),h=0;g>h;h++)e[h]=[0,0,0],f[h]=[0,0,0];for(var j=[0,0,0],k=[0,0,0],h=0;h<this.faces.length;h++){var l=this.faces[h],m=l[0],n=l[1],o=l[2],p=a[m],q=a[n],r=a[o],s=b[m],t=b[n],u=b[o],v=t[0]-s[0],w=u[0]-s[0],x=t[1]-s[1],y=u[1]-s[1],z=t[2]-s[2],A=u[2]-s[2],B=q[0]-p[0],C=r[0]-p[0],D=q[1]-p[1],E=r[1]-p[1],F=1/(B*E-D*C);j[0]=(E*v-D*w)*F,j[1]=(E*x-D*y)*F,j[2]=(E*z-D*A)*F,k[0]=(B*w-C*v)*F,k[1]=(B*y-C*x)*F,k[2]=(B*A-C*z)*F,i.add(e[m],e[m],j),i.add(e[n],e[n],j),i.add(e[o],e[o],j),i.add(f[m],f[m],k),i.add(f[n],f[n],k),i.add(f[o],f[o],k)}for(var G=[0,0,0,0],H=[0,0,0],h=0;g>h;h++){var I=d[h],J=e[h];i.scale(G,I,i.dot(I,J)),i.sub(G,J,G),i.normalize(G,G),i.cross(H,I,J),G[3]=i.dot(H,f[h])<0?-1:1,c[h]=G.slice()}},isUniqueVertex:function(){return this.isUseFace()?this.getVerticesNumber()===3*this.faces.length:!0},generateUniqueVertex:function(){function a(a){for(var b in e){var c=e[b].value,d=c[0].length||1;1===d?c.push(c[a]):c.push(k.call(c[a]))}}for(var b=[],c=0;c<this.getVerticesNumber();c++)b[c]=0;for(var d=this.getVerticesNumber(),e=this.getEnabledAttributes(),f=this.faces,c=0;c<f.length;c++){var g=f[c],h=g[0],i=g[1],j=g[2];b[h]>0&&(a(h),g[0]=d,d++),b[i]>0&&(a(i),g[1]=d,d++),b[j]>0&&(a(j),g[2]=d,d++),b[h]++,b[i]++,b[j]++}this.dirty()},generateBarycentric:function(){var a=[1,0,0],b=[0,0,1],c=[0,1,0];return function(){this.isUniqueVertex()||this.generateUniqueVertex();var d=this.attributes.barycentric.value;if(d.length!=3*this.faces.length)for(var e,f,g,h,i=0;i<this.faces.length;i++)h=this.faces[i],e=h[0],f=h[1],g=h[2],d[e]=a,d[f]=b,d[g]=c}}(),applyTransform:function(a){var b=this.attributes.position.value,c=this.attributes.normal.value;a=a._array;for(var d=0;d<b.length;d++)i.transformMat4(b[d],b[d],a);var e=j.create();j.invert(e,a),j.transpose(e,e);for(var d=0;d<c.length;d++)i.transformMat4(c[d],c[d],e)},dispose:function(a){this.cache.use(a.__GLID__);var b=this.cache.get("chunks");if(b)for(var c=0;c<b.length;c++){var d=b[c];for(var e in d.attributeBuffers){var f=d.attributeBuffers[e];a.deleteBuffer(f.buffer)}}this.cache.deleteContext(a.__GLID__)}});return l.STATIC_DRAW=g.STATIC_DRAW,l.DYNAMIC_DRAW=g.DYNAMIC_DRAW,l.STREAM_DRAW=g.STREAM_DRAW,l}),d("Joint",["require","./Node","./math/Quaternion","./math/Vector3","./math/Matrix4"],function(a){var b=a("./Node");a("./math/Quaternion"),a("./math/Vector3"),a("./math/Matrix4");var c=b.derive(function(){return{index:-1,parentIndex:-1,poses:[],_cacheKey:0,_cacheTime:0}},{setPose:function(a){this._interpolateField(a,"position"),this._interpolateField(a,"rotation"),this._interpolateField(a,"scale")},_interpolateField:function(a,b){var c,d,e=this.poses,f=e.length;if(a<this._cacheTime){for(var g=this._cacheKey>=f-1?f-1:this._cacheKey+1,h=g;h>=0;h--)if(e[h].time<=a&&e[h][b])c=e[h],this._cacheKey=h,this._cacheTime=a;else if(e[h][b]){d=e[h];break}}else for(var h=this._cacheKey;f>h;h++)if(e[h].time<=a&&e[h][b])c=e[h],this._cacheKey=h,this._cacheTime=a;else if(e[h][b]){d=e[h];break}if(c&&d){var i=(a-c.time)/(d.time-c.time);i=Math.max(Math.min(i,1),0),"rotation"===b?this[b].slerp(c[b],d[b],i):this[b].lerp(c[b],d[b],i)}else this._cacheKey=0,this._cacheTime=0}});return c}),d("Layer",["require","./core/Base"],function(a){var b=a("./core/Base"),c=b.derive(function(){return{renderer:null,scene:null,camera:null,picking:null}},{render:function(){this.picking&&this.picking.update(this.scene,this.camera),this.renderer.render(this.scene,this.camera)},setPicking:function(a){this.picking=a,this.renderer&&a.resize(this.renderer.width,this.renderer.height)},resize:function(a,b){this.renderer&&this.renderer.resize(a,b),this.picking&&this.picking.resize(a,b)},setZ:function(a){this.z=a,this.renderer.canvas.style.zIndex=a},pick:function(a,b){return this.picking?this.picking.pick(a,b):void 0}});return c}),d("Shader",["require","./core/Base","./core/util","glmatrix","_"],function(a){function b(){return{locations:{},attriblocations:{}}}function c(a){for(var b=a.split("\n"),c=0,d=b.length;d>c;c++)b[c]=c+1+": "+b[c];return b.join("\n")}var d=a("./core/Base"),e=a("./core/util"),f=a("glmatrix"),g=a("_"),h=f.mat2,i=f.mat3,j=f.mat4,k=/uniform\s+(bool|float|int|vec2|vec3|vec4|ivec2|ivec3|ivec4|mat2|mat3|mat4|sampler2D|samplerCube)\s+([\w\,]+)?(\[.*?\])?\s*(:\s*([\S\s]+?))?;/g,l=/attribute\s+(float|int|vec2|vec3|vec4)\s+(\w*)\s*(:\s*(\w+))?;/g,m=/#define\s+(\w+)?(\s+[\w-.]+)?\s*\n/g,n={bool:"1i","int":"1i",sampler2D:"t",samplerCube:"t","float":"1f",vec2:"2f",vec3:"3f",vec4:"4f",ivec2:"2i",ivec3:"3i",ivec4:"4i",mat2:"m2",mat3:"m3",mat4:"m4"},o={bool:function(){return!0},"int":function(){return 0},"float":function(){return 0},sampler2D:function(){return null},samplerCube:function(){return null},vec2:function(){return[0,0]},vec3:function(){return[0,0,0]},vec4:function(){return[0,0,0,0]},ivec2:function(){return[0,0]},ivec3:function(){return[0,0,0]},ivec4:function(){return[0,0,0,0]},mat2:function(){return h.create()},mat3:function(){return i.create()},mat4:function(){return j.create()},array:function(){return[]}},p=["POSITION","NORMAL","BINORMAL","TANGENT","TEXCOORD","TEXCOORD_0","TEXCOORD_1","COLOR","JOINT","WEIGHT","INV_BIND_MATRIX"],q=["WORLD","VIEW","PROJECTION","WORLDVIEW","VIEWPROJECTION","WORLDVIEWPROJECTION","WORLDINVERSE","VIEWINVERSE","PROJECTIONINVERSE","WORLDVIEWINVERSE","VIEWPROJECTIONINVERSE","WORLDVIEWPROJECTIONINVERSE","WORLDTRANSPOSE","VIEWTRANSPOSE","PROJECTIONTRANSPOSE","WORLDVIEWTRANSPOSE","VIEWPROJECTIONTRANSPOSE","WORLDVIEWPROJECTIONTRANSPOSE","WORLDINVERSETRANSPOSE","VIEWINVERSETRANSPOSE","PROJECTIONINVERSETRANSPOSE","WORLDVIEWINVERSETRANSPOSE","VIEWPROJECTIONINVERSETRANSPOSE","WORLDVIEWPROJECTIONINVERSETRANSPOSE"],r={},s={},t=d.derive(function(){return{__GUID__:e.genGUID(),vertex:"",fragment:"",precision:"mediump",attribSemantics:{},matrixSemantics:{},matrixSemanticKeys:[],uniformTemplates:{},attributeTemplates:{},vertexDefines:{},fragmentDefines:{},lightNumber:{},_uniformList:[],_textureStatus:{},_vertexProcessed:"",_fragmentProcessed:""}},function(){this._updateShaderString()},{setVertex:function(a){this.vertex=a,this._updateShaderString(),this.dirty()},setFragment:function(a){this.fragment=a,this._updateShaderString(),this.dirty()},bind:function(a){this.cache.use(a.__GLID__,b),this.cache.isDirty()&&(this._updateShaderString(),this._buildProgram(a,this._vertexProcessed,this._fragmentProcessed),this.cache.fresh()),a.useProgram(this.cache.get("program"))},dirty:function(){this.cache.dirty();for(var a=0;a<this.cache._caches.length;a++)if(this.cache._caches[a]){var b=this.cache._caches[a];b.locations={},b.attriblocations={}}},_updateShaderString:function(){(this.vertex!==this._vertexPrev||this.fragment!==this._fragmentPrev)&&(this._parseImport(),this.attribSemantics={},this.matrixSemantics={},this._textureStatus={},this._parseUniforms(),this._parseAttributes(),this._parseDefines(),this._vertexPrev=this.vertex,this._fragmentPrev=this.fragment),this._addDefine()},define:function(a,b,c){c=c||null,("vertex"==a||"both"==a)&&this.vertexDefines[b]!==c&&(this.vertexDefines[b]=c,this.dirty()),("fragment"==a||"both"==a)&&this.fragmentDefines[b]!==c&&(this.fragmentDefines[b]=c,this.dirty())},unDefine:function(a,b){switch(a){case"vertex":this.isDefined("vertex",b)&&(delete this.vertexDefines[b],this.dirty());break;case"fragment":this.isDefined("fragment",b)&&(delete this.fragmentDefines[b],this.dirty());break;default:throw new Error("Undefine type must be vertex or fragment")}},isDefined:function(a,b){switch(a){case"vertex":return void 0!==this.vertexDefines[b];case"fragment":return void 0!==this.fragmentDefines[b]}},getDefine:function(a,b){switch(a){case"vertex":return this.vertexDefines[b];case"fragment":return this.fragmentDefines[b]}},enableTexture:function(a){var b=this._textureStatus[a];if(b){var c=b.enabled;if(c)return;b.enabled=!0,this.dirty()}},enableTexturesAll:function(){for(var a in this._textureStatus)this._textureStatus[a].enabled=!0;this.dirty()},disableTexture:function(a){var b=this._textureStatus[a];if(b){var c=!b.enabled;if(c)return;b.enabled=!1,this.dirty()}},disableTexturesAll:function(a){for(var a in this._textureStatus)this._textureStatus[a].enabled=!1;this.dirty()},isTextureEnabled:function(a){return this._textureStatus[a].enabled},setUniform:function(a,b,c,d){var e=this.cache.get("locations"),f=e[c];if(null!==f&&void 0!==f)switch(b){case"m4":a.uniformMatrix4fv(f,!1,d);break;case"2i":a.uniform2i(f,d[0],d[1]);break;case"2f":a.uniform2f(f,d[0],d[1]);break;case"3i":a.uniform3i(f,d[0],d[1],d[2]);break;case"3f":a.uniform3f(f,d[0],d[1],d[2]);break;case"4i":a.uniform4i(f,d[0],d[1],d[2],d[3]);break;case"4f":a.uniform4f(f,d[0],d[1],d[2],d[3]);break;case"1i":a.uniform1i(f,d);break;case"1f":a.uniform1f(f,d);break;case"1fv":a.uniform1fv(f,d);break;case"1iv":a.uniform1iv(f,d);break;case"2iv":a.uniform2iv(f,d);break;case"2fv":a.uniform2fv(f,d);break;case"3iv":a.uniform3iv(f,d);break;case"3fv":a.uniform3fv(f,d);break;case"4iv":a.uniform4iv(f,d);break;case"4fv":a.uniform4fv(f,d);break;case"m2":a.uniformMatrix2fv(f,!1,d);break;case"m3":a.uniformMatrix3fv(f,!1,d);break;case"m2v":var g=4;case"m3v":var g=9;case"m4v":var g=16;if(d instanceof Array){for(var h=new Float32Array(d.length*g),i=0,j=0;j<d.length;j++)for(var k=d[j],l=0;l<k.length;l++)h[i++]=k[l];a.uniformMatrix4fv(f,!1,h)}else d instanceof Float32Array&&a.uniformMatrix4fv(f,!1,d)}},setUniformBySemantic:function(a,b,c){var d=this.attribSemantics[b];return d?this.setUniform(a,d.type,d.symbol,c):!1},enableAttributes:function(a,b){var c=this.cache.get("program"),d=this.cache.get("attriblocations");"string"==typeof b&&(b=Array.prototype.slice.call(arguments,1));var e=s[a.__GLID__];e||(e=s[a.__GLID__]=[]);for(var f=[],g=0;g<b.length;g++){var h=b[g];if(this.attributeTemplates[h]){var i=d[h];if(void 0===i){if(i=a.getAttribLocation(c,h),-1===i){f[g]=-1;continue}d[h]=i}f[g]=i,e[i]=e[i]?3:2}else f[g]=-1}for(var g=0;g<e.length;g++)switch(e[g]){case 2:a.enableVertexAttribArray(g),e[g]=1;break;case 3:e[g]=1;break;case 1:a.disableVertexAttribArray(g),e[g]=0}return f},_parseImport:function(){this._vertexProcessedWithoutDefine=t.parseImport(this.vertex),this._fragmentProcessedWithoutDefine=t.parseImport(this.fragment)},_addDefine:function(){var a=[];for(var b in this.lightNumber){var c=this.lightNumber[b];c>0&&a.push("#define "+b.toUpperCase()+"_NUMBER "+c)}for(var d in this._textureStatus){var e=this._textureStatus[d];e.enabled&&"vertex"===e.shaderType&&a.push("#define "+d.toUpperCase()+"_ENABLED")}for(var d in this.vertexDefines){var f=this.vertexDefines[d];null===f?a.push("#define "+d):a.push("#define "+d+" "+f.toString())}this._vertexProcessed=a.join("\n")+"\n"+this._vertexProcessedWithoutDefine,a=[];for(var b in this.lightNumber){var c=this.lightNumber[b];c>0&&a.push("#define "+b.toUpperCase()+"_NUMBER "+c)}for(var d in this._textureStatus){var e=this._textureStatus[d];e.enabled&&"fragment"===e.shaderType&&a.push("#define "+d.toUpperCase()+"_ENABLED")}for(var d in this.fragmentDefines){var f=this.fragmentDefines[d];null===f?a.push("#define "+d):a.push("#define "+d+" "+f.toString())}var g=a.join("\n")+"\n"+this._fragmentProcessedWithoutDefine;this._fragmentProcessed=["precision",this.precision,"float"].join(" ")+";\n"+g},_parseUniforms:function(){function a(a,e,f,g,h,i){if(e&&f){var j=n[e],k=!0;if(j){if(c._uniformList.push(f),("sampler2D"===e||"samplerCube"===e)&&(c._textureStatus[f]={enabled:!1,shaderType:d}),g&&(j+="v"),i)if(p.indexOf(i)>=0)c.attribSemantics[i]={symbol:f,type:j},k=!1;else if(q.indexOf(i)>=0){var l=!1,m=i;i.match(/TRANSPOSE$/)&&(l=!0,m=i.slice(0,-9)),c.matrixSemantics[i]={symbol:f,type:j,isTranspose:l,semanticNoTranspose:m},k=!1}else if("unconfigurable"===i)k=!1;else{var r=c._parseDefaultValue(e,i);if(!r)throw new Error('Unkown semantic "'+i+'"');i=""}k&&(b[f]={type:j,value:g?o.array:r||o[e],semantic:i||null})}return["uniform",e,f,g].join(" ")+";\n"}}var b={},c=this,d="vertex";this._uniformList=[],this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(k,a),d="fragment",this._fragmentProcessedWithoutDefine=this._fragmentProcessedWithoutDefine.replace(k,a),c.matrixSemanticKeys=Object.keys(this.matrixSemantics),this.uniformTemplates=b},_parseDefaultValue:function(a,b){var c=/\[\s*(.*)\s*\]/;{if("vec2"!==a&&"vec3"!==a&&"vec4"!==a)return"bool"===a?function(){return"true"===b.toLowerCase()?!0:!1}:"float"===a?function(){return parseFloat(b)}:void 0;var d=c.exec(b)[1];if(d){var e=d.split(/\s*,\s*/);return function(){return new Float32Array(e)}}}},createUniforms:function(){var a={};for(var b in this.uniformTemplates){var c=this.uniformTemplates[b];a[b]={type:c.type,value:c.value()}}return a},_parseAttributes:function(){function a(a,d,e,f,g){if(d&&e){var h=1;switch(d){case"vec4":h=4;break;case"vec3":h=3;break;case"vec2":h=2;break;case"float":h=1}if(b[e]={type:"float",size:h,semantic:g||null},g){if(p.indexOf(g)<0)throw new Error('Unkown semantic "'+g+'"');c.attribSemantics[g]={symbol:e,type:d}}}return["attribute",d,e].join(" ")+";\n"}var b={},c=this;this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(l,a),this.attributeTemplates=b},_parseDefines:function(){function a(a,d,e){var f="vertex"===c?b.vertexDefines:b.fragmentDefines;return f[d]||(f[d]=e?parseFloat(e):null),""}var b=this,c="vertex";this._vertexProcessedWithoutDefine=this._vertexProcessedWithoutDefine.replace(m,a),c="fragment",this._fragmentProcessedWithoutDefine=this._fragmentProcessedWithoutDefine.replace(m,a)},_buildProgram:function(a,b,c){this.cache.get("program")&&a.deleteProgram(this.cache.get("program"));var d=a.createProgram();try{var e=this._compileShader(a,"vertex",b),f=this._compileShader(a,"fragment",c);if(a.attachShader(d,e),a.attachShader(d,f),this.attribSemantics.POSITION&&a.bindAttribLocation(d,0,this.attribSemantics.POSITION.symbol),a.linkProgram(d),!a.getProgramParameter(d,a.LINK_STATUS))throw new Error("Could not initialize shader\nVALIDATE_STATUS: "+a.getProgramParameter(d,a.VALIDATE_STATUS)+", gl error ["+a.getError()+"]");for(var g=0;g<this._uniformList.length;g++){var h=this._uniformList[g],i=this.cache.get("locations");i[h]=a.getUniformLocation(d,h)}}catch(j){if(r[this.__GUID__])return;throw r[this.__GUID__]=this,j}a.deleteShader(e),a.deleteShader(f),this.cache.put("program",d)},_compileShader:function(a,b,d){var e=a.createShader("fragment"===b?a.FRAGMENT_SHADER:a.VERTEX_SHADER);if(a.shaderSource(e,d),a.compileShader(e),!a.getShaderParameter(e,a.COMPILE_STATUS))throw new Error([a.getShaderInfoLog(e),c(d)].join("\n"));return e},clone:function(){var a=new t({vertex:this.vertex,fragment:this.fragment,vertexDefines:g.clone(this.vertexDefines),fragmentDefines:g.clone(this.fragmentDefines)});for(var b in this._textureStatus)a._textureStatus[b]=g.clone(this._textureStatus[b]);return a},dispose:function(a){if(this.cache.use(a.__GLID__),b)var b=this.cache.get("program");a.deleteProgram(b),this.cache.deleteContext(a.__GLID__),this._locations={}}}),u=/(@import)\s*([0-9a-zA-Z_\-\.]*)/g;t.parseImport=function(a){return a=a.replace(u,function(a,b,c){return w[c]?t.parseImport(w[c]):void 0})};var v=/(@export)\s*([0-9a-zA-Z_\-\.]*)\s*\n([\s\S]*?)@end/g;t.import=function(a){a.replace(v,function(a,b,c,d){return w[c]=d,d})};var w={};return t.source=function(a){var b=w[a];return b?b:(console.warn('Shader "'+a+'" not existed in library'),void 0)},t}),d("light/light.essl",[],function(){return"@export buildin.header.directional_light\nuniform vec3 directionalLightDirection[ DIRECTIONAL_LIGHT_NUMBER ] : unconfigurable;\nuniform vec3 directionalLightColor[ DIRECTIONAL_LIGHT_NUMBER ] : unconfigurable;\n@end\n\n@export buildin.header.ambient_light\nuniform vec3 ambientLightColor[ AMBIENT_LIGHT_NUMBER ] : unconfigurable;\n@end\n\n@export buildin.header.point_light\nuniform vec3 pointLightPosition[ POINT_LIGHT_NUMBER ] : unconfigurable;\nuniform float pointLightRange[ POINT_LIGHT_NUMBER ] : unconfigurable;\nuniform vec3 pointLightColor[ POINT_LIGHT_NUMBER ] : unconfigurable;\n@end\n\n@export buildin.header.spot_light\nuniform vec3 spotLightPosition[SPOT_LIGHT_NUMBER] : unconfigurable;\nuniform vec3 spotLightDirection[SPOT_LIGHT_NUMBER] : unconfigurable;\nuniform float spotLightRange[SPOT_LIGHT_NUMBER] : unconfigurable;\nuniform float spotLightUmbraAngleCosine[SPOT_LIGHT_NUMBER] : unconfigurable;\nuniform float spotLightPenumbraAngleCosine[SPOT_LIGHT_NUMBER] : unconfigurable;\nuniform float spotLightFalloffFactor[SPOT_LIGHT_NUMBER] : unconfigurable;\nuniform vec3 spotLightColor[SPOT_LIGHT_NUMBER] : unconfigurable;\n@end"}),d("Light",["require","./Node","./Shader","./light/light.essl"],function(a){var b=a("./Node"),c=a("./Shader"),d=b.derive(function(){return{color:[1,1,1],intensity:1,castShadow:!0,shadowResolution:512}},{});return c.import(a("./light/light.essl")),d}),d("Material",["require","./core/Base","./Shader","./core/util","./core/glenum","./Texture","./texture/Texture2D","./texture/TextureCube"],function(a){var b=a("./core/Base");a("./Shader");var c=a("./core/util");a("./core/glenum");var d=a("./Texture");a("./texture/Texture2D"),a("./texture/TextureCube"),_repository=[];var e=b.derive(function(){var a=c.genGUID();return{__GUID__:a,name:"MATERIAL_"+a,uniforms:{},shader:null,depthTest:!0,depthMask:!0,transparent:!1,blend:null,_enabledUniforms:[]}},function(){this.shader&&this.attachShader(this.shader),_repository.push(this)},{bind:function(a){for(var b=0,c=0;c<this._enabledUniforms.length;c++){var e=this._enabledUniforms[c],f=this.uniforms[e];if(!(null===f.value||f.value instanceof Array&&!f.value.length))if(f.value instanceof d){var g=f.value;a.activeTexture(a.TEXTURE0+b),g.isRenderable()?g.bind(a):g.unbind(a),this.shader.setUniform(a,"1i",e,b),b++}else if(f.value instanceof Array){var h=f.value[0];if(h instanceof d){for(var i=[],j=0;j<f.value.length;j++){var g=f.value[j];a.activeTexture(a.TEXTURE0+b),g.isRenderable()?g.bind(a):g.unbind(a),i.push(b++)}this.shader.setUniform(a,"1iv",e,i)}else this.shader.setUniform(a,f.type,e,f.value)}else this.shader.setUniform(a,f.type,e,f.value)}},setUniform:function(a,b){var c=this.uniforms[a];c&&(c.value=b)},setUniforms:function(a){for(var b in a){var c=a[b];this.setUniform(b,c)}},enableUniform:function(a){this.uniforms[a]&&!this.isUniformEnabled(a)&&this._enabledUniforms.push(a)},disableUniform:function(a){var b=this._enabledUniforms.indexOf(a);b>=0&&this._enabledUniforms.splice(b,1)},isUniformEnabled:function(a){return this._enabledUniforms.indexOf(a)>=0},set:function(a,b){if("object"==typeof a)for(var c in a){var d=a[c];this.set(c,d)}else{var e=this.uniforms[a];e&&(e.value=b)}},get:function(a){var b=this.uniforms[a];return b?b.value:void 0},attachShader:function(a,b){var c=this.uniforms;if(this.uniforms=a.createUniforms(),this.shader=a,this._enabledUniforms=Object.keys(this.uniforms),b)for(var d in c)this.uniforms[d]&&(this.uniforms[d].value=c[d].value)},detachShader:function(){this.shader=null,this.uniforms={}},dispose:function(){_repository.splice(_repository.indexOf(this),1)}});return e.getMaterial=function(a){for(var b=0;b<_repository.length;b++)if(_repository[b].name===a)return _repository[b]},e}),d("Mesh",["require","./Node","./core/glenum","./math/Vector3"],function(a){function b(a,b,c){this.availableAttributes=a,this.availableAttributeSymbols=b,this.indicesBuffer=c}var c=a("./Node"),d=a("./core/glenum");a("./math/Vector3");var e,f,g=0,h=null,i=!0,j={faceNumber:0,vertexNumber:0,drawCallNumber:0},k=c.derive(function(){return{material:null,geometry:null,mode:d.TRIANGLES,skeleton:null,joints:[],_drawCache:{}}},{lineWidth:1,culling:!0,cullFace:d.BACK,frontFace:d.CCW,frustumCulling:!0,receiveShadow:!0,castShadow:!0,isRenderable:function(){return this.geometry&&this.material&&this.material.shader},render:function(a,c){var k=c||this.material,l=k.shader,m=this.geometry,n=this.mode;if(this.skeleton){var o=this.skeleton.getSubInvBindMatrices(this.__GUID__,this.joints);l.setUniformBySemantic(a,"INV_BIND_MATRIX",o)}var p=m.getVerticesNumber();if(j.vertexNumber=p,j.faceNumber=0,j.drawCallNumber=0,e=!1,p>m.chunkSize?e=!0:(f=a.__GLID__+"-"+m.__GUID__+"-"+l.__GUID__,f!==g&&(e=!0,g=f)),e){var q=this._drawCache[f];if(!q){var r=m.getBufferChunks(a);if(!r)return;q=[];for(var s=0;s<r.length;s++){for(var t=r[s],u=t.attributeBuffers,v=t.indicesBuffer,w=[],x=[],y=0;y<u.length;y++){var z=u[y],A=z.name,B=z.semantic;if(B)var C=l.attribSemantics[B],D=C&&C.symbol;else var D=A;D&&l.attributeTemplates[D]&&(w.push(z),x.push(D))}var E=new b(w,x,v);q.push(E)}m.hint===d.STATIC_DRAW&&(this._drawCache[f]=q)}for(var F=0;F<q.length;F++){for(var E=q[F],w=E.availableAttributes,x=E.availableAttributeSymbols,v=E.indicesBuffer,G=l.enableAttributes(a,x),y=0;y<w.length;y++){var H=G[y];if(-1!==H){var I,z=w[y],J=z.buffer,D=x[y],K=z.size;switch(z.type){case"float":I=a.FLOAT;break;case"byte":I=a.BYTE;break;case"ubyte":I=a.UNSIGNED_BYTE;break;case"short":I=a.SHORT;break;case"ushort":I=a.UNSIGNED_SHORT;break;default:I=a.FLOAT}a.bindBuffer(a.ARRAY_BUFFER,J),a.vertexAttribPointer(H,K,I,!1,0,0)}}n===d.LINES&&a.lineWidth(this.lineWidth),i=m.isUseFace(),h=v,i?(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,v.buffer),a.drawElements(n,v.count,a.UNSIGNED_SHORT,0),j.faceNumber+=v.count/3):a.drawArrays(n,0,p),j.drawCallNumber++}}else i?(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,h.buffer),a.drawElements(n,h.count,a.UNSIGNED_SHORT,0),j.faceNumber=h.count/3):a.drawArrays(n,0,p),j.drawCallNumber=1;return j}});return k.POINTS=d.POINTS,k.LINES=d.LINES,k.LINE_LOOP=d.LINE_LOOP,k.LINE_STRIP=d.LINE_STRIP,k.TRIANGLES=d.TRIANGLES,k.TRIANGLE_STRIP=d.TRIANGLE_STRIP,k.TRIANGLE_FAN=d.TRIANGLE_FAN,k.BACK=d.BACK,k.FRONT=d.FRONT,k.FRONT_AND_BACK=d.FRONT_AND_BACK,k.CW=d.CW,k.CCW=d.CCW,k}),d("shader/source/basic.essl",[],function(){return"@export buildin.basic.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nuniform vec2 uvRepeat : [1.0, 1.0];\n\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 position : POSITION;\n\nattribute vec3 barycentric;\n\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n\nuniform mat4 invBindMatrix[JOINT_NUMBER] : INV_BIND_MATRIX;\n#endif\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_Barycentric;\n\nvoid main()\n{\n\n    vec3 skinnedPosition = position;\n\n    #ifdef SKINNING\n        \n        @import buildin.chunk.skin_matrix\n        \n        skinnedPosition = (skinMatrix * vec4(position, 1.0)).xyz;\n    #endif\n\n    v_Texcoord = texcoord * uvRepeat;\n    v_Barycentric = barycentric;\n\n    gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n}\n\n@end\n\n\n\n\n@export buildin.basic.fragment\n\nvarying vec2 v_Texcoord;\nuniform sampler2D diffuseMap;\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform vec3 emission : [0.0, 0.0, 0.0];\nuniform float alpha : 1.0;\n\n// Uniforms for wireframe\nuniform float lineWidth : 0.0;\nuniform vec3 lineColor : [0.0, 0.0, 0.0];\nvarying vec3 v_Barycentric;\n\n#extension GL_OES_standard_derivatives : enable\n@import buildin.util.edge_factor\n\nvoid main()\n{\n\n    gl_FragColor = vec4(color, alpha);\n    \n    #ifdef DIFFUSEMAP_ENABLED\n        vec4 tex = texture2D( diffuseMap, v_Texcoord );\n\n        #ifdef SRGB_DECODE\n            tex.rgb = pow(tex.rgb, vec3(2.2));\n        #endif\n        \n        #if defined(DIFFUSEMAP_USE_ALPHA)\n            gl_FragColor.a = tex.a;\n        #endif\n\n        gl_FragColor.rgb *= tex.rgb;\n    #endif\n\n    gl_FragColor.rgb += emission;\n    if( lineWidth > 0.01)\n    {\n        gl_FragColor.rgb = gl_FragColor.rgb * mix(lineColor, vec3(1.0), edgeFactor(lineWidth));\n    }\n}\n\n@end"}),d("shader/source/lambert.essl",[],function(){return"/**\n * http://en.wikipedia.org/wiki/Lambertian_reflectance\n */\n\n@export buildin.lambert.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nuniform mat4 world : WORLD;\n\nuniform vec2 uvRepeat : [1.0, 1.0];\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 normal : NORMAL;\n\nattribute vec3 barycentric;\n\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n\nuniform mat4 invBindMatrix[JOINT_NUMBER] : INV_BIND_MATRIX;\n#endif\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec3 v_Barycentric;\nvarying vec3 v_Weight;\n\nvoid main()\n{\n\n    vec3 skinnedPosition = position;\n    vec3 skinnedNormal = normal;\n\n    #ifdef SKINNING\n        \n        @import buildin.chunk.skin_matrix\n\n        skinnedPosition = (skinMatrix * vec4(position, 1.0)).xyz;\n        // Normal matrix ???\n        skinnedNormal = (skinMatrix * vec4(normal, 0.0)).xyz;\n    #endif\n\n    gl_Position = worldViewProjection * vec4( skinnedPosition, 1.0 );\n\n    v_Texcoord = texcoord * uvRepeat;\n    v_Normal = normalize( ( worldInverseTranspose * vec4(skinnedNormal, 0.0) ).xyz );\n    v_WorldPosition = ( world * vec4( skinnedPosition, 1.0) ).xyz;\n\n    v_Barycentric = barycentric;\n    #ifdef SKINNING\n        v_Weight = weight;\n    #else\n        v_Weight = vec3(0.0);\n    #endif\n}\n\n@end\n\n\n\n\n@export buildin.lambert.fragment\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec3 v_Weight;\n\nuniform sampler2D diffuseMap;\nuniform sampler2D alphaMap;\n\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform vec3 emission : [0.0, 0.0, 0.0];\nuniform float alpha : 1.0;\n\n// Uniforms for wireframe\nuniform float lineWidth : 0.0;\nuniform vec3 lineColor : [0.0, 0.0, 0.0];\nvarying vec3 v_Barycentric;\n\n#ifdef AMBIENT_LIGHT_NUMBER\n@import buildin.header.ambient_light\n#endif\n#ifdef POINT_LIGHT_NUMBER\n@import buildin.header.point_light\n#endif\n#ifdef DIRECTIONAL_LIGHT_NUMBER\n@import buildin.header.directional_light\n#endif\n#ifdef SPOT_LIGHT_NUMBER\n@import buildin.header.spot_light\n#endif\n\n#extension GL_OES_standard_derivatives : enable\n// Import util functions and uniforms needed\n@import buildin.util.calculate_attenuation\n\n@import buildin.util.edge_factor\n\n@import buildin.plugin.compute_shadow_map\n\nvoid main()\n{\n    \n    #ifdef RENDER_WEIGHT\n        gl_FragColor = vec4(v_Weight, 1.0);\n        return;\n    #endif\n    #ifdef RENDER_NORMAL\n        gl_FragColor = vec4(v_Normal, 1.0);\n        return;\n    #endif\n    #ifdef RENDER_TEXCOORD\n        gl_FragColor = vec4(v_Texcoord, 1.0, 1.0);\n        return;\n    #endif\n\n    gl_FragColor = vec4(color, alpha);\n\n    #ifdef DIFFUSEMAP_ENABLED\n        vec4 tex = texture2D( diffuseMap, v_Texcoord );\n        #ifdef SRGB_DECODE\n            tex.rgb = pow(tex.rgb, vec3(2.2));\n        #endif\n        gl_FragColor.rgb *= tex.rgb;\n        #ifdef DIFFUSEMAP_USE_ALPHA\n            gl_FragColor.a *= tex.a;\n        #endif\n    #endif\n\n    vec3 diffuseColor = vec3(0.0, 0.0, 0.0);\n    \n    #ifdef AMBIENT_LIGHT_NUMBER\n        for(int i = 0; i < AMBIENT_LIGHT_NUMBER; i++)\n        {\n            diffuseColor += ambientLightColor[i];\n        }\n    #endif\n    // Compute point light color\n    #ifdef POINT_LIGHT_NUMBER\n        #if defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n            float shadowContribs[POINT_LIGHT_NUMBER];\n            if( shadowEnabled )\n            {\n                computeShadowOfPointLights( v_WorldPosition, shadowContribs );\n            }\n        #endif\n        for(int i = 0; i < POINT_LIGHT_NUMBER; i++)\n        {\n\n            vec3 lightPosition = pointLightPosition[i];\n            vec3 lightColor = pointLightColor[i];\n            float range = pointLightRange[i];\n\n            vec3 lightDirection = lightPosition - v_WorldPosition;\n\n            // Calculate point light attenuation\n            float dist = length(lightDirection);\n            float attenuation = calculateAttenuation(dist, range);\n\n            // Normalize vectors\n            lightDirection /= dist;\n\n            float ndl = dot( v_Normal, lightDirection );\n\n            float shadowContrib = 1.0;\n            #if defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n                if( shadowEnabled )\n                {\n                    shadowContrib = shadowContribs[i];\n                }\n            #endif\n\n            diffuseColor += lightColor * clamp(ndl, 0.0, 1.0) * attenuation * shadowContrib;\n        }\n    #endif\n    #ifdef DIRECTIONAL_LIGHT_NUMBER\n        #if defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n            float shadowContribs[DIRECTIONAL_LIGHT_NUMBER];\n            if(shadowEnabled)\n            {\n                computeShadowOfDirectionalLights( v_WorldPosition, shadowContribs );\n            }\n        #endif\n        for(int i = 0; i < DIRECTIONAL_LIGHT_NUMBER; i++)\n        {\n            vec3 lightDirection = -directionalLightDirection[i];\n            vec3 lightColor = directionalLightColor[i];\n            \n            float ndl = dot( v_Normal, normalize( lightDirection ) );\n\n            float shadowContrib = 1.0;\n            #if defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n                if( shadowEnabled )\n                {\n                    shadowContrib = shadowContribs[i];\n                }\n            #endif\n\n            diffuseColor += lightColor * clamp(ndl, 0.0, 1.0) * shadowContrib;\n        }\n    #endif\n    \n    #ifdef SPOT_LIGHT_NUMBER\n        #if defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n            float shadowContribs[SPOT_LIGHT_NUMBER];\n            if( shadowEnabled )\n            {\n                computeShadowOfSpotLights( v_WorldPosition, shadowContribs );\n            }\n        #endif\n        for(int i = 0; i < SPOT_LIGHT_NUMBER; i++)\n        {\n            vec3 lightPosition = -spotLightPosition[i];\n            vec3 spotLightDirection = -normalize( spotLightDirection[i] );\n            vec3 lightColor = spotLightColor[i];\n            float range = spotLightRange[i];\n            float umbraAngleCosine = spotLightUmbraAngleCosine[i];\n            float penumbraAngleCosine = spotLightPenumbraAngleCosine[i];\n            float falloffFactor = spotLightFalloffFactor[i];\n\n            vec3 lightDirection = lightPosition - v_WorldPosition;\n            // Calculate attenuation\n            float dist = length(lightDirection);\n            float attenuation = calculateAttenuation(dist, range); \n\n            // Normalize light direction\n            lightDirection /= dist;\n            // Calculate spot light fall off\n            float lightDirectCosine = dot(spotLightDirection, lightDirection);\n\n            float falloff;\n            falloff = clamp((lightDirectCosine-umbraAngleCosine)/(penumbraAngleCosine-umbraAngleCosine), 0.0, 1.0);\n            falloff = pow(falloff, falloffFactor);\n\n            float ndl = dot(v_Normal, lightDirection);\n            ndl = clamp(ndl, 0.0, 1.0);\n\n            float shadowContrib = 1.0;\n            #if defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n                if( shadowEnabled )\n                {\n                    shadowContrib = shadowContribs[i];\n                }\n            #endif\n\n            diffuseColor += lightColor * ndl * attenuation * (1.0-falloff) * shadowContrib;\n\n        }\n    #endif\n\n    gl_FragColor.rgb *= diffuseColor;\n    gl_FragColor.rgb += emission;\n    if(lineWidth > 0.01)\n    {\n        gl_FragColor.rgb = gl_FragColor.rgb * mix(lineColor, vec3(1.0), edgeFactor(lineWidth));\n    }\n}\n\n@end"
}),d("shader/source/phong.essl",[],function(){return"\n// http://en.wikipedia.org/wiki/Blinn%E2%80%93Phong_shading_model\n\n@export buildin.phong.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 worldInverseTranspose : WORLDINVERSETRANSPOSE;\nuniform mat4 world : WORLD;\n\nuniform vec2 uvRepeat : [1.0, 1.0];\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\nattribute vec3 normal : NORMAL;\nattribute vec4 tangent : TANGENT;\n\nattribute vec3 barycentric;\n\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n\nuniform mat4 invBindMatrix[JOINT_NUMBER] : INV_BIND_MATRIX;\n#endif\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_Normal;\nvarying vec3 v_LocalNormal;\nvarying vec3 v_WorldPosition;\nvarying vec3 v_Barycentric;\n\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\n\nvarying vec3 v_Weight;\n\nvoid main()\n{\n    \n    vec3 skinnedPosition = position;\n    vec3 skinnedNormal = normal;\n    vec3 skinnedTangent = tangent.xyz;\n    #ifdef SKINNING\n        \n        @import buildin.chunk.skin_matrix\n\n        skinnedPosition = (skinMatrix * vec4(position, 1.0)).xyz;\n        // Normal matrix ???\n        skinnedNormal = (skinMatrix * vec4(normal, 0.0)).xyz;\n        skinnedTangent = (skinMatrix * vec4(tangent.xyz, 0.0)).xyz;\n    #endif\n\n    gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n\n    v_Texcoord = texcoord * uvRepeat;\n    v_WorldPosition = (world * vec4(skinnedPosition, 1.0)).xyz;\n    v_Barycentric = barycentric;\n\n    v_LocalNormal = skinnedNormal;\n    v_Normal = normalize((worldInverseTranspose * vec4(skinnedNormal, 0.0)).xyz);\n    v_Tangent = normalize((worldInverseTranspose * vec4(skinnedTangent, 0.0)).xyz);\n    v_Bitangent = normalize(cross(v_Normal, v_Tangent) * tangent.w);\n\n    #ifdef SKINNING\n        v_Weight = weight;\n    #else\n        v_Weight = vec3(1.0);\n    #endif\n}\n\n@end\n\n\n@export buildin.phong.fragment\n\nuniform mat4 viewInverse : VIEWINVERSE;\n\nvarying vec2 v_Texcoord;\nvarying vec3 v_LocalNormal;\nvarying vec3 v_Normal;\nvarying vec3 v_WorldPosition;\nvarying vec3 v_Tangent;\nvarying vec3 v_Bitangent;\nvarying vec3 v_Weight;\n\nuniform sampler2D diffuseMap;\nuniform sampler2D normalMap;\nuniform samplerCube environmentMap;\n\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform float alpha : 1.0;\n\nuniform float shininess : 30;\n\nuniform vec3 specular : [1.0, 1.0, 1.0];\nuniform vec3 emission : [0.0, 0.0, 0.0];\n\nuniform float reflectivity : 0.5;\n\n// Uniforms for wireframe\nuniform float lineWidth : 0.0;\nuniform vec3 lineColor : [0.0, 0.0, 0.0];\nvarying vec3 v_Barycentric;\n\n#ifdef AMBIENT_LIGHT_NUMBER\n@import buildin.header.ambient_light\n#endif\n#ifdef POINT_LIGHT_NUMBER\n@import buildin.header.point_light\n#endif\n#ifdef DIRECTIONAL_LIGHT_NUMBER\n@import buildin.header.directional_light\n#endif\n#ifdef SPOT_LIGHT_NUMBER\n@import buildin.header.spot_light\n#endif\n\n#extension GL_OES_standard_derivatives : enable\n// Import util functions and uniforms needed\n@import buildin.util.calculate_attenuation\n\n@import buildin.util.edge_factor\n\n@import buildin.plugin.compute_shadow_map\n\nvoid main()\n{\n    #ifdef RENDER_WEIGHT\n        gl_FragColor = vec4(v_Weight.xyz, 1.0);\n        return;\n    #endif\n    #ifdef RENDER_TEXCOORD\n        gl_FragColor = vec4(v_Texcoord, 1.0, 1.0);\n        return;\n    #endif\n\n    vec4 finalColor = vec4(color, alpha);\n\n    vec3 eyePos = viewInverse[3].xyz;\n    vec3 viewDirection = normalize(eyePos - v_WorldPosition);\n\n    #ifdef DIFFUSEMAP_ENABLED\n        vec4 tex = texture2D(diffuseMap, v_Texcoord);\n        #ifdef SRGB_DECODE\n            tex.rgb = pow(tex.rgb, vec3(2.2));\n        #endif\n        finalColor.rgb *= tex.rgb;\n        #ifdef DIFFUSEMAP_USE_ALPHA\n            finalColor.a *= tex.a;\n        #endif\n    #endif\n\n    vec3 normal = v_Normal;\n    #ifdef NORMALMAP_ENABLED\n        normal = texture2D(normalMap, v_Texcoord).xyz * 2.0 - 1.0;\n        mat3 tbn = mat3(v_Tangent, v_Bitangent, v_Normal);\n        normal = normalize(tbn * normal);\n    #endif\n\n    #ifdef RENDER_NORMAL\n        gl_FragColor = vec4(normal, 1.0);\n        return;\n    #endif\n\n    // Diffuse part of all lights\n    vec3 diffuseItem = vec3(0.0, 0.0, 0.0);\n    // Specular part of all lights\n    vec3 specularItem = vec3(0.0, 0.0, 0.0);\n    \n    #ifdef AMBIENT_LIGHT_NUMBER\n        for(int i = 0; i < AMBIENT_LIGHT_NUMBER; i++)\n        {\n            diffuseItem += ambientLightColor[i];\n        }\n    #endif\n    #ifdef POINT_LIGHT_NUMBER\n        #if defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n            float shadowContribs[POINT_LIGHT_NUMBER];\n            if(shadowEnabled)\n            {\n                computeShadowOfPointLights(v_WorldPosition, shadowContribs);\n            }\n        #endif\n        for(int i = 0; i < POINT_LIGHT_NUMBER; i++)\n        {\n\n            vec3 lightPosition = pointLightPosition[i];\n            vec3 lightColor = pointLightColor[i];\n            float range = pointLightRange[i];\n\n            vec3 lightDirection = lightPosition - v_WorldPosition;\n\n            // Calculate point light attenuation\n            float dist = length(lightDirection);\n            float attenuation = calculateAttenuation(dist, range); \n\n            // Normalize vectors\n            lightDirection /= dist;\n            vec3 halfVector = normalize(lightDirection + viewDirection);\n\n            float ndh = dot(normal, halfVector);\n            ndh = clamp(ndh, 0.0, 1.0);\n\n            float ndl = dot(normal,  lightDirection);\n            ndl = clamp(ndl, 0.0, 1.0);\n\n            float shadowContrib = 1.0;\n            #if defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n                if(shadowEnabled)\n                {\n                    shadowContrib = shadowContribs[i];\n                }\n            #endif\n\n            diffuseItem += lightColor * ndl * attenuation * shadowContrib;\n\n            if (shininess > 0.0)\n            {\n                specularItem += lightColor * ndl * pow(ndh, shininess) * attenuation * shadowContrib;\n            }\n\n        }\n    #endif\n\n    #ifdef DIRECTIONAL_LIGHT_NUMBER\n        #if defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n            float shadowContribs[DIRECTIONAL_LIGHT_NUMBER];\n            if(shadowEnabled)\n            {\n                computeShadowOfDirectionalLights(v_WorldPosition, shadowContribs);\n            }\n        #endif\n        for(int i = 0; i < DIRECTIONAL_LIGHT_NUMBER; i++)\n        {\n\n            vec3 lightDirection = -normalize(directionalLightDirection[i]);\n            vec3 lightColor = directionalLightColor[i];\n\n            vec3 halfVector = normalize(lightDirection + viewDirection);\n\n            float ndh = dot(normal, halfVector);\n            ndh = clamp(ndh, 0.0, 1.0);\n\n            float ndl = dot(normal, lightDirection);\n            ndl = clamp(ndl, 0.0, 1.0);\n\n            float shadowContrib = 1.0;\n            #if defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n                if(shadowEnabled)\n                {\n                    shadowContrib = shadowContribs[i];\n                }\n            #endif\n\n            diffuseItem += lightColor * ndl * shadowContrib;\n\n            if (shininess > 0.0)\n            {\n                specularItem += lightColor * ndl * pow(ndh, shininess) * shadowContrib;\n            }\n        }\n    #endif\n\n    #ifdef SPOT_LIGHT_NUMBER\n        #if defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n            float shadowContribs[SPOT_LIGHT_NUMBER];\n            if(shadowEnabled)\n            {\n                computeShadowOfSpotLights(v_WorldPosition, shadowContribs);\n            }\n        #endif\n        for(int i = 0; i < SPOT_LIGHT_NUMBER; i++)\n        {\n            vec3 lightPosition = spotLightPosition[i];\n            vec3 spotLightDirection = -normalize(spotLightDirection[i]);\n            vec3 lightColor = spotLightColor[i];\n            float range = spotLightRange[i];\n            float umbraAngleCosine = spotLightUmbraAngleCosine[i];\n            float penumbraAngleCosine = spotLightPenumbraAngleCosine[i];\n            float falloffFactor = spotLightFalloffFactor[i];\n\n            vec3 lightDirection = lightPosition - v_WorldPosition;\n            // Calculate attenuation\n            float dist = length(lightDirection);\n            float attenuation = calculateAttenuation(dist, range); \n\n            // Normalize light direction\n            lightDirection /= dist;\n            // Calculate spot light fall off\n            float lightDirectCosine = dot(spotLightDirection, lightDirection);\n\n            float falloff;\n            // Fomular from real-time-rendering\n            falloff = clamp((lightDirectCosine-umbraAngleCosine)/(penumbraAngleCosine-umbraAngleCosine), 0.0, 1.0);\n            falloff = pow(falloff, falloffFactor);\n\n            vec3 halfVector = normalize(lightDirection + viewDirection);\n\n            float ndh = dot(normal, halfVector);\n            ndh = clamp(ndh, 0.0, 1.0);\n\n            float ndl = dot(normal, lightDirection);\n            ndl = clamp(ndl, 0.0, 1.0);\n\n            float shadowContrib = 1.0;\n            #if defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n                if (shadowEnabled)\n                {\n                    shadowContrib = shadowContribs[i];\n                }\n            #endif\n\n            diffuseItem += lightColor * ndl * attenuation * (1.0-falloff) * shadowContrib;\n\n            if (shininess > 0.0)\n            {\n                specularItem += lightColor * ndl * pow(ndh, shininess) * attenuation * (1.0-falloff) * shadowContrib;\n            }\n        }\n    #endif\n\n    finalColor.rgb *= diffuseItem;\n    finalColor.rgb += specularItem * specular;\n    finalColor.rgb += emission;\n\n    #ifdef ENVIRONMENTMAP_ENABLED\n        vec3 envTex = textureCube(environmentMap, reflect(-viewDirection, normal)).xyz;\n        finalColor.rgb = finalColor.rgb + envTex * reflectivity;\n    #endif\n\n    if(lineWidth > 0.01)\n    {\n        finalColor.rgb = finalColor.rgb * mix(lineColor, vec3(1.0), edgeFactor(lineWidth));\n    }\n\n    gl_FragColor = finalColor;\n}\n\n@end"}),d("shader/source/wireframe.essl",[],function(){return"@export buildin.wireframe.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 world : WORLD;\n\nattribute vec3 position : POSITION;\nattribute vec3 barycentric;\n\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n\nuniform mat4 invBindMatrix[JOINT_NUMBER] : INV_BIND_MATRIX;\n#endif\n\nvarying vec3 v_Barycentric;\n\nvoid main()\n{\n\n    vec3 skinnedPosition = position;\n    #ifdef SKINNING\n\n        @import buildin.chunk.skin_matrix\n\n        skinnedPosition = (skinMatrix * vec4(position, 1.0)).xyz;\n    #endif\n\n    gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0 );\n\n    v_Barycentric = barycentric;\n}\n\n@end\n\n\n@export buildin.wireframe.fragment\n\nuniform vec3 color : [0.0, 0.0, 0.0];\n\nuniform float alpha : 1.0;\nuniform float lineWidth : 1.0;\n\nvarying vec3 v_Barycentric;\n\n#extension GL_OES_standard_derivatives : enable\n\n@import buildin.util.edge_factor\n\nvoid main()\n{\n\n    gl_FragColor.rgb = color;\n    gl_FragColor.a = ( 1.0-edgeFactor(lineWidth) ) * alpha;\n}\n\n@end"}),d("shader/source/skybox.essl",[],function(){return"@export buildin.skybox.vertex\n\nuniform mat4 world : WORLD;\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\n\nvarying vec3 v_WorldPosition;\n\nvoid main()\n{\n    v_WorldPosition = (world * vec4(position, 1.0)).xyz;\n    gl_Position = worldViewProjection * vec4(position, 1.0);\n}\n\n@end\n\n@export buildin.skybox.fragment\n\nuniform mat4 viewInverse : VIEWINVERSE;\nuniform samplerCube environmentMap;\n\nvarying vec3 v_WorldPosition;\n\nvoid main()\n{\n    vec3 eyePos = viewInverse[3].xyz;\n    vec3 viewDirection = normalize(v_WorldPosition - eyePos);\n\n    vec3 tex = textureCube(environmentMap, viewDirection).xyz;\n\n    #ifdef SRGB_DECODE\n        tex.rgb = pow(tex.rgb, vec3(2.2));\n    #endif\n    \n    gl_FragColor = vec4(tex, 1.0);\n}\n@end"}),d("shader/source/util.essl",[],function(){return"// Use light attenuation formula in\n// http://blog.slindev.com/2011/01/10/natural-light-attenuation/\n@export buildin.util.calculate_attenuation\n\nuniform float attenuationFactor : 5.0;\n\nfloat calculateAttenuation(float dist, float range)\n{\n    float attenuation = 1.0;\n    if( range > 0.0)\n    {\n        attenuation = dist*dist/(range*range);\n        float att_s = attenuationFactor;\n        attenuation = 1.0/(attenuation*att_s+1.0);\n        att_s = 1.0/(att_s+1.0);\n        attenuation = attenuation - att_s;\n        attenuation /= 1.0 - att_s;\n    }\n    return attenuation;\n}\n\n@end\n\n//http://codeflow.org/entries/2012/aug/02/easy-wireframe-display-with-barycentric-coordinates/\n@export buildin.util.edge_factor\n\nfloat edgeFactor(float width)\n{\n    vec3 d = fwidth(v_Barycentric);\n    vec3 a3 = smoothstep(vec3(0.0), d * width, v_Barycentric);\n    return min(min(a3.x, a3.y), a3.z);\n}\n\n@end\n\n// Pack depth\n// Float value can only be 0.0 - 1.0 ?\n@export buildin.util.pack_depth\nvec4 packDepth( const in float depth )\n{\n\n    const vec4 bitShifts = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );\n\n    const vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );\n    vec4 res = fract( depth * bitShifts );\n    res -= res.xxyz * bit_mask;\n\n    return res;\n}\n@end\n\n@export buildin.util.unpack_depth\nfloat unpackDepth( const in vec4 colour )\n{\n    const vec4 bitShifts = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );\n    return dot(colour, bitShifts);\n}\n@end\n\n@export buildin.util.pack_depth_half\nvec2 packDepthHalf( const in float depth )\n{\n    const vec2 bitShifts = vec2(256.0, 1.0);\n    const vec4 bitMask = vec4(0.0, 1.0/256.0);\n\n    vec2 rg = fract(depth*bitShifts);\n    rg -= rg.xx * bitMask;\n\n    return rg;\n}\n@end\n\n@export buildin.util.unpack_depth_half\nfloat unpackDepthHalf( const in vec2 rg )\n{\n    const vec4 bitShifts = vec2(1.0/256.0, 1.0);\n    return dot(rg, bitShifts);\n}\n@end\n\n@export buildin.chunk.skin_matrix\nmat4 skinMatrix;\nif (joint.x >= 0.0)\n{\n    skinMatrix = invBindMatrix[int(joint.x)] * weight.x;\n}\nif (joint.y >= 0.0)\n{\n    skinMatrix += invBindMatrix[int(joint.y)] * weight.y;\n}\nif (joint.z >= 0.0)\n{\n    skinMatrix += invBindMatrix[int(joint.z)] * weight.z;\n}\nif (joint.w >= 0.0)\n{\n    skinMatrix += invBindMatrix[int(joint.w)] * (1.0-weight.x-weight.y-weight.z);\n}\n@end"}),d("shader/source/prez.essl",[],function(){return"// Shader for prez pass\n@export buildin.prez.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\n\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n\nuniform mat4 invBindMatrix[JOINT_NUMBER] : INV_BIND_MATRIX;\n#endif\n\nvoid main()\n{\n\n    vec3 skinnedPosition = position;\n\n    #ifdef SKINNING\n        \n        @import buildin.chunk.skin_matrix\n        \n        skinnedPosition = (skinMatrix * vec4(position, 1.0)).xyz;\n    #endif\n\n    gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n}\n\n@end\n\n\n@export buildin.prez.fragment\n\nvoid main()\n{\n    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n\n@end"}),d("shader/library",["require","../Shader","_","./source/basic.essl","./source/lambert.essl","./source/phong.essl","./source/wireframe.essl","./source/skybox.essl","./source/util.essl","./source/prez.essl"],function(a){function b(a,b){var c=[],e={},f={};"string"==typeof b?c=Array.prototype.slice.call(arguments,1):"[object Object]"==toString.call(b)?(c=b.textures||[],e=b.vertexDefines||{},f=b.fragmentDefines||{}):b instanceof Array&&(c=b);var g=Object.keys(e),h=Object.keys(f);c.sort(),g.sort(),h.sort();var i=[a];i=i.concat(c);for(var j=0;j<g.length;j++)i.push(e[g[j]]);for(var j=0;j<h.length;j++)i.push(f[h[j]]);var k=i.join("_");if(_pool[k])return _pool[k];var l=_library[a];if(!l)return console.error('Shader "'+a+'"'+" is not in the library"),void 0;for(var m=new d({vertex:l.vertex,fragment:l.fragment}),j=0;j<c.length;j++)m.enableTexture(c[j]);for(var a in e)m.define("vertex",a,e[a]);for(var a in f)m.define("fragment",a,f[a]);return _pool[k]=m,m}function c(a,b,c){_library[a]={vertex:b,fragment:c}}var d=a("../Shader");return a("_"),_library={},_pool={},d.import(a("./source/basic.essl")),d.import(a("./source/lambert.essl")),d.import(a("./source/phong.essl")),d.import(a("./source/wireframe.essl")),d.import(a("./source/skybox.essl")),d.import(a("./source/util.essl")),d.import(a("./source/prez.essl")),c("buildin.basic",d.source("buildin.basic.vertex"),d.source("buildin.basic.fragment")),c("buildin.lambert",d.source("buildin.lambert.vertex"),d.source("buildin.lambert.fragment")),c("buildin.phong",d.source("buildin.phong.vertex"),d.source("buildin.phong.fragment")),c("buildin.wireframe",d.source("buildin.wireframe.vertex"),d.source("buildin.wireframe.fragment")),c("buildin.skybox",d.source("buildin.skybox.vertex"),d.source("buildin.skybox.fragment")),c("buildin.prez",d.source("buildin.prez.vertex"),d.source("buildin.prez.fragment")),{get:b,put:c}}),d("Renderer",["require","./core/Base","./core/util","./Light","./Mesh","./Texture","./core/glinfo","./core/glenum","./math/BoundingBox","./math/Matrix4","./Shader","./shader/library","./Material","glmatrix"],function(a){function b(a,b){return a.material.shader===b.material.shader?a.material===b.material?a.geometry.__GUID__-b.geometry.__GUID__:a.material.__GUID__-b.material.__GUID__:a.material.shader.__GUID__-b.material.shader.__GUID__}function c(a,b){return a.__depth===b.__depth?a.material.shader===b.material.shader?a.material===b.material?a.geometry.__GUID__-b.geometry.__GUID__:a.material.__GUID__-b.material.__GUID__:a.material.shader.__GUID__-b.material.shader.__GUID__:a.__depth-b.__depth}var d=a("./core/Base"),e=a("./core/util");a("./Light"),a("./Mesh");var g=a("./Texture"),h=a("./core/glinfo"),i=a("./core/glenum"),j=a("./math/BoundingBox"),k=a("./math/Matrix4");a("./Shader");var l=a("./shader/library"),m=a("./Material"),n=a("glmatrix"),o=n.mat4,p=n.vec3;n.vec4;var q=0,r=l.get("buildin.prez"),s=new m({shader:r}),t=d.derive(function(){return{__GUID__:e.genGUID(),canvas:null,width:100,height:100,devicePixelRatio:window.devicePixelRatio||1,color:[0,0,0,0],clear:17664,alhpa:!0,depth:!0,stencil:!1,antialias:!0,premultipliedAlpha:!0,preserveDrawingBuffer:!1,gl:null,viewportInfo:{},_sceneRendering:null}},function(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height);try{this.gl=this.canvas.getContext("experimental-webgl",{alhpa:this.alhpa,depth:this.depth,stencil:this.stencil,antialias:this.antialias,premultipliedAlpha:this.premultipliedAlpha,preserveDrawingBuffer:this.preserveDrawingBuffer}),this.gl.__GLID__=q++,this.width=this.canvas.width,this.height=this.canvas.height,this.resize(this.width,this.height),h.initialize(this.gl)}catch(a){throw"Error creating WebGL Context"}},{resize:function(a,b){var c=this.canvas;c.style.width=a+"px",c.style.height=b+"px",c.width=a*this.devicePixelRatio,c.height=b*this.devicePixelRatio,this.width=a,this.height=b,this.setViewport(0,0,c.width,c.height)},setDevicePixelRatio:function(a){this.devicePixelRatio=a,this.resize(this.width,this.height)},setViewport:function(a,b,c,d){if("object"==typeof a){var e=a;a=e.x,b=e.y,c=e.width,d=e.height}this.gl.viewport(a,b,c,d),this.viewportInfo={x:a,y:b,width:c,height:d}},render:function(a,d,e,g){var h=this.gl;this._sceneRendering=a;var i=this.color;h.clearColor(i[0],i[1],i[2],i[3]),h.clear(this.clear),d.update(!1),e||a.update(!1);var j=a.opaqueQueue,k=a.transparentQueue,l=a.material;if(a.trigger("beforerender",this,a,d),k.length>0){var m=o.create(),n=p.create();o.invert(u.VIEW,d.worldTransform._array);for(var q=0;q<k.length;q++){var r=k[q];o.multiply(m,u.VIEW,r.worldTransform._array),p.transformMat4(n,r.position._array,m),r.__depth=n[2]}}j.sort(b),k.sort(c),a.trigger("beforerender:opaque",this,j),d.sceneBoundingBoxLastFrame.min.set(1/0,1/0,1/0),d.sceneBoundingBoxLastFrame.max.set(-1/0,-1/0,-1/0),h.disable(h.BLEND),h.enable(h.DEPTH_TEST);var s=this.renderQueue(j,d,l,g);a.trigger("afterrender:opaque",this,j,s),a.trigger("beforerender:transparent",this,k),h.enable(h.BLEND);var t=this.renderQueue(k,d,l);a.trigger("afterrender:transparent",this,k,t);var v={};for(f in s)v[f]=s[f]+t[f];return a.trigger("afterrender",this,a,d,v),v},renderQueue:function(a,b,c,d){var e={faceNumber:0,vertexNumber:0,drawCallNumber:0,meshNumber:0};o.invert(u.VIEW,b.worldTransform._array),o.copy(u.PROJECTION,b.projectionMatrix._array),o.multiply(u.VIEWPROJECTION,b.projectionMatrix._array,u.VIEW),o.copy(u.VIEWINVERSE,b.worldTransform._array),o.invert(u.PROJECTIONINVERSE,u.PROJECTION),o.invert(u.VIEWPROJECTIONINVERSE,u.VIEWPROJECTION);var f,g,h,i,j,k,l,m,n=this.gl,p=this._sceneRendering;if(d){m=[],r.bind(n),n.colorMask(!1,!1,!1,!1),n.depthMask(!0);for(var q=0;q<a.length;q++){var t=a[q],v=t.worldTransform._array,w=t.geometry;if(o.multiply(u.WORLDVIEW,u.VIEW,v),o.multiply(u.WORLDVIEWPROJECTION,u.VIEWPROJECTION,v),!w.boundingBox||this._frustumCulling(t,b)){t.cullFace!==k&&(k=t.cullFace,n.cullFace(k)),t.frontFace!==l&&(l=t.frontFace,n.frontFace(l)),t.culling!==j&&(j=t.culling,j?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE));var x=r.matrixSemantics.WORLDVIEWPROJECTION;r.setUniform(n,x.type,x.symbol,u.WORLDVIEWPROJECTION),t.render(n,s),m.push(t)}}n.depthFunc(n.LEQUAL),n.colorMask(!0,!0,!0,!0),n.depthMask(!1)}else m=a;for(var q=0;q<m.length;q++){var t=m[q],y=c||t.material,z=y.shader,w=t.geometry,v=t.worldTransform._array;if(o.copy(u.WORLD,v),o.multiply(u.WORLDVIEW,u.VIEW,v),o.multiply(u.WORLDVIEWPROJECTION,u.VIEWPROJECTION,v),(z.matrixSemantics.WORLDINVERSE||z.matrixSemantics.WORLDINVERSETRANSPOSE)&&o.invert(u.WORLDINVERSE,v),(z.matrixSemantics.WORLDVIEWINVERSE||z.matrixSemantics.WORLDVIEWINVERSETRANSPOSE)&&o.invert(u.WORLDVIEWINVERSE,u.WORLDVIEW),(z.matrixSemantics.WORLDVIEWPROJECTIONINVERSE||z.matrixSemantics.WORLDVIEWPROJECTIONINVERSETRANSPOSE)&&o.invert(u.WORLDVIEWPROJECTIONINVERSE,u.WORLDVIEWPROJECTION),!w.boundingBox||d||this._frustumCulling(t,b)){if(g!==z.__GUID__){if(p&&p.isShaderLightNumberChanged(z)&&p.setShaderLightNumber(z),z.bind(n),p)for(var A in p.lightUniforms){var B=p.lightUniforms[A];z.setUniform(n,B.type,A,B.value)}g=z.__GUID__}f!==y.__GUID__&&(d||(y.depthTest!==h&&(y.depthTest?n.enable(n.DEPTH_TEST):n.disable(n.DEPTH_TEST),h=y.depthTest),y.depthMask!==i&&(n.depthMask(y.depthMask),i=y.depthMask)),y.bind(n),f=y.__GUID__,y.transparent&&(y.blend?y.blend(n):(n.blendEquationSeparate(n.FUNC_ADD,n.FUNC_ADD),n.blendFuncSeparate(n.SRC_ALPHA,n.ONE_MINUS_SRC_ALPHA,n.ONE,n.ONE_MINUS_SRC_ALPHA))));for(var C=z.matrixSemanticKeys,D=0;D<C.length;D++){var E=C[D],x=z.matrixSemantics[E],F=u[E];if(x.isTranspose){var G=u[x.semanticNoTranspose];o.transpose(F,G)}z.setUniform(n,x.type,x.symbol,F)}t.cullFace!==k&&(k=t.cullFace,n.cullFace(k)),t.frontFace!==l&&(l=t.frontFace,n.frontFace(l)),t.culling!==j&&(j=t.culling,j?n.enable(n.CULL_FACE):n.disable(n.CULL_FACE));var H=t.render(n,c);H&&(e.faceNumber+=H.faceNumber,e.vertexNumber+=H.vertexNumber,e.drawCallNumber+=H.drawCallNumber,e.meshNumber++)}}return e},_frustumCulling:function(){var a=new j,b=new k;return function(c,d){var e=c.geometry.boundingBox;if(b._array=u.WORLDVIEW,a.copy(e),a.applyTransform(b),d.sceneBoundingBoxLastFrame.union(a),c.frustumCulling){if(!a.intersectBoundingBox(d.frustum.boundingBox))return!1;b._array=u.PROJECTION,a.max._array[2]>0&&a.min._array[2]<0&&(a.max._array[2]=-1e-20),a.applyProjection(b);var f=a.min._array,g=a.max._array;if(g[0]<-1||f[0]>1||g[1]<-1||f[1]>1||g[2]<-1||f[2]>1)return!1}return!0}}(),disposeScene:function(a){this.disposeNode(a),a.dispose()},disposeNode:function(a){var b={},c=this.gl;a.traverse(function(a){a.geometry&&a.geometry.dispose(c),a.material&&(b[a.material.__GUID__]=a.material)});for(var d in b){var e=b[d];e.shader.dispose(c);for(var f in e.uniforms){var h=e.uniforms[f].value;if(h)if(h instanceof g)h.dispose(c);else if(h instanceof Array)for(var i=0;i<h.length;i++)h[i]instanceof g&&h[i].dispose(c)}e.dispose()}a._children=[]},disposeTexture:function(a){a&&a.dispose&&a.dispose(this.gl)}}),u={WORLD:o.create(),VIEW:o.create(),PROJECTION:o.create(),WORLDVIEW:o.create(),VIEWPROJECTION:o.create(),WORLDVIEWPROJECTION:o.create(),WORLDINVERSE:o.create(),VIEWINVERSE:o.create(),PROJECTIONINVERSE:o.create(),WORLDVIEWINVERSE:o.create(),VIEWPROJECTIONINVERSE:o.create(),WORLDVIEWPROJECTIONINVERSE:o.create(),WORLDTRANSPOSE:o.create(),VIEWTRANSPOSE:o.create(),PROJECTIONTRANSPOSE:o.create(),WORLDVIEWTRANSPOSE:o.create(),VIEWPROJECTIONTRANSPOSE:o.create(),WORLDVIEWPROJECTIONTRANSPOSE:o.create(),WORLDINVERSETRANSPOSE:o.create(),VIEWINVERSETRANSPOSE:o.create(),PROJECTIONINVERSETRANSPOSE:o.create(),WORLDVIEWINVERSETRANSPOSE:o.create(),VIEWPROJECTIONINVERSETRANSPOSE:o.create(),WORLDVIEWPROJECTIONINVERSETRANSPOSE:o.create()};return t.COLOR_BUFFER_BIT=i.COLOR_BUFFER_BIT,t.DEPTH_BUFFER_BIT=i.DEPTH_BUFFER_BIT,t.STENCIL_BUFFER_BIT=i.STENCIL_BUFFER_BIT,t}),d("Scene",["require","./Node","./Light","glmatrix","./math/BoundingBox"],function(a){var b=a("./Node"),c=a("./Light"),d=a("glmatrix");a("./math/BoundingBox"),d.mat4,d.vec3;var e=b.derive(function(){return{material:null,autoUpdate:!0,scene:null,lights:{},lightNumber:{POINT_LIGHT:0,DIRECTIONAL_LIGHT:0,SPOT_LIGHT:0,AMBIENT_LIGHT:0},lightUniforms:{},opaqueQueue:[],transparentQueue:[],lights:[],_opaqueObjectCount:0,_transparentObjectCount:0,_nodeRepository:{}}},function(){this.scene=this},{addToScene:function(a){a.name&&(this._nodeRepository[a.name]=a)},removeFromScene:function(a){a.name&&(this._nodeRepository[a.name]=null)},getNode:function(a){return this._nodeRepository[a]},update:function(a){if(this.autoUpdate||a){b.prototype.update.call(this,a);var c=this.lights;this.opaqueQueue,this.transparentQueue;var d=this.material&&this.material.transparent;this._opaqueObjectCount=0,this._transparentObjectCount=0,c.length=0,this._updateRenderQueue(this,d),this.opaqueQueue.length=this._opaqueObjectCount,this.transparentQueue.length=this._transparentObjectCount;for(type in this.lightNumber)this.lightNumber[type]=0;for(var e=0;e<c.length;e++){var f=c[e];this.lightNumber[f.type]++}this._updateLightUnforms()}},_updateRenderQueue:function(a,b){for(var d=0;d<a._children.length;d++){var e=a._children[d];e.visible&&(e instanceof c&&this.lights.push(e),e.isRenderable()&&(e.material.transparent||b?this.transparentQueue[this._transparentObjectCount++]=e:this.opaqueQueue[this._opaqueObjectCount++]=e),e._children.length>0&&this._updateRenderQueue(e))}},_updateLightUnforms:function(){var a=this.lights;a.sort(function(a,b){return b.castShadow&&!a.castShadow?!0:void 0});var b=this.lightUniforms;for(var c in b)b[c].value.length=0;for(var d=0;d<a.length;d++){var e=a[d];for(c in e.uniformTemplates){var f=e.uniformTemplates[c];b[c]||(b[c]={type:"",value:[]});var g=f.value(e),h=b[c];switch(h.type=f.type+"v",f.type){case"1i":case"1f":h.value.push(g);break;case"2f":case"3f":case"4f":for(var i=0;i<g.length;i++)h.value.push(g[i]);break;default:console.error("Unkown light uniform type "+f.type)}}}},isShaderLightNumberChanged:function(a){return a.lightNumber.POINT_LIGHT!==this.lightNumber.POINT_LIGHT||a.lightNumber.DIRECTIONAL_LIGHT!==this.lightNumber.DIRECTIONAL_LIGHT||a.lightNumber.SPOT_LIGHT!==this.lightNumber.SPOT_LIGHT||a.lightNumber.AMBIENT_LIGHT!==this.lightNumber.AMBIENT_LIGHT},setShaderLightNumber:function(a){for(var b in this.lightNumber)a.lightNumber[b]=this.lightNumber[b];a.dirty()},dispose:function(){this.lights=[],this.lightNumber={},this.lightUniforms={},this.material={},this.opaqueQueue=[],this.transparentQueue=[],this._nodeRepository={}}});return e}),d("Skeleton",["require","./core/Base","./math/Matrix4"],function(a){var b=a("./core/Base"),c=a("./math/Matrix4"),d=b.derive(function(){return{roots:[],joints:[],_jointMatrices:[],_invBindMatrices:[],_invBindMatricesArray:null,_subInvBindMatricesArray:{}}},{updateHierarchy:function(){this.roots=[];for(var a=this.joints,b=0;b<a.length;b++){var c=a[b];if(c.parentIndex>=0){var d=a[c.parentIndex];d.add(c)}else this.roots.push(c)}},updateJointMatrices:function(){for(var a=0;a<this.roots.length;a++)this.roots[a].update();for(var a=0;a<this.joints.length;a++){var b=this.joints[a];this._jointMatrices[a]=(new c).copy(b.worldTransform).invert(),this._invBindMatrices[a]=new c}},update:function(){for(var a=0;a<this.roots.length;a++)this.roots[a].update();this._invBindMatricesArray||(this._invBindMatricesArray=new Float32Array(16*this.joints.length));for(var b=0,a=0;a<this.joints.length;a++){var c=this.joints[a].worldTransform;this._invBindMatrices[a].copy(c).multiply(this._jointMatrices[a]);for(var d=0;16>d;d++){var e=this._invBindMatrices[a]._array;this._invBindMatricesArray[b++]=e[d]}}},getSubInvBindMatrices:function(a,b){var c=this._subInvBindMatricesArray[a];c||(c=this._subInvBindMatricesArray[a]=new Float32Array(16*b.length));for(var d=0,e=0;e<b.length;e++)for(var f=b[e],g=0;16>g;g++)c[d++]=this._invBindMatricesArray[16*f+g];return c},setPose:function(a){for(var b=0;b<this.joints.length;b++)this.joints[b].setPose(a);this.update()},getClipTime:function(){var a=this.joints[0].poses;return a.length?a[a.length-1].time:void 0},getBoneNumber:function(){return this.joints.length}});return d}),d("animation/easing",[],function(){var a={Linear:function(a){return a},QuadraticIn:function(a){return a*a},QuadraticOut:function(a){return a*(2-a)},QuadraticInOut:function(a){return(a*=2)<1?.5*a*a:-.5*(--a*(a-2)-1)},CubicIn:function(a){return a*a*a},CubicOut:function(a){return--a*a*a+1},CubicInOut:function(a){return(a*=2)<1?.5*a*a*a:.5*((a-=2)*a*a+2)},QuarticIn:function(a){return a*a*a*a},QuarticOut:function(a){return 1- --a*a*a*a},QuarticInOut:function(a){return(a*=2)<1?.5*a*a*a*a:-.5*((a-=2)*a*a*a-2)},QuinticIn:function(a){return a*a*a*a*a},QuinticOut:function(a){return--a*a*a*a*a+1},QuinticInOut:function(a){return(a*=2)<1?.5*a*a*a*a*a:.5*((a-=2)*a*a*a*a+2)},SinusoidalIn:function(a){return 1-Math.cos(a*Math.PI/2)},SinusoidalOut:function(a){return Math.sin(a*Math.PI/2)},SinusoidalInOut:function(a){return.5*(1-Math.cos(Math.PI*a))},ExponentialIn:function(a){return 0===a?0:Math.pow(1024,a-1)},ExponentialOut:function(a){return 1===a?1:1-Math.pow(2,-10*a)},ExponentialInOut:function(a){return 0===a?0:1===a?1:(a*=2)<1?.5*Math.pow(1024,a-1):.5*(-Math.pow(2,-10*(a-1))+2)},CircularIn:function(a){return 1-Math.sqrt(1-a*a)},CircularOut:function(a){return Math.sqrt(1- --a*a)},CircularInOut:function(a){return(a*=2)<1?-.5*(Math.sqrt(1-a*a)-1):.5*(Math.sqrt(1-(a-=2)*a)+1)},ElasticIn:function(a){var b,c=.1,d=.4;return 0===a?0:1===a?1:(!c||1>c?(c=1,b=d/4):b=d*Math.asin(1/c)/(2*Math.PI),-(c*Math.pow(2,10*(a-=1))*Math.sin((a-b)*2*Math.PI/d)))},ElasticOut:function(a){var b,c=.1,d=.4;return 0===a?0:1===a?1:(!c||1>c?(c=1,b=d/4):b=d*Math.asin(1/c)/(2*Math.PI),c*Math.pow(2,-10*a)*Math.sin((a-b)*2*Math.PI/d)+1)},ElasticInOut:function(a){var b,c=.1,d=.4;return 0===a?0:1===a?1:(!c||1>c?(c=1,b=d/4):b=d*Math.asin(1/c)/(2*Math.PI),(a*=2)<1?-.5*c*Math.pow(2,10*(a-=1))*Math.sin((a-b)*2*Math.PI/d):.5*c*Math.pow(2,-10*(a-=1))*Math.sin((a-b)*2*Math.PI/d)+1)},BackIn:function(a){var b=1.70158;return a*a*((b+1)*a-b)},BackOut:function(a){var b=1.70158;return--a*a*((b+1)*a+b)+1},BackInOut:function(a){var b=2.5949095;return(a*=2)<1?.5*a*a*((b+1)*a-b):.5*((a-=2)*a*((b+1)*a+b)+2)},BounceIn:function(b){return 1-a.BounceOut(1-b)},BounceOut:function(a){return 1/2.75>a?7.5625*a*a:2/2.75>a?7.5625*(a-=1.5/2.75)*a+.75:2.5/2.75>a?7.5625*(a-=2.25/2.75)*a+.9375:7.5625*(a-=2.625/2.75)*a+.984375},BounceInOut:function(b){return.5>b?.5*a.BounceIn(2*b):.5*a.BounceOut(2*b-1)+.5
}};return a}),d("animation/Clip",["require","./easing"],function(a){var b=a("./easing"),c=function(a){this._targetPool=a.target||{},this._targetPool.constructor!=Array&&(this._targetPool=[this._targetPool]),this._life=a.life||1e3,this._delay=a.delay||0,this._startTime=(new Date).getTime()+this._delay,this._endTime=this._startTime+1e3*this._life,this._needsRemove=!1,this.loop="undefined"==typeof a.loop?!1:a.loop,this.loop&&(this._currentLoop="number"==typeof this.loop?this.loop:9999999),this.gap=a.gap||0,this.easing=a.easing||"Linear",this.onframe=a.onframe||null,this.ondestroy=a.ondestroy||null,this.onrestart=a.onrestart||null};return c.prototype={step:function(a){var c=(a-this._startTime)/this._life;if(!(0>c)){c=Math.min(c,1);var d,e="string"==typeof this.easing?b[this.easing]:this.easing;return d="function"==typeof e?e(c):c,this.fire("frame",d),1==c?this.loop&&this._currentLoop?(this.restart(),this._currentLoop--,"restart"):(this._needsRemove=!0,"destroy"):null}},restart:function(){this._startTime=(new Date).getTime()+this.gap},fire:function(a,b){for(var c="on"+a,d=0,e=this._targetPool.length;e>d;d++)this[c]&&this[c](this._targetPool[d],b)}},c.prototype.constructor=c,c}),d("animation/Animation",["require","./Clip","../core/Base"],function(a){function b(a,b){return a[b]}function c(a,b,c){a[b]=c}function d(a,b,c){return(b-a)*c+a}function e(a,b,c,e,f){var g=a.length;if(1==f)for(var h=0;g>h;h++)e[h]=d(a[h],b[h],c);else for(var i=a[0].length,h=0;g>h;h++)for(var j=0;i>j;j++)e[h][j]=d(a[h][j],b[h][j],c)}function f(a){return void 0===a?!1:"string"==typeof a?!1:void 0!==a.length}function g(a,b,c,d,e,f,g,i,j){var k=a.length;if(1==j)for(var l=0;k>l;l++)i[l]=h(a[l],b[l],c[l],d[l],e,f,g);else for(var m=a[0].length,l=0;k>l;l++)for(var n=0;m>n;n++)i[l][n]=h(a[l][n],b[l][n],c[l][n],d[l][n],e,f,g)}function h(a,b,c,d,e,f,g){var h=.5*(c-a),i=.5*(d-b);return(2*(b-c)+h+i)*g+(-3*(b-c)-2*h-i)*f+h*e+b}function i(a,d,e,f){this._tracks={},this._target=a,this._loop=d||!1,this._getter=e||b,this._setter=f||c,this._clipCount=0,this._delay=0,this._doneList=[],this._onframeList=[],this._clipList=[]}var j=a("./Clip"),k=a("../core/Base"),l=window.requestAnimationFrame||window.msRequestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(a){setTimeout(a,16)},m=Array.prototype.slice,n=k.derive(function(){return{stage:null,_clips:[],_running:!1,_time:0}},{add:function(a){this._clips.push(a)},remove:function(a){var b=this._clips.indexOf(a);b>=0&&this._clips.splice(b,1)},update:function(){for(var a=(new Date).getTime(),b=a-this._time,c=this._clips,d=c.length,e=[],f=[],g=0;d>g;g++){var h=c[g],i=h.step(a);i&&(e.push(i),f.push(h))}this.stage&&this.stage.render&&this._clips.length&&this.stage.render();for(var g=0;d>g;)c[g]._needsRemove?(c[g]=c[d-1],c.pop(),d--):g++;d=e.length;for(var g=0;d>g;g++)f[g].fire(e[g]);this._time=a,this.trigger("frame",b)},start:function(){function a(){b._running&&(l(a),b.update())}var b=this;this._running=!0,this._time=(new Date).getTime(),l(a)},stop:function(){this._running=!1},clear:function(){this._clips=[]},animate:function(a,b){b=b||{};var c=new i(a,b.loop,b.getter,b.setter);return c.animation=this,c}});return i.prototype={when:function(a,b){for(var c in b)this._tracks[c]||(this._tracks[c]=[],this._tracks[c].push({time:0,value:this._getter(this._target,c)})),this._tracks[c].push({time:parseInt(a),value:b[c]});return this},during:function(a){return this._onframeList.push(a),this},start:function(a){var b=this,c=this._setter,i=this._getter,k=b._onframeList.length,l="spline"===a,n=function(){if(b._clipCount--,0===b._clipCount){b._tracks={};for(var a=b._doneList.length,c=0;a>c;c++)b._doneList[c].call(b)}},o=function(o,p){var q=o.length;if(q){var r=o[0].value,s=f(r),t=s&&f(r[0])?2:1;if(o.sort(function(a,b){return a.time-b.time}),q){for(var u=o[q-1].time,v=[],w=[],x=0;q>x;x++)if(v.push(o[x].time/u),s)if(2==t){w[x]=[];for(var y=0;y<r.length;y++)w[x].push(m.call(o[x].value[y]))}else w.push(m.call(o[x].value));else w.push(o[x].value);var z,x,A,B,C,D,E,F=0,G=0,H=function(a,f){if(G>f){for(z=Math.min(F+1,q-1),x=z;x>=0&&!(v[x]<=f);x--);x=Math.min(x,q-2)}else{for(x=F;q>x&&!(v[x]>f);x++);x=Math.min(x-1,q-2)}F=x,G=f;var j=v[x+1]-v[x];if(0!=j)for(A=(f-v[x])/j,l?(C=w[x],B=w[0==x?x:x-1],D=w[x>q-2?q-1:x+1],E=w[x>q-3?q-1:x+2],s?g(B,C,D,E,A,A*A,A*A*A,i(a,p),t):c(a,p,h(B,C,D,E,A,A*A,A*A*A))):s?e(w[x],w[x+1],A,i(a,p),t):c(a,p,d(w[x],w[x+1],A)),x=0;k>x;x++)b._onframeList[x](a,f)},I=new j({target:b._target,life:u,loop:b._loop,delay:b._delay,onframe:H,ondestroy:n});a&&"spline"!==a&&(I.easing=a),b._clipList.push(I),b._clipCount++,b.animation.add(I)}}};for(var p in this._tracks)o(this._tracks[p],p);return this},stop:function(){for(var a=0;a<this._clipList.length;a++){var b=this._clipList[a];this.animation.remove(b)}this._clipList=[]},delay:function(a){return this._delay=a,this},done:function(a){return this._doneList.push(a),this}},n}),d("core/Event",["require","./Base"],function(a){var b=a("./Base"),c=b.derive({cancelBubble:!1},{stopPropagation:function(){this.cancelBubble=!0}});return c.throw=function(a,b,d){var e=new c(d);for(e.type=a,e.target=b;b&&!e.cancelBubble;)e.currentTarget=b,b.trigger(a,e),b=b.parent},c}),d("camera/Perspective",["require","../Camera"],function(a){var b=a("../Camera"),c=b.derive(function(){return{fov:50,aspect:1,near:.1,far:2e3}},{updateProjectionMatrix:function(){var a=this.fov/180*Math.PI;this.projectionMatrix.perspective(a,this.aspect,this.near,this.far)}});return c}),d("Stage",["require","./core/Base","./Layer","./animation/Animation","./core/Event","./Scene","./Renderer","./camera/Perspective","./2d/Scene","./2d/CanvasRenderer","./2d/Camera"],function(a){var b=a("./core/Base"),c=a("./Layer"),d=a("./animation/Animation"),e=a("./core/Event"),f=a("./Scene"),g=a("./Renderer"),h=a("./camera/Perspective"),i=a("./2d/Scene"),j=a("./2d/CanvasRenderer"),k=a("./2d/Camera"),l=b.derive(function(){return{container:null,width:100,height:100,_layers:[],_layersSorted:[],_mouseOverEl:null}},function(){this.container||(this.container=document.createElement("div")),"absolute"!==this.container.style.position&&"fixed"!==this.container.style.position&&(this.container.style.position="relative"),this.width?this.container.style.width=this.width+"px":this.width=Math.max(this.container.clientWidth,1),this.height?this.container.style.height=this.height+"px":this.height=Math.max(this.container.clientHeight,1),this.container.addEventListener("click",this._eventProxy.bind(this,"click")),this.container.addEventListener("dblclick",this._eventProxy.bind(this,"dblclick")),this.container.addEventListener("mousemove",this._mouseMoveHandler.bind(this)),this.container.addEventListener("mousedown",this._eventProxy.bind(this,"mousedown")),this.container.addEventListener("mouseup",this._eventProxy.bind(this,"mouseup")),this.container.addEventListener("mouseout",this._mouseOutHandler.bind(this)),this.animation=new d,this.animation.start(),this.animation.on("frame",function(a){this.trigger("frame",a)},this)},{createLayer2D:function(a){a=a||{},a.renderer=a.renderer||new j,a.camera=a.camera||new k,a.scene=a.scene||new i;var b=new c(a);return this.addLayer(b),b},createLayer3D:function(a){a=a||{},a.renderer=a.renderer||new g,a.camera||(a.camera=new h,a.camera.position.z=1,a.camera.aspect=this.width/this.height),a.scene=a.scene||new f;var b=new c(a);return this.addLayer(b),b},addLayer:function(a){if(!a.renderer)return console.warn("Layer don't have renderer"),void 0;if(!a.renderer.canvas)return console.warn("Layer renderer don't have canvas"),void 0;var b=a.renderer.canvas;a.renderer.resize(this.width,this.height),b.style.position="absolute",b.style.left="0px",b.style.top="0px",this.container.appendChild(b),this._layers.push(a),this._layersSorted=this._layers.slice().sort(function(a,b){return a.z===b.z?a.__GUID__>b.__GUID__?1:-1:a.z>b.z?1:-1})},removeLayer:function(a){this._layers.splice(this._layers.indexOf(a),1),this.container.removeChild(a.canvas)},resize:function(a,b){this.width=a,this.height=b;for(var c=0;c<this._layers.length;c++)this._layers[c].resize(a,b),this._layers[c].camera instanceof h&&(this._layers[c].camera.aspect=a/b)},render:function(){for(var a=0;a<this._layers.length;a++)this._layers[a].render()},_eventProxy:function(a,b){var c=this._assembleEvent(b),d=this._findTrigger(c);d&&e.throw(a,d,c),this.trigger(a,c)},_mouseMoveHandler:function(a){var b=this._findTrigger(a);b&&e.throw("mousemove",b,this._assembleEvent(a)),this._mouseOverEl!==b&&(this._mouseOverEl&&e.throw("mouseout",this._mouseOverEl,this._assembleEvent(a)),b&&e.throw("mouseover",b,this._assembleEvent(a)),this._mouseOverEl=b)},_mouseOutHandler:function(a){this._mouseOverEl&&e.throw("mouseout",this._mouseOverEl,this._assembleEvent(a))},_findTrigger:function(a){this.container;for(var b=a.x,c=a.y,d=this._layersSorted.length-1;d>=0;d--){var e=this._layersSorted[d],f=e.pick(b,c);if(f)return f}},_assembleEvent:function(a){var b=this.container.getBoundingClientRect();return{pageX:a.pageX,pageY:a.pageY,x:a.pageX-b.left-document.body.scrollLeft,y:a.pageY-b.top-document.body.scrollTop}}});return l}),d("camera/Orthographic",["require","../Camera"],function(a){var b=a("../Camera"),c=b.derive(function(){return{left:-1,right:1,near:-1,far:1,top:1,bottom:-1}},{updateProjectionMatrix:function(){this.projectionMatrix.ortho(this.left,this.right,this.bottom,this.top,this.near,this.far)}});return c}),d("compositor/Graph",["require","../core/Base","_"],function(a){var b=a("../core/Base"),c=a("_"),d=b.derive(function(){return{nodes:[]}},{add:function(a){this.nodes.push(a),this._dirty=!0},remove:function(a){c.without(this.nodes,a),this._dirty=!0},findNode:function(a){for(var b=0;b<this.nodes.length;b++)if(this.nodes[b].name===a)return this.nodes[b]},update:function(){for(var a=0;a<this.nodes.length;a++)this.nodes[a].clear();for(var a=0;a<this.nodes.length;a++){var b=this.nodes[a];if(b.inputs)for(var c in b.inputs){var d=b.inputs[c],e=this.findPin(d);e?b.link(c,e.node,e.pin):console.warn("Pin of "+d.node+"."+d.pin+" not exist")}}},findPin:function(a){var b;if("string"==typeof a.node)for(var c=0;c<this.nodes.length;c++){var d=this.nodes[c];d.name===a.node&&(b=d)}else b=a.node;return b&&b.outputs[a.pin]?{node:b,pin:a.pin}:void 0},fromJSON:function(){}});return d}),d("compositor/Compositor",["require","./Graph"],function(a){var b=a("./Graph"),c=b.derive(function(){return{_outputs:[]}},{render:function(a){this._dirty&&(this.update(),this._dirty=!1);for(var b=0;b<this.nodes.length;b++){var c=this.nodes[b];c.beforeFrame()}for(var b=0;b<this.nodes.length;b++){var c=this.nodes[b];c.outputs||c.render(a)}for(var b=0;b<this._outputs.length;b++)this._outputs[b].render(a)},addOutput:function(a){a.outputs&&this._outputs.push(a)},removeOutput:function(a){this._outputs.splice(this._outputs.indexOf(a),1)}});return c}),d("geometry/Plane",["require","../Geometry","../math/BoundingBox"],function(a){var b=a("../Geometry"),c=a("../math/BoundingBox"),d=b.derive(function(){return{widthSegments:1,heightSegments:1}},function(){for(var a=this.heightSegments,b=this.widthSegments,d=this.attributes.position.value,e=this.attributes.texcoord0.value,f=this.attributes.normal.value,g=this.faces,h=0;a>=h;h++)for(var i=h/a,j=0;b>=j;j++){var k=j/b;if(d.push([2*k-1,2*i-1,0]),e&&e.push([k,i]),f&&f.push([0,0,1]),b>j&&a>h){var l=j+h*(b+1);g.push([l,l+1,l+b+1]),g.push([l+b+1,l+1,l+b+2])}}this.boundingBox=new c,this.boundingBox.min.set(-1,-1,0),this.boundingBox.max.set(1,1,0)});return d}),d("compositor/shaders/vertex.essl",[],function(){return"uniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\nattribute vec2 texcoord : TEXCOORD_0;\n\nvarying vec2 v_Texcoord;\n\nvoid main()\n{\n\n    v_Texcoord = texcoord;\n    gl_Position = worldViewProjection * vec4(position, 1.0);\n}"}),d("compositor/shaders/coloradjust.essl",[],function(){return'@export buildin.compositor.coloradjust\n\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float brightness : 0.0;\nuniform float contrast : 1.0;\nuniform float exposure : 0.0;\nuniform float gamma : 1.0;\nuniform float saturation : 1.0;\n\n// Values from "Graphics Shaders: Theory and Practice" by Bailey and Cunningham\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord);\n\n    // brightness\n    vec3 color = clamp(tex.rgb + vec3(brightness), 0.0, 1.0);\n    // contrast\n    color = clamp( (color-vec3(0.5))*contrast+vec3(0.5), 0.0, 1.0);\n    // exposure\n    color = clamp( color * pow(2.0, exposure), 0.0, 1.0);\n    // gamma\n    color = clamp( pow(color, vec3(gamma)), 0.0, 1.0);\n    // saturation\n    float luminance = dot( color, w );\n    color = mix(vec3(luminance), color, saturation);\n    \n    gl_FragColor = vec4(color, tex.a);\n}\n\n@end\n\n// Seperate shader for float texture\n@export buildin.compositor.brightness\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float brightness : 0.0;\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord);\n    vec3 color = tex.rgb + vec3(brightness);\n    gl_FragColor = vec4(color, tex.a);\n}\n@end\n\n@export buildin.compositor.contrast\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float contrast : 1.0;\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord);\n    vec3 color = (tex.rgb-vec3(0.5))*contrast+vec3(0.5);\n    gl_FragColor = vec4(color, tex.a);\n}\n@end\n\n@export buildin.compositor.exposure\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float exposure : 0.0;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n    vec3 color = tex.rgb * pow(2.0, exposure);\n    gl_FragColor = vec4(color, tex.a);\n}\n@end\n\n@export buildin.compositor.gamma\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float gamma : 1.0;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n    vec3 color = pow(tex.rgb, vec3(gamma));\n    gl_FragColor = vec4(color, tex.a);\n}\n@end\n\n@export buildin.compositor.saturation\nvarying vec2 v_Texcoord;\nuniform sampler2D texture;\n\nuniform float saturation : 1.0;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n    vec3 color = tex.rgb;\n    float luminance = dot(color, w);\n    color = mix(vec3(luminance), color, saturation);\n    gl_FragColor = vec4(color, tex.a);\n}\n@end'}),d("compositor/shaders/blur.essl",[],function(){return"@export buildin.compositor.gaussian_blur_h\n\nuniform sampler2D texture; // the texture with the scene you want to blur\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 2.0; \nuniform float textureWidth : 512.0;\n\nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n   float blurOffset = blurSize / textureWidth;\n   // blur in y (vertical)\n   // take nine samples, with the distance blurSize between them\n   sum += texture2D(texture, vec2(max(v_Texcoord.x - 4.0*blurOffset, 0.0), v_Texcoord.y)) * 0.05;\n   sum += texture2D(texture, vec2(max(v_Texcoord.x - 3.0*blurOffset, 0.0), v_Texcoord.y)) * 0.09;\n   sum += texture2D(texture, vec2(max(v_Texcoord.x - 2.0*blurOffset, 0.0), v_Texcoord.y)) * 0.12;\n   sum += texture2D(texture, vec2(max(v_Texcoord.x - blurOffset, 0.0), v_Texcoord.y)) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y)) * 0.18;\n   sum += texture2D(texture, vec2(min(v_Texcoord.x + blurOffset, 1.0), v_Texcoord.y)) * 0.15;\n   sum += texture2D(texture, vec2(min(v_Texcoord.x + 2.0*blurOffset, 1.0), v_Texcoord.y)) * 0.12;\n   sum += texture2D(texture, vec2(min(v_Texcoord.x + 3.0*blurOffset, 1.0), v_Texcoord.y)) * 0.09;\n   sum += texture2D(texture, vec2(min(v_Texcoord.x + 4.0*blurOffset, 1.0), v_Texcoord.y)) * 0.05;\n \n   gl_FragColor = sum;\n}\n\n@end\n\n@export buildin.compositor.gaussian_blur_v\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n \nuniform float blurSize : 2.0;\nuniform float textureHeight : 512.0;\n \nvoid main(void)\n{\n   vec4 sum = vec4(0.0);\n   float blurOffset = blurSize / textureHeight;\n   // blur in y (vertical)\n   // take nine samples, with the distance blurSize between them\n   sum += texture2D(texture, vec2(v_Texcoord.x, max(v_Texcoord.y - 4.0*blurOffset, 0.0))) * 0.05;\n   sum += texture2D(texture, vec2(v_Texcoord.x, max(v_Texcoord.y - 3.0*blurOffset, 0.0))) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x, max(v_Texcoord.y - 2.0*blurOffset, 0.0))) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x, max(v_Texcoord.y - blurOffset, 0.0))) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, v_Texcoord.y)) * 0.18;\n   sum += texture2D(texture, vec2(v_Texcoord.x, min(v_Texcoord.y + blurOffset, 1.0))) * 0.15;\n   sum += texture2D(texture, vec2(v_Texcoord.x, min(v_Texcoord.y + 2.0*blurOffset, 1.0))) * 0.12;\n   sum += texture2D(texture, vec2(v_Texcoord.x, min(v_Texcoord.y + 3.0*blurOffset, 1.0))) * 0.09;\n   sum += texture2D(texture, vec2(v_Texcoord.x, min(v_Texcoord.y + 4.0*blurOffset, 1.0))) * 0.05;\n \n   gl_FragColor = sum;\n}\n\n@end\n\n@export buildin.compositor.box_blur\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 3.0;\nuniform vec2 textureSize : [512.0, 512.0];\n\nvoid main(void){\n\n   vec4 tex = texture2D(texture, v_Texcoord);\n   vec2 offset = blurSize / textureSize;\n\n   tex += texture2D(texture, v_Texcoord + vec2(offset.x, 0.0) );\n   tex += texture2D(texture, v_Texcoord + vec2(offset.x, offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offset.x, offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(0.0, offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offset.x, 0.0) );\n   tex += texture2D(texture, v_Texcoord + vec2(-offset.x, -offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(offset.x, -offset.y) );\n   tex += texture2D(texture, v_Texcoord + vec2(0.0, -offset.y) );\n\n   tex /= 9.0;\n\n   gl_FragColor = tex;\n}\n\n@end\n\n// http://www.slideshare.net/DICEStudio/five-rendering-ideas-from-battlefield-3-need-for-speed-the-run\n@export buildin.compositor.hexagonal_blur_mrt_1\n\n// MRT in chrome\n// https://www.khronos.org/registry/webgl/sdk/tests/conformance/extensions/webgl-draw-buffers.html\n#extension GL_EXT_draw_buffers : require\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 2.0;\n\nuniform vec2 textureSize : [512.0, 512.0];\n\nvoid main(void){\n   vec2 offset = blurSize / textureSize;\n\n   vec4 color = vec4(0.0);\n   // Top\n   for(int i = 0; i < 10; i++){\n      color += 1.0/10.0 * texture2D(texture, v_Texcoord + vec2(0.0, offset.y * float(i)) );\n   }\n   gl_FragData[0] = color;\n   vec4 color2 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color2 += 1.0/10.0 * texture2D(texture, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   gl_FragData[1] = (color + color2) / 2.0;\n}\n\n@end\n\n@export buildin.compositor.hexagonal_blur_mrt_2\n\nuniform sampler2D texture0;\nuniform sampler2D texture1;\n\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 2.0;\n\nuniform vec2 textureSize : [512.0, 512.0];\n\nvoid main(void){\n   vec2 offset = blurSize / textureSize;\n\n   vec4 color1 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color1 += 1.0/10.0 * texture2D(texture0, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   vec4 color2 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 10; i++){\n      color2 += 1.0/10.0 * texture2D(texture1, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   gl_FragColor = (color1 + color2) / 2.0;\n}\n\n@end\n\n\n@export buildin.compositor.hexagonal_blur_1\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform vec2 textureSize : [512.0, 512.0];\n\nvoid main(void){\n   vec2 offset = blurSize / textureSize;\n\n   vec4 color = vec4(0.0);\n   // Top\n   for(int i = 0; i < 10; i++){\n      color += 1.0/10.0 * texture2D(texture, v_Texcoord + vec2(0.0, offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n\n@end\n\n@export buildin.compositor.hexagonal_blur_2\n\nuniform sampler2D texture;\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform vec2 textureSize : [512.0, 512.0];\n\nvoid main(void){\n   vec2 offset = blurSize / textureSize;\n\n   vec4 color = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color += 1.0/10.0 * texture2D(texture, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   gl_FragColor = color;\n}\n@end\n\n@export buildin.compositor.hexagonal_blur_3\n\nuniform sampler2D texture1;\nuniform sampler2D texture2;\n\nvarying vec2 v_Texcoord;\n\nuniform float blurSize : 1.0;\n\nuniform vec2 textureSize : [512.0, 512.0];\n\nvoid main(void){\n   vec2 offset = blurSize / textureSize;\n\n   vec4 color1 = vec4(0.0);\n   // Down left\n   for(int i = 0; i < 10; i++){\n      color1 += 1.0/10.0 * texture2D(texture1, v_Texcoord - vec2(offset.x * float(i), offset.y * float(i)) );\n   }\n   vec4 color2 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 10; i++){\n      color2 += 1.0/10.0 * texture2D(texture1, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   vec4 color3 = vec4(0.0);\n   // Down right\n   for(int i = 0; i < 10; i++){\n      color3 += 1.0/10.0 * texture2D(texture2, v_Texcoord + vec2(offset.x * float(i), -offset.y * float(i)) );\n   }\n\n   gl_FragColor = (color1 + color2 + color3) / 3.0;\n}\n\n@end"}),d("compositor/shaders/lum.essl",[],function(){return"\n@export buildin.compositor.lum\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    vec4 tex = texture2D( texture, v_Texcoord );\n    float luminance = dot(tex.rgb, w);\n\n    gl_FragColor = vec4(vec3(luminance), 1.0);\n}\n\n@end"}),d("compositor/shaders/lut.essl",[],function(){return"\n// https://github.com/BradLarson/GPUImage?source=c\n@export buildin.compositor.lut\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\nuniform sampler2D lookup;\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n\n    float blueColor = tex.b * 63.0;\n    \n    vec2 quad1;\n    quad1.y = floor(floor(blueColor) / 8.0);\n    quad1.x = floor(blueColor) - (quad1.y * 8.0);\n    \n    vec2 quad2;\n    quad2.y = floor(ceil(blueColor) / 8.0);\n    quad2.x = ceil(blueColor) - (quad2.y * 8.0);\n    \n    vec2 texPos1;\n    texPos1.x = (quad1.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos1.y = (quad1.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec2 texPos2;\n    texPos2.x = (quad2.x * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.r);\n    texPos2.y = (quad2.y * 0.125) + 0.5/512.0 + ((0.125 - 1.0/512.0) * tex.g);\n    \n    vec4 newColor1 = texture2D(lookup, texPos1);\n    vec4 newColor2 = texture2D(lookup, texPos2);\n    \n    vec4 newColor = mix(newColor1, newColor2, fract(blueColor));\n    gl_FragColor = vec4(newColor.rgb, tex.w);\n}\n\n@end"}),d("compositor/shaders/output.essl",[],function(){return"@export buildin.compositor.output\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\n\nvoid main()\n{\n    vec3 tex = texture2D( texture, v_Texcoord ).rgb;\n\n    gl_FragColor = vec4(tex, 1.0);\n}\n\n@end"}),d("compositor/shaders/hdr.essl",[],function(){return"// HDR Pipeline\n@export buildin.compositor.hdr.bright\n\nuniform sampler2D texture;\nuniform float threshold : 1;\nuniform float scale : 1.0;\n\nvarying vec2 v_Texcoord;\n\nconst vec3 lumWeight = vec3(0.2125, 0.7154, 0.0721);\nvoid main()\n{\n    vec3 tex = vec3(0.0);\n    #ifdef TEXTURE_ENABLED\n        tex = texture2D(texture, v_Texcoord).rgb;\n    #endif\n    float lum = dot(tex, lumWeight);\n    if (lum > threshold)\n    {\n        gl_FragColor.rgb = tex * scale;\n    }\n    else\n    {\n        gl_FragColor.rgb = vec3(0.0);\n    }\n    gl_FragColor.a = 1.0;\n}\n@end\n\n@export buildin.compositor.hdr.log_lum\n\nvarying vec2 v_Texcoord;\n\nuniform sampler2D texture;\n\nconst vec3 w = vec3(0.2125, 0.7154, 0.0721);\n\nvoid main()\n{\n    vec4 tex = texture2D(texture, v_Texcoord);\n    float luminance = dot(tex.rgb, w);\n    luminance = log(luminance + 0.001);\n\n    gl_FragColor = vec4(vec3(luminance), 1.0);\n}\n\n@end\n\n@export buildin.compositor.hdr.lum_adaption\nvarying vec2 v_Texcoord;\n\nuniform sampler2D adaptedLum;\nuniform sampler2D currentLum;\n\nuniform float frameTime : 0.02;\n\nvoid main()\n{\n    float fAdaptedLum = texture2D(adaptedLum, vec2(0.5, 0.5)).r;\n    float fCurrentLum = exp(texture2D(currentLum, vec2(0.5, 0.5)).r);\n\n    fAdaptedLum += (fCurrentLum - fAdaptedLum) * (1.0 - pow(0.98, 60.0 * frameTime));\n    gl_FragColor.rgb = vec3(fAdaptedLum);\n    gl_FragColor.a = 1.0;\n}\n@end\n\n// Tone mapping with gamma correction\n// http://filmicgames.com/archives/75\n@export buildin.compositor.hdr.tonemapping\n\nuniform sampler2D texture;\nuniform sampler2D bloom;\nuniform sampler2D lensflare;\nuniform sampler2D lum;\n\nvarying vec2 v_Texcoord;\n\nconst float A = 0.22;\nconst float B = 0.30;\nconst float C = 0.10;\nconst float D = 0.20;\nconst float E = 0.01;\nconst float F = 0.30;\nconst vec3 W = vec3(11.2);\n\nvec3 uncharted2Tonemap(vec3 x)\n{\n    return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nfloat eyeAdaption(float fLum)\n{\n    return mix(0.2, fLum, 0.5);\n}\n\nvoid main()\n{\n    vec3 tex = vec3(0.0);\n    #ifdef TEXTURE_ENABLED\n        tex = texture2D(texture, v_Texcoord).rgb;\n    #endif\n\n    #ifdef BLOOM_ENABLED\n        tex += texture2D(bloom, v_Texcoord).rgb * 0.25;\n    #endif\n\n    #ifdef LENSFLARE_ENABLED\n        tex += texture2D(lensflare, v_Texcoord).rgb;\n    #endif\n\n    // From KlayGE\n    #ifdef LUM_ENABLED\n        float fLum = texture2D(lum, vec2(0.5, 0.5)).r;\n        float adaptedLumDest = 3.0 / (max(0.1, 1.0 + 10.0*eyeAdaption(fLum)));\n        float exposureBias = adaptedLumDest * 1.6;\n    #else\n        float exposureBias = 1.0;\n    #endif\n    vec3 curr = uncharted2Tonemap(exposureBias * tex);\n\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(W);\n    vec3 color = curr * whiteScale;\n\n    color = pow(color, vec3(1.0/2.2));\n    gl_FragColor = vec4(color, 1.0);\n}\n\n@end"}),d("compositor/shaders/lensflare.essl",[],function(){return"// john-chapman-graphics.blogspot.co.uk/2013/02/pseudo-lens-flare.html\n@export buildin.compositor.lensflare\n\n#define SAMPLE_NUMBER 8\n\nuniform sampler2D texture;\nuniform sampler2D lensColor;\n\nuniform vec2 textureSize : [512, 512];\n\nuniform float dispersal : 0.3;\nuniform float haloWidth : 0.4;\nuniform float distortion : 1.0;\n\nvarying vec2 v_Texcoord;\n\nvec4 textureDistorted(\n    in vec2 texcoord,\n    in vec2 direction,\n    in vec3 distortion\n) {\n    return vec4(\n        texture2D(texture, texcoord + direction * distortion.r).r,\n        texture2D(texture, texcoord + direction * distortion.g).g,\n        texture2D(texture, texcoord + direction * distortion.b).b,\n        1.0\n    );\n}\n\nvoid main()\n{\n    vec2 texcoord = -v_Texcoord + vec2(1.0); // Flip texcoords\n    vec2 textureOffset = 1.0 / textureSize;\n\n    vec2 ghostVec = (vec2(0.5) - texcoord) * dispersal;\n    vec2 haloVec = normalize(ghostVec) * haloWidth;\n\n    vec3 distortion = vec3(-textureOffset.x * distortion, 0.0, textureOffset.x * distortion);\n    //Sample ghost\n    vec4 result = vec4(0.0);\n    for (int i = 0; i < SAMPLE_NUMBER; i++)\n    {\n        vec2 offset = fract(texcoord + ghostVec * float(i));\n\n        float weight = length(vec2(0.5) - offset) / length(vec2(0.5));\n        weight = pow(1.0 - weight, 10.0);\n\n        result += textureDistorted(offset, normalize(ghostVec), distortion) * weight;\n    }\n\n    result *= texture2D(lensColor, vec2(length(vec2(0.5) - texcoord)) / length(vec2(0.5)));\n    //Sample halo\n    float weight = length(vec2(0.5) - fract(texcoord + haloVec)) / length(vec2(0.5));\n    weight = pow(1.0 - weight, 10.0);\n    vec2 offset = fract(texcoord + haloVec);\n    result += textureDistorted(offset, normalize(ghostVec), distortion) * weight;\n\n    gl_FragColor = result;\n}\n@end"}),d("compositor/shaders/blend.essl",[],function(){return"@export buildin.compositor.blend\n// Blend at most 4 textures\n#ifdef TEXTURE1_ENABLED\nuniform sampler2D texture1;\nuniform float weight1 : 1.0;\n#endif\n#ifdef TEXTURE2_ENABLED\nuniform sampler2D texture2;\nuniform float weight2 : 1.0;\n#endif\n#ifdef TEXTURE3_ENABLED\nuniform sampler2D texture3;\nuniform float weight3 : 1.0;\n#endif\n#ifdef TEXTURE4_ENABLED\nuniform sampler2D texture4;\nuniform float weight4 : 1.0;\n#endif\n\nvarying vec2 v_Texcoord;\n\nvoid main()\n{\n    vec3 tex = vec3(0.0);\n    #ifdef TEXTURE1_ENABLED\n        tex += texture2D(texture1, v_Texcoord).rgb * weight1;\n    #endif\n    #ifdef TEXTURE2_ENABLED\n        tex += texture2D(texture2, v_Texcoord).rgb * weight2;\n    #endif\n    #ifdef TEXTURE3_ENABLED\n        tex += texture2D(texture3, v_Texcoord).rgb * weight3;\n    #endif\n    #ifdef TEXTURE4_ENABLED\n        tex += texture2D(texture4, v_Texcoord).rgb * weight4;\n    #endif\n\n    gl_FragColor = vec4(tex, 1.0);\n}\n@end"}),d("compositor/shaders/fxaa.essl",[],function(){return"// https://github.com/mitsuhiko/webgl-meincraft/blob/master/assets/shaders/fxaa.glsl\n@export buildin.compositor.fxaa\n\nuniform sampler2D texture;\nuniform vec2 viewportSize : [512, 512];\n\nvarying vec2 v_Texcoord;\n\n#define FXAA_REDUCE_MIN   (1.0/128.0)\n#define FXAA_REDUCE_MUL   (1.0/8.0)\n#define FXAA_SPAN_MAX     8.0\n\nvoid main()\n{\n    vec2 resolution = 1.0 / viewportSize;\n    vec3 rgbNW = texture2D( texture, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;\n    vec3 rgbNE = texture2D( texture, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;\n    vec3 rgbSW = texture2D( texture, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;\n    vec3 rgbSE = texture2D( texture, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;\n    vec4 rgbaM  = texture2D( texture,  gl_FragCoord.xy  * resolution );\n    vec3 rgbM  = rgbaM.xyz;\n    float opacity  = rgbaM.w;\n\n    vec3 luma = vec3( 0.299, 0.587, 0.114 );\n\n    float lumaNW = dot( rgbNW, luma );\n    float lumaNE = dot( rgbNE, luma );\n    float lumaSW = dot( rgbSW, luma );\n    float lumaSE = dot( rgbSE, luma );\n    float lumaM  = dot( rgbM,  luma );\n    float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );\n    float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );\n\n    vec2 dir;\n    dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\n    dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\n\n    float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );\n\n    float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );\n    dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),\n          max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),\n                dir * rcpDirMin)) * resolution;\n\n    vec3 rgbA = texture2D( texture, gl_FragCoord.xy  * resolution + dir * ( 1.0 / 3.0 - 0.5 ) ).xyz;\n    rgbA += texture2D( texture, gl_FragCoord.xy  * resolution + dir * ( 2.0 / 3.0 - 0.5 ) ).xyz;\n    rgbA *= 0.5;\n\n    vec3 rgbB = texture2D( texture, gl_FragCoord.xy  * resolution + dir * -0.5 ).xyz;\n    rgbB += texture2D( texture, gl_FragCoord.xy  * resolution + dir * 0.5 ).xyz;\n    rgbB *= 0.25;\n    rgbB += rgbA * 0.5;\n\n    float lumaB = dot( rgbB, luma );\n\n    if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) )\n    {\n\n        gl_FragColor = vec4( rgbA, opacity );\n\n    } else {\n\n        gl_FragColor = vec4( rgbB, opacity );\n\n    }\n}\n\n@end"}),d("compositor/Pass",["require","../core/Base","../Scene","../camera/Orthographic","../geometry/Plane","../Shader","../Material","../Mesh","../Scene","./shaders/vertex.essl","../Texture","../core/glinfo","../core/glenum","./shaders/coloradjust.essl","./shaders/blur.essl","./shaders/lum.essl","./shaders/lut.essl","./shaders/output.essl","./shaders/hdr.essl","./shaders/lensflare.essl","./shaders/blend.essl","./shaders/fxaa.essl"],function(a){var b=a("../core/Base"),c=a("../Scene"),d=a("../camera/Orthographic"),e=a("../geometry/Plane"),f=a("../Shader"),g=a("../Material"),h=a("../Mesh"),c=a("../Scene"),i=a("./shaders/vertex.essl");
a("../Texture");var j=a("../core/glinfo"),k=a("../core/glenum"),l=new e,m=new h({geometry:l}),n=new c,o=new d;n.add(m);var p=b.derive(function(){return{fragment:"",outputs:null,material:null}},function(){var a=new f({vertex:i,fragment:this.fragment}),b=new g({shader:a});a.enableTexturesAll(),this.material=b},{setUniform:function(a,b){var c=this.material.uniforms[a];c&&(c.value=b)},getUniform:function(a){var b=this.material.uniforms[a];return b?b.value:void 0},attachOutput:function(a,b){this.outputs||(this.outputs={}),b=b||k.COLOR_ATTACHMENT0,this.outputs[b]=a},detachOutput:function(a){for(var b in this.outputs)this.outputs[b]===a&&(this.outputs[b]=null)},bind:function(a,b){if(this.outputs){var c=!1;for(var d in this.outputs){var e=this.outputs[d];e&&(c=!0,b.attach(a.gl,e,d))}c&&b.bind(a)}},unbind:function(a,b){b.unbind(a)},render:function(a,b){var c=a.gl;m.material=this.material,b&&this.bind(a,b);var d=j.getExtension(c,"EXT_draw_buffers");if(d){var e=[];for(var f in this.outputs)f=parseInt(f),f>=c.COLOR_ATTACHMENT0&&f<=c.COLOR_ATTACHMENT0+8&&e.push(f);d.drawBuffersEXT(e)}this.trigger("beforerender",this,a),a.render(n,o),this.trigger("afterrender",this,a),b&&this.unbind(a,b)}});return f.import(a("./shaders/coloradjust.essl")),f.import(a("./shaders/blur.essl")),f.import(a("./shaders/lum.essl")),f.import(a("./shaders/lut.essl")),f.import(a("./shaders/output.essl")),f.import(a("./shaders/hdr.essl")),f.import(a("./shaders/lensflare.essl")),f.import(a("./shaders/blend.essl")),f.import(a("./shaders/fxaa.essl")),p}),d("compositor/texturePool",["require","../texture/Texture2D","../core/glenum","_"],function(a){function b(a){h.defaults(a,k),c(a);var b="";for(var d in k){var e=a[d].toString();b+=e}return b}function c(a){var b=d(a.width,a.height);a.format===g.DEPTH_COMPONENT&&(a.useMipmap=!1),b&&a.useMipmap||(a.minFilter==g.NEAREST_MIPMAP_NEAREST||a.minFilter==g.NEAREST_MIPMAP_LINEAR?a.minFilter=g.NEAREST:(a.minFilter==g.LINEAR_MIPMAP_LINEAR||a.minFilter==g.LINEAR_MIPMAP_NEAREST)&&(a.minFilter=g.LINEAR),a.wrapS=g.CLAMP_TO_EDGE,a.wrapT=g.CLAMP_TO_EDGE)}function d(a,b){return 0===(a&a-1)&&0===(b&b-1)}var e=a("../texture/Texture2D"),g=a("../core/glenum"),h=a("_"),i={},j={get:function(a){var c=b(a);i.hasOwnProperty(c)||(i[c]=[]);var d=i[c];if(!d.length){var f=new e(a);return f}return d.pop()},put:function(a){var c=b(a);i.hasOwnProperty(c)||(i[c]=[]);var d=i[c];d.push(a)},clear:function(a){for(f in i)for(var b=0;b<i[f].length;b++)i[f][b].dispose(a);i={}}},k={width:512,height:512,type:g.UNSIGNED_BYTE,format:g.RGBA,wrapS:g.CLAMP_TO_EDGE,wrapT:g.CLAMP_TO_EDGE,minFilter:g.LINEAR_MIPMAP_LINEAR,magFilter:g.LINEAR,useMipmap:!0,anisotropic:1,flipY:!0,unpackAlignment:4,premultiplyAlpha:!1};return j}),d("compositor/Node",["require","../core/Base","./Pass","../FrameBuffer","../Shader","./texturePool"],function(a){var b=a("../core/Base"),c=a("./Pass"),d=a("../FrameBuffer");a("../Shader");var e=a("./texturePool"),f=b.derive(function(){return{name:"",inputs:{},outputs:null,shader:"",inputLinks:{},outputLinks:{},pass:null,_prevOutputTextures:{},_outputTextures:{},_outputReferences:{},_rendering:!1,_rendered:!1}},function(){var a=new c({fragment:this.shader});this.pass=a,this.outputs&&(this.frameBuffer=new d({depthBuffer:!1}))},{render:function(a){this._rendering=!0;var b=a.gl;for(var c in this.inputLinks){var d=this.inputLinks[c],f=d.node.getOutput(a,d.pin);this.pass.setUniform(c,f)}if(this.outputs){this.pass.outputs={};for(var g in this.outputs){var h=this.updateParameter(g,a),i=this.outputs[g],j=e.get(h);this._outputTextures[g]=j;var k=i.attachment||b.COLOR_ATTACHMENT0;"string"==typeof k&&(k=b[k]),this.pass.outputs[k]=j}this.pass.render(a,this.frameBuffer)}else this.pass.outputs=null,this.pass.render(a);for(var c in this.inputLinks){var d=this.inputLinks[c];d.node.removeReference(d.pin)}this._rendering=!1,this._rendered=!0},updateParameter:function(a,b){var c=this.outputs[a],d=c.parameters,e=c._parametersCopy;if(e||(e=c._parametersCopy={}),d)for(var f in d)"width"!==f&&"height"!==f&&(e[f]=d[f]);var g,h;return g=d.width instanceof Function?d.width(b):d.width,h=d.height instanceof Function?d.height(b):d.height,(e.width!==g||e.height!==h)&&this._outputTextures[a]&&this._outputTextures[a].dispose(b.gl),e.width=g,e.height=h,e},setParameter:function(a,b){this.pass.setUniform(a,b)},getParameter:function(a){return this.pass.getUniform(a)},setParameters:function(a){for(var b in a)this.setParameter(b,a[b])},setShader:function(a){var b=this.pass.material;b.shader.setFragment(a),b.attachShader(shader,!0)},getOutput:function(a,b){if(void 0===b)return b=a,this._outputTextures[b];var c=this.outputs[b];if(c)return this._rendered?this._outputTextures[b]:this._rendering||c.outputLastFrame?(this._prevOutputTextures[b]||(this._prevOutputTextures[b]=e.get(c.parameters||{})),this._prevOutputTextures[b]):(this.render(a),this._outputTextures[b])},removeReference:function(a){if(this._outputReferences[a]--,0===this._outputReferences[a]){var b=this.outputs[a];b.keepLastFrame?(this._prevOutputTextures[a]&&e.put(this._prevOutputTextures[a]),this._prevOutputTextures[a]=this._outputTextures[a]):e.put(this._outputTextures[a])}},link:function(a,b,c){this.inputLinks[a]={node:b,pin:c},b.outputLinks[c]||(b.outputLinks[c]=[]),b.outputLinks[c].push({node:this,pin:a});var d=this.pass.material.shader;d.enableTexture(a)},clear:function(){this.inputLinks={},this.outputLinks={};var a=this.pass.material.shader;a.disableTexturesAll()},beforeFrame:function(){this._rendered=!1;for(var a in this.outputLinks)this._outputReferences[a]=this.outputLinks[a].length}});return f}),d("compositor/Group",["require","./Node","./Graph"],function(a){var b=a("./Node"),c=a("./Graph"),d=b.derive(function(){return{nodes:[],_outputTextures:{}}},{add:function(a){return c.prototype.add.call(this,a)},remove:function(a){return c.prototype.remove.call(this,a)},update:function(){return c.prototype.update.call(this)},findNode:function(){return c.prototype.findNode.call(this)},findPin:function(a){return c.prototype.findPin.call(this,a)},render:function(a){this._dirty&&(this.update(),this._dirty=!1);var b={};for(var c in this.inputLinks){var d=this.inputLinks[c],e=d.node.getOutput(a,d.pin);b[c]=e}for(var f=0;f<this.nodes.length;f++){var g=this.nodes[f];g.beforeFrame(),g.groupInputs&&this._updateGroupInputs(g,b)}for(var f=0;f<this.nodes.length;f++){var g=this.nodes[f];g.groupOutputs&&this._updateGroupOutputs(g,a),g.outputs||g.render(a)}for(var h in this.groupOutputs)this._outputTextures[h]||console.error('Group output pin "'+h+'" is not attached');for(var c in this.inputLinks){var d=this.inputLinks[c];d.node.removeReference(d.pin)}},_updateGroupInputs:function(a,b){for(var c in b){var d=b[c];if(a.groupInputs[c]){var e=a.groupInputs[c];a.pass.setUniform(e,d)}}},_updateGroupOutputs:function(a,b){for(var c in a.groupOutputs){var d=a.groupOutputs[c],e=a.getOutput(b,c);this._outputTextures[d]=e}}});return d}),d("compositor/SceneNode",["require","./Node","./Pass","../FrameBuffer","./texturePool","../core/glinfo"],function(a){var b=a("./Node");a("./Pass"),a("../FrameBuffer");var c=a("./texturePool"),d=a("../core/glinfo"),e=b.derive(function(){return{name:"scene",scene:null,camera:null,autoUpdateScene:!0,preZ:!1}},function(){this.frameBuffer&&(this.frameBuffer.depthBuffer=!0)},{render:function(a){this._rendering=!0;var b=a.gl;if(this.outputs){var e=this.frameBuffer;for(var f in this.outputs){var g=this.updateParameter(f,a),h=this.outputs[f],i=c.get(g);this._outputTextures[f]=i;var j=h.attachment||b.COLOR_ATTACHMENT0;"string"==typeof j&&(j=b[j]),e.attach(a.gl,i,j)}e.bind(a);var k=d.getExtension(b,"EXT_draw_buffers");if(k){var l=[];for(var j in this.outputs)j=parseInt(j),j>=b.COLOR_ATTACHMENT0&&j<=b.COLOR_ATTACHMENT0+8&&l.push(j);k.drawBuffersEXT(l)}a.render(this.scene,this.camera,!this.autoUpdateScene,this.preZ),e.unbind(a)}else a.render(this.scene,this.camera);this._rendering=!1,this._rendered=!0}});return e}),d("compositor/TextureNode",["require","./Node","../FrameBuffer","./texturePool","../Shader"],function(a){var b=a("./Node");a("../FrameBuffer");var c=a("./texturePool"),d=a("../Shader"),e=b.derive(function(){return{shader:d.source("buildin.compositor.output"),texture:null}},{render:function(a){this._rendering=!0;var b=a.gl;if(this.pass.setUniform("texture",this.texture),this.outputs){this.pass.outputs={};for(var d in this.outputs){var e=this.updateParameter(d,a),f=this.outputs[d],g=c.get(e);this._outputTextures[d]=g;var h=f.attachment||b.COLOR_ATTACHMENT0;"string"==typeof h&&(h=b[h]),this.pass.outputs[h]=g}this.pass.render(a,this.frameBuffer)}else this.pass.outputs=null,this.pass.render(a);this._rendering=!1,this._rendered=!0}});return e}),d("core/request",["require"],function(){function a(a){var b=new XMLHttpRequest;b.open("get",a.url),b.responseType=a.responseType||"text",a.onprogress&&(b.onprogress=function(b){if(b.lengthComputable){var c=b.loaded/b.total;a.onprogress(c,b.loaded,b.total)}else a.onprogress(null)}),b.onload=function(){a.onload&&a.onload(b.response)},a.onerror&&(b.onerror=a.onerror),b.send(null)}return{get:a}}),d("core/async",["require","_","./mixin/notifier","./request"],function(a){function b(a,b){var c=new f;return e.get({url:a,responseType:b,onload:function(a){c.resolve(a)},onerror:function(){self.reject(error)}}),c}var c=a("_"),d=a("./mixin/notifier"),e=a("./request"),f=function(){};f.prototype.resolve=function(a){this.trigger("success",a)},f.prototype.reject=function(a){this.trigger("error",a)},c.extend(f.prototype,d);var g=function(){};return g.prototype={constructor:g,all:function(a){var b=a.length,c=this,d=[];return a.forEach(function(a,e){a.once("success",function(a){b--,d[e]=a,0===b&&c.trigger("success",d)}),a.once("error",function(){c.trigger("error",a)})}),this},any:function(a){var b=a.length,c=!1,d=this,e=[];return a.forEach(function(a,f){a.once("success",function(a){b--,e[f]=a,c=!0,0===b&&d.trigger("success",e)}),a.once("error",function(){b--,e[f]=null,0===b&&(c?d.trigger("success",e):d.trigger("error"))})}),this}},g.makeRequestTasks=function(a,c){if("string"==typeof a)return b(a,c);if(a.url){var d=a;return b(d.url,d.responseType)}if(a instanceof Array){var e=a,f=[];return e.forEach(function(a){var c,d;"string"==typeof a?c=a:Object(a)===a&&(c=a.url,d=a.responseType),f.push(b(c,d))}),f}},g.makeTask=function(a){return new f(a)},c.extend(g.prototype,d),g}),d("core/color",["require"],function(){}),d("debug/PointLight",function(){}),d("geometry/Cube",["require","../Geometry","./Plane","../math/Matrix4","../math/Vector3","../math/BoundingBox"],function(a){function b(a,b,c){h.identity();var e=new d({widthSegments:b,heightSegments:c});switch(a){case"px":h.translate(new f(1,0,0)),h.rotateY(Math.PI/2);break;case"nx":h.translate(new f(-1,0,0)),h.rotateY(-Math.PI/2);break;case"py":h.translate(new f(0,1,0)),h.rotateX(-Math.PI/2);break;case"ny":h.translate(new f(0,-1,0)),h.rotateX(Math.PI/2);break;case"pz":h.translate(new f(0,0,1));break;case"nz":h.translate(new f(0,0,-1)),h.rotateY(Math.PI)}return e.applyTransform(h),e}var c=a("../Geometry"),d=a("./Plane"),e=a("../math/Matrix4"),f=a("../math/Vector3"),g=a("../math/BoundingBox"),h=new e,i=c.derive(function(){return{widthSegments:1,heightSegments:1,depthSegments:1,inside:!1}},function(){var a={px:b("px",this.depthSegments,this.heightSegments),nx:b("nx",this.depthSegments,this.heightSegments),py:b("py",this.widthSegments,this.depthSegments),ny:b("ny",this.widthSegments,this.depthSegments),pz:b("pz",this.widthSegments,this.heightSegments),nz:b("nz",this.widthSegments,this.heightSegments)},c=0,d=this;for(var e in a)["position","texcoord0","normal"].forEach(function(b){for(var f=a[e].attributes[b].value,g=0;g<f.length;g++){var h=f[g];this.inside&&"normal"===b&&(h[0]=-h[0],h[1]=-h[1],h[2]=-h[2]),d.attributes[b].value.push(h)}for(var i=a[e],g=0;g<i.faces.length;g++){var j=i.faces[g];d.faces.push([j[0]+c,j[1]+c,j[2]+c])}}),c+=a[e].getVerticesNumber();this.boundingBox=new g,this.boundingBox.max.set(1,1,1),this.boundingBox.min.set(-1,-1,-1)});return i}),d("geometry/Sphere",["require","../Geometry","glmatrix","../math/BoundingBox"],function(a){var b=a("../Geometry"),c=a("glmatrix"),d=c.vec3,e=c.vec2,f=a("../math/BoundingBox"),g=b.derive(function(){return{widthSegments:20,heightSegments:20,phiStart:0,phiLength:2*Math.PI,thetaStart:0,thetaLength:Math.PI,radius:1}},function(){var a,b,c,g,h,i,j,k,l=this.attributes.position.value,m=this.attributes.texcoord0.value,n=this.attributes.normal.value,o=this.heightSegments,p=this.widthSegments,q=this.radius,r=this.phiStart,s=this.phiLength,t=this.thetaStart,u=this.thetaLength,q=this.radius;for(j=0;o>=j;j++)for(i=0;p>=i;i++)g=i/p,h=j/o,a=-q*Math.cos(r+g*s)*Math.sin(t+h*u),b=q*Math.cos(t+h*u),c=q*Math.sin(r+g*s)*Math.sin(t+h*u),l.push(d.fromValues(a,b,c)),m.push(e.fromValues(g,h)),k=d.fromValues(a,b,c),d.normalize(k,k),n.push(k);var v,w,x,y,z=this.faces,A=p+1;for(j=0;o>j;j++)for(i=0;p>i;i++)w=j*A+i,v=j*A+i+1,y=(j+1)*A+i+1,x=(j+1)*A+i,z.push(d.fromValues(v,w,y)),z.push(d.fromValues(w,x,y));this.boundingBox=new f,this.boundingBox.max.set(q,q,q),this.boundingBox.min.set(-q,-q,-q)});return g}),d("light/Ambient",["require","../Light","../Shader"],function(a){var b=a("../Light");a("../Shader");var c=b.derive(function(){return{castShadow:!1}},{type:"AMBIENT_LIGHT",uniformTemplates:{ambientLightColor:{type:"3f",value:function(a){var b=a.color,c=a.intensity;return[b[0]*c,b[1]*c,b[1]*c]}}}});return c}),d("light/Directional",["require","../Light","../Shader","../math/Vector3"],function(a){var b=a("../Light");a("../Shader");var c=a("../math/Vector3"),d=b.derive(function(){return{shadowBias:2e-4}},{type:"DIRECTIONAL_LIGHT",uniformTemplates:{directionalLightDirection:{type:"3f",value:function(){var a=new c;return function(b){return a.copy(b.worldTransform.forward).negate()._array}}()},directionalLightColor:{type:"3f",value:function(a){var b=a.color,c=a.intensity;return[b[0]*c,b[1]*c,b[1]*c]}}}});return d}),d("light/Point",["require","../Light","../Shader"],function(a){var b=a("../Light");a("../Shader");var c=b.derive(function(){return{range:100,castShadow:!1}},{type:"POINT_LIGHT",uniformTemplates:{pointLightPosition:{type:"3f",value:function(a){return a.getWorldPosition()._array}},pointLightRange:{type:"1f",value:function(a){return a.range}},pointLightColor:{type:"3f",value:function(a){var b=a.color,c=a.intensity;return[b[0]*c,b[1]*c,b[1]*c]}}}});return c}),d("light/Spot",["require","../Light","../Shader","../math/Vector3"],function(a){var b=a("../Light");a("../Shader");var c=a("../math/Vector3"),d=b.derive(function(){return{range:20,umbraAngle:30,penumbraAngle:45,falloffFactor:2,shadowBias:2e-4}},{type:"SPOT_LIGHT",uniformTemplates:{spotLightPosition:{type:"3f",value:function(a){return a.getWorldPosition()._array}},spotLightRange:{type:"1f",value:function(a){return a.range}},spotLightUmbraAngleCosine:{type:"1f",value:function(a){return Math.cos(a.umbraAngle*Math.PI/180)}},spotLightPenumbraAngleCosine:{type:"1f",value:function(a){return Math.cos(a.penumbraAngle*Math.PI/180)}},spotLightFalloffFactor:{type:"1f",value:function(a){return a.falloffFactor}},spotLightDirection:{type:"3f",value:function(){var a=new c;return function(b){return a.copy(b.worldTransform.forward).negate()._array}}()},spotLightColor:{type:"3f",value:function(a){var b=a.color,c=a.intensity;return[b[0]*c,b[1]*c,b[1]*c]}}}});return d}),d("loader/FX",["require","../core/Base","../core/request","../core/util","../compositor/Compositor","../compositor/Node","../compositor/Group","../compositor/SceneNode","../compositor/TextureNode","../Shader","../Texture","../texture/Texture2D","../texture/TextureCube","_"],function(a){function b(a,b){var c=parseFloat(a.substr(0,a.length-1));return Math.max(c/100*b.width,1)}function c(a,b){var c=parseFloat(a.substr(0,a.length-1));return Math.max(c/100*b.height,1)}var d=a("../core/Base"),e=a("../core/request"),f=a("../core/util"),g=a("../compositor/Compositor"),h=a("../compositor/Node");a("../compositor/Group"),a("../compositor/SceneNode"),a("../compositor/TextureNode");var i=a("../Shader"),j=a("../Texture"),k=a("../texture/Texture2D"),l=a("../texture/TextureCube"),m=a("_"),n=/#source\((.*?)\)/,o=/#url\((.*?)\)/,p=d.derive(function(){return{rootPath:"",textureRootPath:"",shaderRootPath:""}},{load:function(a){var b=this;this.rootPath||(this.rootPath=a.slice(0,a.lastIndexOf("/"))),e.get({url:a,onprogress:function(a,c,d){b.trigger("progress",a,c,d)},onerror:function(a){b.trigger("error",a)},responseType:"text",onload:function(a){b.parse(JSON.parse(a))}})},parse:function(a){var b=this,c=new g,d={textures:{},shaders:{},parameters:{}},e=function(){for(var e=0;e<a.nodes.length;e++){var f=a.nodes[e],g=b._createNode(f,d);g&&c.add(g),f.output&&c.addOutput(g)}b.trigger("success",c)};for(var f in a.parameters){var h=a.parameters[f];d.parameters[f]=this._convertParameter(h)}return this._loadShaders(a,function(c){b._loadTextures(a,d,function(a){d.textures=a,d.shaders=c,e()})}),c},_createNode:function(a,b){if(a.shader){var c,d,e,f=a.type||"processor";if("processor"===f){var g=a.shader.trim(),j=n.exec(g);if(j?c=i.source(j[1].trim()):"#"===g.charAt(0)&&(c=b.shaders[g.substr(1)]),c||(c=g),!c)return}if(a.inputs){d={};for(var k in a.inputs)d[k]={node:a.inputs[k].node,pin:a.inputs[k].pin}}if(a.outputs){e={};for(var k in a.outputs){var l=a.outputs[k];if(e[k]={},void 0!==l.attachment&&(e[k].attachment=l.attachment),void 0!==l.keepLastFrame&&(e[k].keepLastFrame=l.keepLastFrame),void 0!==l.outputLastFrame&&(e[k].outputLastFrame=l.outputLastFrame),"string"==typeof l.parameters){var m=l.parameters;"#"===m.charAt(0)&&(e[k].parameters=b.parameters[m.substr(1)])}else l.parameters&&(e[k].parameters=this._convertParameter(l.parameters))}}var o;if("processor"===f&&(o=new h({name:a.name,shader:c,inputs:d,outputs:e})),o&&a.parameters)for(var k in a.parameters){var p=a.parameters[k];"string"==typeof p&&(p=p.trim(),"#"===p.charAt(0)&&(p=b.textures[p.substr(1)])),o.setParameter(k,p)}return o}},_convertParameter:function(a){var d={};return a?(["type","minFilter","magFilter","wrapS","wrapT"].forEach(function(b){void 0!==a[b]&&(d[b]=j[a[b]])}),["width","height"].forEach(function(e){if(void 0!==a[e]){var f=a[e];"string"==typeof f?(f=f.trim(),f.match(/%$/)&&(d[e]="width"===e?b.bind(null,f):c.bind(null,f))):d[e]=f}}),void 0!==a.useMipmap&&(d.useMipmap=a.useMipmap),d):d},_loadShaders:function(a,b){if(!a.shaders)return b({}),void 0;var c={},d=0,g=!1,h=this.shaderRootPath||this.rootPath;m.each(a.shaders,function(a,j){var k=o.exec(a);if(k){var l=k[1];l=f.relative2absolute(l,h),d++,e.get({url:l,onload:function(a){c[j]=a,i.import(a),d--,0===d&&(b(c),g=!0)}})}else c[j]=a,i.import(shaderSource)},this),0!==d||g||b(c)},_loadTextures:function(a,b,c){if(!a.textures)return c({}),void 0;var d={},e=0,g=!1,h=this.textureRootPath||this.rootPath;m.each(a.textures,function(a,b){var i,j=a.path;if(this._convertParameter(a.parameters),"array"==typeof j&&6===j.length)j=j.map(function(a){return f.relative2absolute(a,h)}),i=new l;else{if("string"!=typeof j)return;j=f.relative2absolute(j,h),i=new k}i.load(j),e++,i.once("success",function(){d[b]=i,e--,0===e&&(c(d),g=!0)})},this),0!==e||g||c(d)}});return p}),d("loader/InstantGeometry",["require","../core/Base","../core/util","../math/BoundingBox","../Geometry","glmatrix"],function(a){var b=a("../core/Base"),c=a("../core/util"),d=a("../math/BoundingBox"),e=a("../Geometry"),f=a("glmatrix");f.vec3;var g=b.derive(function(){return{__GUID__:c.genGUID(),boundingBox:new d,useFace:!0,_normalType:"vertex",_arrayChunks:[],_verticesNumber:0}},{addChunk:function(a){this._verticesNumber+=a.attributes.position.array.length/3,this._arrayChunks.push(a)},dirty:function(){this.cache.dirtyAll("chunks")},getBufferChunks:function(a){return this.cache.use(a.__GLID__),this.cache.isDirty("chunks")&&(this._updateBuffer(a),this.cache.fresh("chunks")),this.cache.get("chunks")},getVerticesNumber:function(){return this._verticesNumber},isUseFace:function(){return this.useFace},_updateBuffer:function(a){var b=this.cache.get("chunks");if(!b){b=[];for(var c=0;c<this._arrayChunks.length;c++)b[c]={attributeBuffers:[],indicesBuffer:null};this.cache.put("chunks",b)}for(var c=0;c<b.length;c++){var d=b[c];d||(d=b[c]={attributeBuffers:[],indicesBuffer:null});var e=d.attributeBuffers,f=d.indicesBuffer,g=this._arrayChunks[c],h=g.indices;for(var i in g.attributes){var j,k=g.attributes[i],l=e[i];j=l?l.buffer:a.createBuffer(),a.bindBuffer(a.ARRAY_BUFFER,j),a.bufferData(a.ARRAY_BUFFER,k.array,a.STATIC_DRAW),e.push({name:i,type:k.type,buffer:j,size:k.size,semantic:k.semantic})}f||(f=d.indicesBuffer={buffer:a.createBuffer(),count:h.length}),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,f.buffer),a.bufferData(a.ELEMENT_ARRAY_BUFFER,h,a.STATIC_DRAW)}},convertToGeometry:function(){for(var a=new e,b=0,c=0;c<this._arrayChunks.length;c++){for(var f=this._arrayChunks[c],g=f.indices,h=0;h<g.length;h+=3)a.faces.push([g[h]+b,g[h+1]+b,g[h+2]+b]);for(var i in f.attributes){var j,k=f.attributes[i];for(var l in a.attributes)a.attributes[l].semantic===k.semantic&&(j=a.attributes[l]);if(j)for(var h=0;h<k.array.length;h+=k.size)if(1===k.size)j.value.push(k.array[h]);else{for(var m=[],n=0;n<k.size;n++)m[n]=k.array[h+n];j.value.push(m)}}b+=f.attributes.position.length/3}return a.boundingBox=new d,a.boundingBox.min.copy(this.boundingBox.min),a.boundingBox.max.copy(this.boundingBox.max),a},dispose:function(a){this.cache.use(a.__GLID__);var b=this.cache.get("chunks");if(b)for(var c=0;c<b.length;c++){var d=b[c];for(var e in d.attributeBuffers){var f=d.attributeBuffers[e];a.deleteBuffer(f.buffer)}}this.cache.deleteContext(a.__GLID__)}});return g}),d("loader/GLTF",["require","../core/Base","../core/request","../core/util","../Scene","../Shader","../Material","../Mesh","../Node","../Texture","../texture/Texture2D","../texture/TextureCube","../shader/library","../Skeleton","../Joint","../camera/Perspective","../camera/Orthographic","../light/Point","../light/Spot","../light/Directional","../core/glenum","../math/Vector3","../math/Quaternion","_","./InstantGeometry","glmatrix"],function(a){var b=a("../core/Base"),c=a("../core/request"),d=a("../core/util"),e=a("../Scene");a("../Shader");var f=a("../Material"),g=a("../Mesh"),h=a("../Node");a("../Texture");var i=a("../texture/Texture2D");a("../texture/TextureCube");var j=a("../shader/library"),k=a("../Skeleton"),l=a("../Joint"),m=a("../camera/Perspective"),n=a("../camera/Orthographic"),o=a("../light/Point"),p=a("../light/Spot"),q=a("../light/Directional"),r=a("../core/glenum");a("../math/Vector3"),a("../math/Quaternion");var s=a("_"),t=a("./InstantGeometry"),u=a("glmatrix");u.vec4,u.vec3,u.vec2;var v={NORMAL:"normal",POSITION:"position",TEXCOORD_0:"texcoord0",WEIGHT:"weight",JOINT:"joint"},w=b.derive(function(){return{rootPath:"",textureRootPath:"",bufferRootPath:""}},{load:function(a){var b=this;this.rootPath||(this.rootPath=a.slice(0,a.lastIndexOf("/"))),c.get({url:a,onprogress:function(a,c,d){b.trigger("progress",a,c,d)},onerror:function(a){b.trigger("error",a)},responseType:"text",onload:function(a){b.parse(JSON.parse(a))}})},parse:function(a){function b(){c._parseSkins(a,f),c._parseTextures(a,f),c._parseMaterials(a,f),c._parseMeshes(a,f),c._parseNodes(a,f);for(var b=a.scenes[a.scene],d=0;d<b.nodes.length;d++)if(!f.joints[b.nodes[d]]){var e=f.nodes[b.nodes[d]];g.add(e)}c.trigger("success",{scene:g,cameras:f.cameras,textures:f.textures,materials:f.materials,skeleton:f.skeleton})}var c=this,d=0,f={buffers:{},materials:{},textures:{},meshes:{},joints:{},skins:{},skeleton:null,cameras:{},nodes:{}},g=new e;return s.each(a.buffers,function(a,e){d++,c._loadBuffer(a.path,function(a){f.buffers[e]=a,d--,0===d&&b()},function(){d--,0===d&&b()})}),{scene:g,cameras:f.cameras,textures:f.textures,materials:f.materials,skeleton:f.skeleton}},_loadBuffer:function(a,b,d){var e=this.bufferRootPath||this.rootPath;e&&(a=e+"/"+a),c.get({url:a,responseType:"arraybuffer",onload:function(a){b&&b(a)},onerror:function(a){d&&d(a)}})},_parseSkins:function(a,b){var c=new k,d=function(e,f){if(!b.joints[e]){var g=a.nodes[e];g._isJoint=!0;var h=new l;if(h.name=e,g.matrix){for(var i=0;16>i;i++)h.localTransform._array[i]=g.matrix[i];h.decomposeLocalTransform()}h.index=c.joints.length,void 0!==f&&(h.parentIndex=f),c.joints.push(h),b.joints[e]=h;for(var i=0;i<g.children.length;i++){var j=d(g.children[i],h.index);j&&h.add(j)}return h}};for(var e in a.skins)for(var f=a.skins[e],g=0;g<f.roots.length;g++){var h=f.roots[g],i=d(h);i&&c.roots.push(i)}for(var e in a.skins){for(var f=a.skins[e],j=[],g=0;g<f.joints.length;g++){var m=b.joints[f.joints[g]];j.push(m.index)}b.skins[e]={joints:j}}c.updateJointMatrices(),c.update(),b.skeleton=c},_parseTextures:function(a,b){s.each(a.textures,function(c,d){var e=a.samplers[c.sampler],f={};["wrapS","wrapT","magFilter","minFilter"].forEach(function(a){var b=e[a];void 0!==b&&("string"==typeof b&&(b=r[b]),f[a]=b)});var g=c.target,h=c.format;if("string"==typeof g&&(g=r[g],h=r[h]),f.format=h,g===r.TEXTURE_2D){var j=new i(f),k=a.images[c.source];j.image=this._loadImage(k.path,function(){j.dirty()}),b.textures[d]=j}else g===r.TEXTURE_CUBE_MAP},this)},_loadImage:function(a,b){var c=this.textureRootPath||this.rootPath,e=new Image;return e.onload=function(){b&&b(e),e.onload=null},e.src=d.relative2absolute(a,c),e},_parseMaterials:function(a,b){var c={};for(var d in a.techniques){var e=a.techniques[d];c[d]={pass:e.passes[e.pass]}}for(var d in a.materials){var g=a.materials[d],h=g.instanceTechnique,k=c[h.technique],l=k.pass,m={};h.values instanceof Array?h.values.forEach(function(a){m[a.parameter]=a.value}):m=h.values;for(var n in m){var o=m[n];"string"==typeof o&&b.textures[o]&&(m[n]=b.textures[o])}var p=[];m.diffuse instanceof i&&p.push("diffuseMap"),m.normalMap instanceof i&&p.push("normalMap");var q=new f({name:g.name,shader:j.get("buildin.phong",p)});void 0!==l.states.depthMask&&(q.depthMask=l.states.depthMask),void 0!==l.states.depthTestEnable&&(q.depthTest=l.states.depthTestEnable),q.cullFace=l.states.cullFaceEnable||!1,l.states.blendEnable&&(q.transparent=!0),m.diffuse&&(m.diffuse instanceof Array?q.set("color",m.diffuse.slice(0,3)):q.set("diffuseMap",m.diffuse)),void 0!==m.normalMap&&q.set("normalMap",m.normalMap),void 0!==m.emission&&q.set("emission",m.emission.slice(0,3)),void 0!==m.shininess?q.set("shininess",m.shininess):q.set("shininess",0),void 0!==m.specular&&q.set("specular",m.specular.slice(0,3)),void 0!==m.transparency&&q.set("alpha",m.transparency),b.materials[d]=q}},_parseMeshes:function(a,b){for(var c in a.meshes){var d=a.meshes[c];b.meshes[c]=[];for(var e=0;e<d.primitives.length;e++){var f=new t,h={attributes:{},indices:null},i=d.primitives[e];if(a.indices)var j=a.indices[i.indices];else var j=a.accessors[i.indices];var k=a.bufferViews[j.bufferView],l=b.buffers[k.buffer],m=k.byteOffset+j.byteOffset,n=2*j.count;h.indices=new Uint16Array(l.slice(m,m+n)),i.semantics&&(i.attributes=i.semantics);for(var o in i.attributes){var p=i.attributes[o];if(a.attributes)var q=a.attributes[p];else var q=a.accessors[p];var s=v[o],u=q.type,k=a.bufferViews[q.bufferView],l=b.buffers[k.buffer],m=k.byteOffset+q.byteOffset,n=q.count*q.byteStride;switch("string"==typeof u&&(u=r[u]),u){case r.FLOAT_VEC2:var w=2,x="float",y=Float32Array;break;case r.FLOAT_VEC3:var w=3,x="float",y=Float32Array;break;case r.FLOAT_VEC4:var w=4,x="float",y=Float32Array;break;case r.FLOAT:var w=1,x="float",y=Float32Array;break;default:console.warn("Attribute type "+q.type+" not support yet")}if(h.attributes[s]={type:x,size:w,semantic:o,array:new y(l.slice(m,m+n))},"POSITION"===o){var z=q.min,A=q.max;z&&f.boundingBox.min.set(z[0],z[1],z[2]),A&&f.boundingBox.max.set(A[0],A[1],A[2])}}f.addChunk(h);var B=b.materials[i.material],C=new g({geometry:f.convertToGeometry(),material:B});B.shader.isTextureEnabled("normalMap")&&(C.geometry.attributes.tangent.value.length||C.geometry.generateTangents());var D=i.skin;D&&(C.joints=b.skins[D].joints,C.skeleton=b.skeleton,B.shader=B.shader.clone(),B.shader.define("vertex","SKINNING"),B.shader.define("vertex","JOINT_NUMBER",C.joints.length)),d.name&&(C.name=d.primitives.length>1?[c,e].join("-"):c),b.meshes[c].push(C)}}},_parseNodes:function(a,b){for(var c in a.nodes){var d=a.nodes[c];if(!d._isJoint){var e;if(d.camera){var f=a.cameras[d.camera];"perspective"===f.projection?e=new m({name:d.name,aspect:f.aspect_ratio,fov:f.xfov,far:f.zfar,near:f.znear}):(e=new n,console.warn("TODO:Orthographic camera")),b.cameras[d.name]=e}else e=new h({name:d.name});if(d.lights)for(var g=0;g<d.lights.length;g++){var i=a.lights[d.lights[g]],j=this._parseLight(i);j&&e.add(j)}if(d.meshes)for(var g=0;g<d.meshes.length;g++){var k=b.meshes[d.meshes[g]];if(k)for(var l=0;l<k.length;l++)e.add(k[l])}if(d.matrix){for(var g=0;16>g;g++)e.localTransform._array[g]=d.matrix[g];e.decomposeLocalTransform()}b.nodes[c]=e}}for(var c in a.nodes){var d=a.nodes[c];if(!d._isJoint){var e=b.nodes[c];if(d.children)for(var g=0;g<d.children.length;g++){var o=d.children[g],p=b.nodes[o];e.add(p)}}}},_parseLight:function(a){switch(a.type){case"point":var b=new o({name:a.id,color:a.point.color});break;case"spot":var b=new p({name:a.id,color:a.spot.color});break;case"directional":var b=new q({name:a.id,color:a.directional.color});break;default:console.warn("Light "+a.type+" not support yet")}return b}});return w}),d("loader/SVG",["require","../core/Base","../core/request","../2d/Node","../2d/shape/Circle","../2d/shape/Rectangle","../2d/shape/Ellipse","../2d/shape/Line","../2d/shape/Path","../2d/shape/Polygon","../2d/shape/TextBox","../2d/shape/SVGPath","../2d/LinearGradient","../2d/RadialGradient","../2d/Pattern","../2d/Style","../math/Vector2","_"],function(a){function b(a,b){for(var c=a.firstChild;c;){if(1===c.nodeType){var d=c.getAttribute("offset");d=d.indexOf("%")>0?parseInt(d)/100:d?parseFloat(d):0;var e=c.getAttribute("stop-color")||"#000000";b.addColorStop(d,e)}c=c.nextSibling}}function c(a,b){b.stroke=a.stroke,b.fill=a.fill}function d(a){for(var b=a.trim().replace(/,/g," ").split(/\s+/),c=[],d=0;d<b.length;d+=2){var e=parseFloat(b[d]),f=parseFloat(b[d+1]);c.push(new u(e,f))}return c}function e(a,b,c){g(a,b);var d={fill:a.getAttribute("fill"),stroke:a.getAttribute("stroke"),lineWidth:a.getAttribute("stroke-width"),opacity:a.getAttribute("opacity"),lineDash:a.getAttribute("stroke-dasharray"),lineDashOffset:a.getAttribute("stroke-dashoffset"),lineCap:a.getAttribute("stroke-linecap"),lineJoin:a.getAttribute("stroke-linjoin"),miterLimit:a.getAttribute("stroke-miterlimit")};v.extend(d,h(a)),b.style=new t({fill:f(d.fill,c),stroke:f(d.stroke,c),lineWidth:parseFloat(d.lineWidth),opacity:parseFloat(d.opacity),lineDashOffset:d.lineDashOffset,lineCap:d.lineCap,lineJoin:d.lineJoin,miterLimit:parseFloat(d.miterLimit)}),d.lineDash&&(b.style.lineDash=d.lineDash.trim().split(/\s*,\s*/)),d.stroke&&"none"!==d.stroke&&(b.stroke=!0)}function f(a,b){var c=z.exec(a);if(c){var d=c[1].trim(),e=b[d];return e}return a}function g(a,b){var c=a.getAttribute("transform");if(c){var d=b.transform;d.identity();var e=[];c.replace(A,function(a,b,c){e.push(b,c)});for(var f=e.length-1;f>0;f-=2){var g=e[f],h=e[f-1];switch(h){case"translate":g=g.trim().split(/\s+/),d.translate(new u(parseFloat(g[0]),parseFloat(g[1]||0)));break;case"scale":g=g.trim().split(/\s+/),d.scale(new u(parseFloat(g[0]),parseFloat(g[1]||g[0])));break;case"rotate":g=g.trim().split(/\s*/),d.rotate(parseFloat(g[0]));break;case"skew":g=g.trim().split(/\s*/),console.warn("Skew transform is not supported yet");break;case"matrix":var g=g.trim().split(/\s*,\s*/),i=d._array;i[0]=parseFloat(g[0]),i[1]=parseFloat(g[1]),i[2]=parseFloat(g[2]),i[3]=parseFloat(g[3]),i[4]=parseFloat(g[4]),i[5]=parseFloat(g[5])}}}b.autoUpdate=!1}function h(a){var b=a.getAttribute("style");if(b){var c={};return b=b.replace(/\s*([;:])\s*/g,"$1"),b.replace(B,function(a,b,d){c[b]=d}),{fill:c.fill,stroke:c.stroke,lineWidth:c["stroke-width"],opacity:c.opacity,lineDash:c["stroke-dasharray"],lineDashOffset:c["stroke-dashoffset"],lineCap:c["stroke-linecap"],lineJoin:c["stroke-linjoin"],miterLimit:c["stroke-miterlimit"]}
}return{}}var i=a("../core/Base"),j=a("../core/request"),k=a("../2d/Node"),l=a("../2d/shape/Circle"),m=a("../2d/shape/Rectangle"),n=a("../2d/shape/Ellipse"),o=a("../2d/shape/Line"),p=a("../2d/shape/Path"),q=a("../2d/shape/Polygon");a("../2d/shape/TextBox");var r=a("../2d/shape/SVGPath"),s=a("../2d/LinearGradient");a("../2d/RadialGradient"),a("../2d/Pattern");var t=a("../2d/Style"),u=a("../math/Vector2"),v=a("_"),w=i.derive(function(){return{defs:{},root:null}},{load:function(a){var b=this;this.defs={},j.get({url:a,onprogress:function(a,c,d){b.trigger("progress",a,c,d)},onerror:function(a){b.trigger("error",a)},responseType:"text",onload:function(a){b.parse(a)}})},parse:function(a){if("string"==typeof a)for(var b=new DOMParser,c=b.parseFromString(a,"text/xml"),d=c.firstChild;"svg"!==d.nodeName.toLowerCase();)d=d.nextSibling;else var d=a;var e=new k;this.root=e;var f=d.getAttribute("viewBox")||"",g=f.split(/\s+/);parseFloat(d.getAttribute("width")||0),parseFloat(d.getAttribute("height")||0);var h=parseFloat(g[0]||0),i=parseFloat(g[1]||0);parseFloat(g[2]),parseFloat(g[3]),e.position.set(h,i);for(var j=d.firstChild;j;)this._parseNode(j,e),j=j.nextSibling;return this.trigger("success",e),e},_parseNode:function(a,b){var c=a.nodeName.toLowerCase();if("defs"===c&&(this._isDefine=!0),this._isDefine){var d=y[c];if(d){var e=d.call(this,a),f=a.getAttribute("id");f&&(this.defs[f]=e)}}else{var d=x[c];if(d){var g=d.call(this,a,b);b.add(g)}}for(var h=a.firstChild;h;)1===h.nodeType&&this._parseNode(h,g),h=h.nextSibling;"defs"===c&&(this._isDefine=!1)}}),x={g:function(a,b){var d=new k;return b&&c(b,d),e(a,d,this.defs),d},rect:function(a,b){var d=new m;b&&c(b,d),e(a,d,this.defs);var f=parseFloat(a.getAttribute("x")||0),g=parseFloat(a.getAttribute("y")||0);return parseFloat(a.getAttribute("width")||0),parseFloat(a.getAttribute("height")||0),d.start.set(f,g),d.size.set(f,g),d},circle:function(a,b){var d=new l;b&&c(b,d),e(a,d,this.defs);var f=parseFloat(a.getAttribute("cx")||0),g=parseFloat(a.getAttribute("cy")||0),h=parseFloat(a.getAttribute("r")||0);return d.center.set(f,g),d.radius=h,d},line:function(a,b){var d=new o;b&&c(b,d),e(a,d,this.defs);var f=parseFloat(a.getAttribute("x1")||0),g=parseFloat(a.getAttribute("y1")||0),h=parseFloat(a.getAttribute("x2")||0),i=parseFloat(a.getAttribute("y2")||0);return d.start.set(f,g),d.end.set(h,i),d},ellipse:function(a,b){var d=new n;b&&c(b,d),e(a,d,this.defs);var f=parseFloat(a.getAttribute("cx")||0),g=parseFloat(a.getAttribute("cy")||0),h=parseFloat(a.getAttribute("rx")||0),i=parseFloat(a.getAttribute("ry")||0);return d.center.set(f,g),d.radius.set(h,i),d},polygon:function(a,b){var f=a.getAttribute("points");f&&(f=d(f));var g=new q({points:f});return b&&c(b,g),e(a,g,this.defs),g},polyline:function(a,b){var f=new p;b&&c(b,f),e(a,f,this.defs);var g=a.getAttribute("points");return g&&(g=d(g),f.pushPoints(g)),f},image:function(){},text:function(){},path:function(a,b){var d=new r;b&&c(b,d),e(a,d,this.defs);var f=a.getAttribute("d")||"";return d.description=f,d}},y={lineargradient:function(a){var c=parseInt(a.getAttribute("x1")||0),d=parseInt(a.getAttribute("y1")||0),e=parseInt(a.getAttribute("x2")||10),f=parseInt(a.getAttribute("y2")||0),g=new s;return g.start.set(c,d),g.end.set(e,f),b(a,g),g},radialgradient:function(){}},z=/url\(\s*#(.*?)\)/,A=/(translate|scale|rotate|skewX|skewY|matrix)\(([\-\s0-9\.,]*)\)/g,B=/(\S*?):(.*?);/g;return w}),d("loader/three/Model",["require","../../core/Base","../../core/request","../../core/util","../../Shader","../../Material","../../Geometry","../../Mesh","../../Node","../../texture/Texture2D","../../texture/TextureCube","../../shader/library","../../Skeleton","../../Joint","../../math/Vector3","../../math/Quaternion","../../core/glenum","_","glmatrix"],function(a){function b(a,b){return a&1<<b}function c(a){var b=255&a>>16,c=255&a>>8,d=255&a;return[b/255,c/255,d/255]}var d=a("../../core/Base"),e=a("../../core/request"),f=a("../../core/util"),g=a("../../Shader"),h=a("../../Material"),i=a("../../Geometry"),j=a("../../Mesh");a("../../Node");var k=a("../../texture/Texture2D");a("../../texture/TextureCube");var l=a("../../shader/library"),m=a("../../Skeleton"),n=a("../../Joint"),o=a("../../math/Vector3"),p=a("../../math/Quaternion"),q=a("../../core/glenum"),r=a("_"),s=a("glmatrix");s.vec3,s.vec2;var t=d.derive(function(){return{rootPath:"",textureRootPath:"",textureNumber:0}},{load:function(a){var b=this;this.textureNumber=0,this.rootPath||(this.rootPath=a.slice(0,a.lastIndexOf("/"))),e.get({url:a,onprogress:function(a,c,d){b.trigger("progress",a,c,d)},onerror:function(a){b.trigger("error",a)},responseType:"text",onload:function(a){b.parse(JSON.parse(a))}})},parse:function(a){var b=this.parseGeometry(a),c=a.skinIndices,d=a.skinWeights,e=c&&c.length&&d&&d.length;if(e)var f=this.parseSkeleton(a),g=f.joints.length;else var g=0;if(e)var f=this.parseSkeleton(a),g=f.joints.length;else var g=0;for(var h=[],i=0;i<a.materials.length;i++){var k=b[i];if(k&&k.faces.length&&k.attributes.position.value.length){k.updateBoundingBox();var l=this.parseMaterial(a.materials[i],g),m=new j({geometry:b[i],material:l});if(e){m.skeleton=f;for(var i=0;i<f.joints.length;i++)m.joints[i]=i}h.push(m)}}return this.trigger("success",h),h},parseGeometry:function(a){function d(a,b){return C[a]>=0?(E=D[a],q=e[E],r=q.attributes,s=r.position.value,t=r.normal.value,u=[r.texcoord0.value,r.texcoord1.value],v=r.color.value,x=r.weight.value,w=r.joint.value,F[b]=!1,C[a]):(s.push([j[3*a],j[3*a+1],j[3*a+2]]),p&&(x.push([n[2*a],n[2*a+1],0]),w.push([m[2*a],m[2*a+1],-1,-1])),C[a]=f[J],D[a]=J,F[b]=!0,f[J]++)}for(var e=[],f=[],g=0;g<a.materials.length;g++)e[g]=null,f[g]=0;e[0]=new i,a.materials&&a.materials.length>1;var h=a.faces,j=a.vertices,k=a.normals,l=a.colors,m=a.skinIndices,n=a.skinWeights,o=a.uvs,p=m&&m.length&&n&&n.length,q=e[0],r=q.attributes,s=r.position.value,t=r.normal.value,u=[r.texcoord0.value,r.texcoord1.value],v=r.color.value,w=r.joint.value,x=r.weight.value,y=q.faces,z=0;o[0]&&o[0].length&&z++,o[1]&&o[1].length&&z++;for(var A=0,B=h.length,C=[],D=[],g=0;g<j.length;g++)C[g]=-1,D[g]=-1;for(var E=0,F=[],G=[],H=[],I=[],g=0;4>g;g++)G[g]=[0,0],H[g]=[0,0,0],I[g]=[0,0,0];for(var J=0;B>A;){var K=h[A++],L=b(K,0),M=b(K,1),N=b(K,2),O=b(K,3),P=b(K,4),Q=b(K,5),R=b(K,6),S=b(K,7),T=L?4:3;if(M&&(J=h[A+(L?4:3)],e[J]||(e[J]=new i),q=e[J],r=q.attributes,s=r.position.value,t=r.normal.value,u=[r.texcoord0.value,r.texcoord1.value],v=r.color.value,x=r.weight.value,w=r.joint.value,y=q.faces),L){var U=h[A++],V=h[A++],W=h[A++],X=h[A++],Y=d(U,0),Z=d(V,1),$=d(X,2),_=d(V,3),ab=d(W,4),bb=d(X,5);y.push([Y,Z,$],[_,ab,bb])}else{var Y=h[A++],Z=h[A++],$=h[A++];Y=d(Y,0),Z=d(Z,1),$=d($,2),y.push([Y,Z,$])}if(M&&A++,N)for(var g=0;z>g;g++){var cb=o[g],db=y[A++],eb=cb[2*db],fb=cb[2*db+1];L?(F[0]&&(u[g][Y]=[eb,fb]),F[1]&&(u[g][Z]=[eb,fb]),F[2]&&(u[g][$]=[eb,fb]),F[3]&&(u[g][_]=[eb,fb]),F[4]&&(u[g][ab]=[eb,fb]),F[5]&&(u[g][bb]=[eb,fb])):(F[0]&&(u[g][Y]=[eb,fb]),F[1]&&(u[g][Z]=[eb,fb]),F[2]&&(u[g][$]=[eb,fb]))}if(O)for(var g=0;z>g;g++){for(var cb=o[g],gb=0;T>gb;gb++){var db=h[A++];G[gb][0]=cb[2*db],G[gb][1]=cb[2*db+1]}L?(F[0]&&(u[g][Y]=G[0].slice()),F[1]&&(u[g][Z]=G[1].slice()),F[2]&&(u[g][$]=G[3].slice()),F[3]&&(u[g][_]=G[1].slice()),F[4]&&(u[g][ab]=G[2].slice()),F[5]&&(u[g][bb]=G[3].slice())):(F[0]&&(u[g][Y]=G[0].slice()),F[1]&&(u[g][Z]=G[1].slice()),F[2]&&(u[g][$]=G[2].slice()))}if(P){var hb=3*h[A++],ib=k[hb++],jb=k[hb++],kb=k[hb];L?(F[0]&&(t[Y]=[ib,jb,kb]),F[1]&&(t[Z]=[ib,jb,kb]),F[2]&&(t[$]=[ib,jb,kb]),F[3]&&(t[_]=[ib,jb,kb]),F[4]&&(t[ab]=[ib,jb,kb]),F[5]&&(t[bb]=[ib,jb,kb])):(F[0]&&(t[Y]=[ib,jb,kb]),F[1]&&(t[Z]=[ib,jb,kb]),F[2]&&(t[$]=[ib,jb,kb]))}if(Q){for(var g=0;T>g;g++){var hb=3*h[A++];H[g][0]=k[hb++],H[g][1]=k[hb++],H[g][2]=k[hb]}L?(F[0]&&(t[Y]=H[0].slice()),F[1]&&(t[Z]=H[1].slice()),F[2]&&(t[$]=H[3].slice()),F[3]&&(t[_]=H[1].slice()),F[4]&&(t[ab]=H[2].slice()),F[5]&&(t[bb]=H[3].slice())):(F[0]&&(t[Y]=H[0].slice()),F[1]&&(t[Z]=H[1].slice()),F[2]&&(t[$]=H[2].slice()))}if(R){var lb=h[A++],mb=c(l[lb]);L?(F[0]&&(v[Y]=mb),F[1]&&(v[Z]=mb),F[2]&&(v[$]=mb),F[3]&&(v[_]=mb),F[4]&&(v[ab]=mb),F[5]&&(v[bb]=mb)):(F[0]&&(v[Y]=mb),F[1]&&(v[Z]=mb),F[2]&&(v[$]=mb))}if(S){for(var g=0;T>g;g++){var lb=h[A++];I[g]=c(l[lb])}L?(F[0]&&(v[Y]=I[0].slice()),F[1]&&(v[Z]=I[1].slice()),F[2]&&(v[$]=I[3].slice()),F[3]&&(v[_]=I[1].slice()),F[4]&&(v[ab]=I[2].slice()),F[5]&&(v[bb]=I[3].slice())):(F[0]&&(v[Y]=I[0].slice()),F[1]&&(v[Z]=I[1].slice()),F[2]&&(v[$]=I[2].slice()))}}return e},parseSkeleton:function(a){for(var b=[],c=a.bones,d=0;d<c.length;d++){var e=c[d],f=new n({parentIndex:e.parent,name:e.name,position:new o(e.pos[0],e.pos[1],e.pos[2]),rotation:new p(e.rotq[0],e.rotq[1],e.rotq[2],e.rotq[3]),scale:new o(e.scl[0],e.scl[1],e.scl[2])});b.push(f)}var g=new m({joints:b});if(g.updateHierarchy(),g.updateJointMatrices(),g.update(),a.animation)for(var h=a.animation.hierarchy,d=0;d<h.length;d++)for(var i=h[d],f=b[d],j=0;j<i.keys.length;j++){var k=i.keys[j];f.poses[j]={};var l=f.poses[j];l.time=parseFloat(k.time),k.pos&&(l.position=new o(k.pos[0],k.pos[1],k.pos[2])),k.rot&&(l.rotation=new p(k.rot[0],k.rot[1],k.rot[2],k.rot[3])),k.scl&&(l.scale=new o(k.scl[0],k.scl[1],k.scl[2]))}return g},parseMaterial:function(a,b){var d="buildin.lambert",e=a.shading&&a.shading.toLowerCase();("phong"===e||"lambert"===e)&&(d="buildin."+e);var f=[];if(a.mapDiffuse&&f.push("diffuseMap"),(a.mapNormal||a.mapBump)&&f.push("normalMap"),0==b)var i=l.get(d,f);else{for(var i=new g({vertex:g.source(d+".vertex"),fragment:g.source(d+".fragment")}),j=0;f>j;j++)i.enableTexture(f[j]);i.define("vertex","SKINNING"),i.define("vertex","JOINT_NUMBER",b)}var k=new h({shader:i});return a.colorDiffuse?k.set("color",a.colorDiffuse):a.DbgColor&&k.set("color",c(a.DbgColor)),a.colorSpecular&&k.set("specular",a.colorSpecular),void 0!==a.transparent&&a.transparent&&(k.transparent=!0),r.isUndefined(a.depthTest)||(k.depthTest=a.depthTest),r.isUndefined(a.depthWrite)||(k.depthMask=a.depthWrite),a.transparency&&a.transparency<1&&k.set("opacity",a.transparency),a.specularCoef&&k.set("shininess",a.specularCoef),a.mapDiffuse&&k.set("diffuseMap",this.loadTexture(a.mapDiffuse,a.mapDiffuseWrap)),a.mapBump&&k.set("normalMap",this.loadTexture(a.mapBump,a.mapBumpWrap)),a.mapNormal&&k.set("normalMap",this.loadTexture(a.mapNormal,a.mapBumpWrap)),k},loadTexture:function(a,b){var c=new Image,d=new k;d.image=c,this.textureNumber++,b&&b.length&&(d.wrapS=q[b[0].toUpperCase()],d.wrapT=q[b[1].toUpperCase()]),c.onload=function(){d.dirty()};var e=this.textureRootPath||this.rootPath;return c.src=f.relative2absolute(a,e),d}});return t}),d("math/Matrix2",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.mat2,d=function(){this._array=c.create()};return d.prototype={constructor:d,clone:function(){return(new d).copy(this)},copy:function(a){return c.copy(this._array,a._array),this},adjoint:function(){return c.adjoint(this._array,this._array),this},determinant:function(){return c.determinant(this._array)},identity:function(){return c.identity(this._array),this},invert:function(){return c.invert(this._array,this._array),this},mul:function(a){return c.mul(this._array,this._array,a._array),this},mulLeft:function(a){return c.mul(this._array,a._array,this._array),this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this},multiplyLeft:function(a){return c.multiply(this._array,a._array,this._array),this},rotate:function(a){return c.rotate(this._array,this._array,a),this},scale:function(a){c.scale(this._array,this._array,a)},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}},d}),d("math/Ray",["require","../core/Base","./Vector3","glmatrix"],function(a){a("../core/Base");var b=a("./Vector3"),c=a("glmatrix");c.vec3;var d=function(a,c){this.origin=a||new b,this.direction=c||new b};return d.prototype={constructor:d,intersectPlane:function(){},intersectTriangle:function(){}},d}),d("math/Value",["require","./Vector3","./Vector2"],function(a){var b=a("./Vector3"),c=a("./Vector2"),d=function(){};d.prototype.get=function(){},d.prototype.set=function(){};var e=function(a){this.get=function(){return a}};e.prototype=new d,e.prototype.constructor=e;var f=function(a){var b=a.constructor;this.get=function(c){return c||(c=new b),c.copy(a),c}};f.prototype=new d,f.prototype.constructor=f;var g=function(a,b){var c=b-a;this.get=function(){return Math.random()*c+a}};g.prototype=new d,g.prototype.constructor=g;var h=function(a,b){var d=b.x-a.x,e=b.y-a.y;this.get=function(b){return b||(b=new c),b.set(d*Math.random()+a._array[0],e*Math.random()+a._array[1]),b}};h.prototype=new d,h.prototype.constructor=h;var i=function(a,c){var d=c.x-a.x,e=c.y-a.y,f=c.z-a.z;this.get=function(c){return c||(c=new b),c.set(d*Math.random()+a._array[0],e*Math.random()+a._array[1],f*Math.random()+a._array[2]),c}};return i.prototype=new d,i.prototype.constructor=i,d.constant=function(a){return new e(a)},d.vector=function(a){return new f(a)},d.random1D=function(a,b){return new g(a,b)},d.random2D=function(a,b){return new h(a,b)},d.random3D=function(a,b){return new i(a,b)},d}),d("math/Vector4",["require","glmatrix"],function(a){var b=a("glmatrix"),c=b.vec4,d=function(a,b,d,e){a=a||0,b=b||0,d=d||0,e=e||0,this._array=c.fromValues(a,b,d,e),this._dirty=!0};return d.prototype={constructor:d,get x(){return this._array[0]},set x(a){this._array[0]=a,this._dirty=!0},get y(){this._array[1]=value,this._dirty=!0},set y(){return this._array[1]},get z(){return this._array[2]},set z(a){this._array[2]=a,this._dirty=!0},get w(){return this._array[3]},set w(a){this._array[3]=a,this._dirty=!0},add:function(a){return c.add(this._array,this._array,a._array),this._dirty=!0,this},set:function(a,b,c,d){return this._array[0]=a,this._array[1]=b,this._array[2]=c,this._array[3]=d,this._dirty=!0,this},clone:function(){return new d(this.x,this.y,this.z,this.w)},copy:function(a){return c.copy(this._array,a._array),this._dirty=!0,this},cross:function(a,b){return c.cross(a._array,this._array,b._array),this},dist:function(a){return c.dist(this._array,a._array)},distance:function(a){return c.distance(this._array,a._array)},div:function(a){return c.div(this._array,this._array,a._array),this._dirty=!0,this},divide:function(a){return c.divide(this._array,this._array,a._array),this._dirty=!0,this},dot:function(a){return c.dot(this._array,a._array)},len:function(){return c.len(this._array)},length:function(){return c.length(this._array)},lerp:function(a,b,d){return c.lerp(this._array,a._array,b._array,d),this._dirty=!0,this},min:function(a){return vec2.min(this._array,this._array,a._array),this._dirty=!0,this},max:function(a){return vec2.max(this._array,this._array,a._array),this._dirty=!0,this},mul:function(a){return c.mul(this._array,this._array,a._array),this._dirty=!0,this},multiply:function(a){return c.multiply(this._array,this._array,a._array),this._dirty=!0,this},negate:function(){return c.negate(this._array,this._array),this._dirty=!0,this},normalize:function(){return c.normalize(this._array,this._array),this._dirty=!0,this},random:function(a){return c.random(this._array,a),this._dirty=!0,this},scale:function(a){return c.scale(this._array,this._array,a),this._dirty=!0,this},scaleAndAdd:function(a,b){return c.scaleAndAdd(this._array,this._array,a._array,b),this._dirty=!0,this},sqrDist:function(a){return c.sqrDist(this._array,a._array)},squaredDistance:function(a){return c.squaredDistance(this._array,a._array)},sqrLen:function(){return c.sqrLen(this._array)},squaredLength:function(){return c.squaredLength(this._array)},sub:function(a){return c.sub(this._array,this._array,a._array),this._dirty=!0,this},subtract:function(a){return c.subtract(this._array,this._array,a._array),this._dirty=!0,this},transformMat4:function(a){return c.transformMat4(this._array,this._array,a._array),this._dirty=!0,this},transformQuat:function(a){return c.transformQuat(this._array,this._array,a._array),this._dirty=!0,this},toString:function(){return"["+Array.prototype.join.call(this._array,",")+"]"}},d}),d("core/base",["require","./mixin/derive","./mixin/notifier","./Cache","_"],function(a){var b=a("./mixin/derive"),c=a("./mixin/notifier"),d=a("./Cache"),e=a("_"),f=function(){this.cache=new d};return e.extend(f,b),e.extend(f.prototype,c),f}),d("particleSystem/Particle",["require","../math/Vector3","glmatrix"],function(a){var b=a("../math/Vector3"),c=a("glmatrix"),d=c.vec3,e=function(){this.position=new b,this.rotation=0,this.velocity=new b,this.angularVelocity=0,this.life=0,this.age=0,this.spriteSize=1,this.weight=1,this.emitter=null};return e.prototype.update=function(a){d.scaleAndAdd(this.position._array,this.position._array,this.velocity._array,a),this.rotation+=this.angularVelocity},e}),d("particleSystem/Emitter",["require","../core/base","../math/Vector3","./Particle","../math/Value","glmatrix"],function(a){var b=a("../core/base"),c=a("../math/Vector3"),d=a("./Particle"),e=a("../math/Value"),f=a("glmatrix");f.vec3;var g=b.derive(function(){return{max:1e3,amount:20,life:e.constant(1),position:e.vector(new c),rotation:e.constant(0),velocity:e.vector(new c),angularVelocity:e.constant(0),spriteSize:e.constant(1),weight:e.constant(1),_particlePool:[]}},function(){for(var a=0;a<this.max;a++){var b=new d;b.emitter=this,this._particlePool.push(b)}},{emit:function(a){var b;b=this._particlePool.length>this.amount?this.amount:this._particlePool.length;for(var c,d=0;b>d;d++)c=this._particlePool.pop(),this.position.get(c.position),c.rotation=this.rotation.get(),this.velocity.get(c.velocity),c.angularVelocity=this.angularVelocity.get(),c.life=this.life.get(),c.spriteSize=this.spriteSize.get(),c.weight=this.weight.get(),c.age=0,a.push(c)},kill:function(a){this._particlePool.push(a)}});return g.constant=e.constant,g.vector=e.vector,g.random1D=e.random1D,g.random2D=e.random2D,g.random3D=e.random3D,g}),d("particleSystem/ForceField",["require","../core/base","../math/Vector3","glmatrix"],function(a){var b=a("../core/base"),c=a("../math/Vector3"),d=a("glmatrix"),e=d.vec3,f=b.derive(function(){return{force:new c}},{applyTo:function(a,b,c,d){c>0&&e.scaleAndAdd(a._array,a._array,this.force._array,d/c)}});return f}),d("particleSystem/GravityField",["require","../core/base","glmatrix"],function(a){var b=a("../core/base"),c=a("glmatrix");c.vec3;var d=b.derive(function(){},{applyTo:function(a,b,c,d){c>0&&(a._array[1]-=this.gravity*d/c)}});return d}),d("particleSystem/particle.essl",[],function(){return"@export buildin.particle.vertex\n\nuniform mat4 worldView : WORLDVIEW;\nuniform mat4 projection : PROJECTION;\n\nattribute vec3 position : POSITION;\nattribute vec3 normal : NORMAL;\n\nvarying float v_Age;\n\nvoid main() {\n    v_Age = normal.x;\n    float rotation = normal.y;\n\n    vec4 worldViewPosition = worldView * vec4(position, 1.0);\n    gl_PointSize = -normal.z / worldViewPosition.z;\n    gl_Position = projection * worldViewPosition;\n    \n}\n\n@end\n\n@export buildin.particle.fragment\n\nuniform sampler2D sprite;\nuniform sampler2D gradient;\nuniform vec3 color : [1.0, 1.0, 1.0];\nuniform float alpha : 1.0;\n\nvarying float v_Age;\n\nvoid main() {\n    vec4 color = vec4(color, alpha);\n    #ifdef SPRITE_ENABLED\n        color *= texture2D(sprite, gl_PointCoord);\n    #endif\n    #ifdef GRADIENT_ENABLED\n        color *= texture2D(gradient, vec2(v_Age, 0.5));\n    #endif\n\n    gl_FragColor = color;\n}\n\n@end"}),d("particleSystem/ParticleSystem",["require","../Node","../math/Vector3","../Geometry","../Mesh","../Material","../Shader","glmatrix","./particle.essl"],function(a){var b=a("../Node");a("../math/Vector3");var c=a("../Geometry"),d=a("../Mesh"),e=a("../Material"),f=a("../Shader"),g=a("glmatrix");g.vec3,f.import(a("./particle.essl"));var h=b.derive(function(){return{loop:!0,duration:1,geometry:new c({hint:c.DYNAMIC_DRAW}),material:null,mode:d.POINTS,_drawCache:{},_particles:[],_fields:[],_emitters:[]}},function(){var a=new f({vertex:f.source("buildin.particle.vertex"),fragment:f.source("buildin.particle.fragment")});this.material||(this.material=new e({shader:a,transparent:!0,depthMask:!1}))},{isRenderable:function(){return!0},addEmitter:function(a){this._emitters.push(a)},removeEmitter:function(a){this._emitters.splice(this._emitters.indexOf(a),1)},addField:function(a){this._fields.push(a)},removeField:function(a){this._fields.splice(this._fields.indexOf(a),1)},updateParticles:function(a){a/=1e3;for(var b=this._particles,c=0;c<this._emitters.length;c++)this._emitters[c].emit(b);for(var d=b.length,c=0;d>c;){var e=b[c];e.age+=a,e.age>=e.life?(e.emitter.kill(e),b[c]=b[d-1],b.pop(),d--):c++}for(var c=0;d>c;c++){var e=b[c];if(this._fields.length>0)for(var f=0;f<this._fields.length;f++)this._fields[f].applyTo(e.velocity,e.position,e.weight,a);e.update(a)}},render:function(a){this._particles;for(var b=this.geometry,c=b.attributes.position.value,e=b.attributes.normal.value,f=this._particles.length,g=0;f>g;g++){var h=this._particles[g];c[g]=h.position._array,e[g]||(e[g]=[]),e[g][0]=h.age/h.life,e[g][1]=h.rotation,e[g][2]=h.spriteSize}return c.length=f,e.length=f,b.dirty("position"),b.dirty("normal"),d.prototype.render.call(this,a)}});return h}),d("picking/color.essl",[],function(){return"@export buildin.picking.color.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\n\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n\nuniform mat4 invBindMatrix[JOINT_NUMBER] : INV_BIND_MATRIX;\n#endif\n\nvoid main(){\n\n    vec3 skinnedPosition = position;\n\n    #ifdef SKINNING\n        mat4 skinMatrix;\n        if (joint.x >= 0.0){\n            skinMatrix = invBindMatrix[int(joint.x)] * weight.x;\n        }\n        if (joint.y >= 0.0){\n            skinMatrix += invBindMatrix[int(joint.y)] * weight.y;\n        }\n        if (joint.z >= 0.0){\n            skinMatrix += invBindMatrix[int(joint.z)] * weight.z;\n        }\n        if (joint.w >= 0.0){\n            skinMatrix += invBindMatrix[int(joint.w)] * (1.0-weight.x-weight.y-weight.z);\n        }\n        skinnedPosition = (skinMatrix * vec4(position, 1.0)).xyz;\n    #endif\n\n    gl_Position = worldViewProjection * vec4(skinnedPosition, 1.0);\n}\n\n@end\n\n@end\n@export buildin.picking.color.fragment\n\nuniform vec4 color : [1.0, 1.0, 1.0, 1.0];\n\nvoid main(){\n    gl_FragColor = color;\n}\n\n@end"}),d("picking/Pixel",["require","../core/Base","../FrameBuffer","../texture/Texture2D","../Shader","../Material","./color.essl"],function(a){function b(a){var b=a>>16,c=a-(b<<8)>>8,d=a-(b<<16)-(c<<8);return[b,c,d]}function c(a,b,c){return(a<<16)+(b<<8)+c}var d=a("../core/Base"),e=a("../FrameBuffer"),f=a("../texture/Texture2D"),g=a("../Shader"),h=a("../Material");g.import(a("./color.essl"));var i=d.derive(function(){return{renderer:null,downSampleRatio:1,width:100,height:100,lookupOffset:1,_frameBuffer:null,_texture:null,_shader:null,_idMaterials:[],_lookupTable:[],_meshMaterials:[],_idOffset:0}},function(){this.init()},{init:function(){this._texture=new f({width:this.width*this.downSampleRatio,height:this.height*this.downSampleRatio}),this._frameBuffer=new e,this._shader=new g({vertex:g.source("buildin.picking.color.vertex"),fragment:g.source("buildin.picking.color.fragment")})},setPrecision:function(a){this._texture.width=this.width*a,this._texture.height=this.height*a,this.downSampleRatio=a},resize:function(a,b){this._texture.width=a*this.downSampleRatio,this._texture.height=b*this.downSampleRatio,this.width=a,this.height=b},update:function(a,b){var c=this.renderer;this._frameBuffer.attach(c.gl,this._texture),this._frameBuffer.bind(c),this._idOffset=this.lookupOffset,this._setMaterial(a),c.render(a,b),this._restoreMaterial(),this._frameBuffer.unbind(c)},_setMaterial:function(a){for(var c=0;c<a._children.length;c++){var d=a._children[c];if(d.geometry&&d.material&&d.material.shader){var e=this._idOffset++,f=e-this.lookupOffset,g=this._idMaterials[f];if(!g){g=new h({shader:this._shader});var i=b(e);i[0]/=255,i[1]/=255,i[2]/=255,i[3]=1,g.set("color",i),this._idMaterials[f]=g}this._meshMaterials[f]=d.material,this._lookupTable[f]=d,d.material=g}d._children.length&&this._setMaterial(d)}},pick:function(a,b){var d=this.renderer,e=this.downSampleRatio;this._texture.width,this._texture.height,a=Math.ceil(e*a),b=Math.ceil(e*(this.height-b)),this._frameBuffer.bind(d);var f=new Uint8Array(4),g=d.gl;if(g.readPixels(a,b,1,1,g.RGBA,g.UNSIGNED_BYTE,f),this._frameBuffer.unbind(d),255===f[3]){var h=c(f[0],f[1],f[2]);if(h){var i=this._lookupTable[h-this.lookupOffset];return i}}},_restoreMaterial:function(){for(var a=0;a<this._lookupTable.length;a++)this._lookupTable[a].material=this._meshMaterials[a]},dispose:function(){}});return i}),d("plugin/FirstPersonControl",["require","../core/Base","../math/Vector3","../math/Matrix4","../math/Quaternion"],function(a){function b(a,b){return a.__bindfuc__||(a.__bindfuc__=function(){return a.apply(b,arguments)}),a.__bindfuc__}var c=a("../core/Base"),d=a("../math/Vector3");a("../math/Matrix4");var e=a("../math/Quaternion"),f=c.derive(function(){return{target:null,domElement:null,sensitivity:1,speed:.4,up:new d(0,1,0),_moveForward:!1,_moveBackward:!1,_moveLeft:!1,_moveRight:!1,_offsetPitch:0,_offsetRoll:0}},function(){this.enable()},{enable:function(){this.target.eulerOrder=["Y","X","Z"];var a=this.domElement;a.addEventListener("click",this.requestPointerLock),document.addEventListener("pointerlockchange",b(this._lockChange,this),!1),document.addEventListener("mozpointerlockchange",b(this._lockChange,this),!1),document.addEventListener("webkitpointerlockchange",b(this._lockChange,this),!1),document.addEventListener("keydown",b(this._keyDown,this),!1),document.addEventListener("keyup",b(this._keyUp,this),!1)},disable:function(){this.target.off("beforeupdate",this._beforeUpdateCamera);var a=this.domElement;a.exitPointerLock=a.exitPointerLock||a.mozExitPointerLock||a.webkitExitPointerLock,a.exitPointerLock&&a.exitPointerLock(),document.removeEventListener("pointerlockchange",b(this._lockChange,this)),document.removeEventListener("mozpointerlockchange",b(this._lockChange,this)),document.removeEventListener("webkitpointerlockchange",b(this._lockChange,this))},requestPointerLock:function(){var a=this;a.requestPointerLock=a.requestPointerLock||a.mozRequestPointerLock||a.webkitRequestPointerLock,a.requestPointerLock()},update:function(){return new e,function(){var a=this.target,b=this.target.position,c=a.localTransform.right.normalize(),d=a.localTransform.forward.normalize();this._moveForward&&b.scaleAndAdd(d,-this.speed),this._moveBackward&&b.scaleAndAdd(d,this.speed),this._moveLeft&&b.scaleAndAdd(c,-this.speed/2),this._moveRight&&b.scaleAndAdd(c,this.speed/2),a.rotateAround(a.position,this.up,-this._offsetPitch*Math.PI/180);var c=a.localTransform.right;a.rotateAround(a.position,c,-this._offsetRoll*Math.PI/180),this._offsetRoll=this._offsetPitch=0}}(),_lockChange:function(){document.pointerlockElement===this.domElement||document.mozPointerlockElement===this.domElement||document.webkitPointerLockElement===this.domElement?document.addEventListener("mousemove",b(this._mouseMove,this),!1):document.removeEventListener("mousemove",b(this._mouseMove,this),!1)},_mouseMove:function(a){var b=a.movementX||a.mozMovementX||a.webkitMovementX||0,c=a.movementY||a.mozMovementY||a.webkitMovementY||0;this._offsetPitch+=b*this.sensitivity/10,this._offsetRoll+=c*this.sensitivity/10},_keyDown:function(a){switch(a.keyCode){case 87:case 37:this._moveForward=!0;break;case 83:case 40:this._moveBackward=!0;break;case 65:case 37:this._moveLeft=!0;break;case 68:case 39:this._moveRight=!0}},_keyUp:function(a){switch(a.keyCode){case 87:case 37:this._moveForward=!1;break;case 83:case 40:this._moveBackward=!1;break;case 65:case 37:this._moveLeft=!1;break;case 68:case 39:this._moveRight=!1}}});return f}),d("plugin/OrbitControl",["require","../core/Base","../math/Vector3","../math/Matrix4","../math/Quaternion"],function(a){function b(a,b){return a.__bindfuc__||(a.__bindfuc__=function(){return a.apply(b,arguments)}),a.__bindfuc__}var c=a("../core/Base"),d=a("../math/Vector3"),e=a("../math/Matrix4");a("../math/Quaternion");var f=new e,g=c.derive(function(){return{target:null,domElement:null,sensitivity:1,origin:new d,up:new d(0,1,0),minDistance:0,maxDistance:1/0,minPolarAngle:0,maxPolarAngle:Math.PI,_offsetPitch:0,_offsetRoll:0,_panX:0,_panY:0,_offsetX:0,_offsetY:0,_forward:0,_op:-1}},function(){this.domElement&&this.enable()},{enable:function(){this.domElement.addEventListener("mousedown",b(this._mouseDown,this),!1),this.domElement.addEventListener("mousewheel",b(this._mouseWheel,this),!1),this.domElement.addEventListener("DOMMouseScroll",b(this._mouseWheel,this),!1)},disable:function(){this.domElement.removeEventListener("mousedown",b(this._mouseDown,this)),this.domElement.removeEventListener("mousewheel",b(this._mouseWheel,this)),this.domElement.removeEventListener("DOMMouseScroll",b(this._mouseWheel,this)),this._mouseUp()},_mouseWheel:function(a){a.preventDefault();var b=a.wheelDelta||-a.detail;this._forward+=b*this.sensitivity},_mouseDown:function(a){document.addEventListener("mousemove",b(this._mouseMove,this),!1),document.addEventListener("mouseup",b(this._mouseUp,this),!1),document.addEventListener("mouseout",b(this._mouseOut,this),!1),this._offsetX=a.pageX,this._offsetY=a.pageY,0===a.button?this._op=0:1===a.button&&(this._op=1)},_mouseMove:function(a){var b=a.pageX-this._offsetX,c=a.pageY-this._offsetY;if(0===this._op)this._offsetPitch+=b*this.sensitivity/100,this._offsetRoll+=c*this.sensitivity/100;else if(1===this._op){var d=this.origin.distance(this.target.position),e=Math.sin(this.target.fov/2)/100;this._panX-=b*this.sensitivity*d*e,this._panY-=c*this.sensitivity*d*e}this._offsetX=a.pageX,this._offsetY=a.pageY},_mouseUp:function(){document.removeEventListener("mousemove",b(this._mouseMove,this)),document.removeEventListener("mouseup",b(this._mouseUp,this)),document.removeEventListener("mouseout",b(this._mouseOut,this)),this._op=-1},_mouseOut:function(){this._mouseUp()},update:function(){var a=this.target,b=a.localTransform.forward.normalize(),c=a.localTransform.up.normalize();if(0===this._op){a.rotateAround(this.origin,this.up,-this._offsetPitch),this.up.normalize(),f.copy(a.localTransform);var d=a.localTransform.right;a.rotateAround(this.origin,d,-this._offsetRoll);var b=a.localTransform.forward.normalize(),c=a.localTransform.up.normalize(),e=Math.acos(this.up.dot(b)),g=this.up.dot(c)>=0;g&&e>=this.minPolarAngle&&e<=this.maxPolarAngle||(a.localTransform.copy(f),a.decomposeLocalTransform()),this._offsetRoll=this._offsetPitch=0}else if(1===this._op){var d=a.localTransform.right.normalize().scale(-this._panX),c=a.localTransform.up.normalize().scale(this._panY);a.position.add(d).add(c),this.origin.add(d).add(c),this._panX=this._panY=0}if(0!==this._forward){var h=a.position.distance(this.origin),i=h+this._forward*h/5e3;i<this.maxDistance&&i>this.minDistance&&a.position.scaleAndAdd(b,this._forward*h/5e3),this._forward=0}}});return g}),d("plugin/Skybox",["require","../Mesh","../geometry/Cube","../Shader","../Material","../shader/library"],function(a){var b=a("../Mesh"),c=a("../geometry/Cube"),d=a("../Shader"),e=a("../Material");a("../shader/library");var f=new d({vertex:d.source("buildin.skybox.vertex"),fragment:d.source("buildin.skybox.fragment")}),g=b.derive(function(){var a=new e({shader:f,depthMask:!1});return{scene:null,geometry:new c,material:a,culling:!1,_beforeRenderScene:function(a,b,c){this.position.copy(c.getWorldPosition()),this.update(),a.renderQueue([this],c),a.gl.clear(a.gl.DEPTH_BUFFER_BIT)}}},function(){var a=this.scene;a&&this.attachScene(a)},{attachScene:function(a){this.scene&&this.scene.off("beforerender",this._beforeRenderScene),this.scene=a,a.on("beforerender",this._beforeRenderScene,this)},detachScene:function(a){a.off("beforerender",this._beforeRenderScene,this)}});return g}),d("plugin/Skydome",["require","../Mesh","../geometry/Sphere","../Shader","../Material","../shader/library"],function(a){var b=a("../Mesh"),c=a("../geometry/Sphere"),d=a("../Shader"),e=a("../Material");
a("../shader/library");var f=b.derive(function(){var a=new d({vertex:d.source("buildin.basic.vertex"),fragment:d.source("buildin.basic.fragment")});a.enableTexture("diffuseMap");var b=new e({shader:a,depthMask:!1});return{scene:null,geometry:new c({widthSegments:30,heightSegments:30}),material:b,culling:!1,_beforeRenderScene:function(a,b,c){this.position.copy(c.getWorldPosition()),this.update(),a.renderQueue([this],c),a.gl.clear(a.gl.DEPTH_BUFFER_BIT)}}},function(){var a=this.scene;a&&this.attachScene(a)},{attachScene:function(a){this.scene&&this.scene.off("beforerender",this._beforeRenderScene),this.scene=a,a.on("beforerender",this._beforeRenderScene,this)},detachScene:function(a){a.off("beforerender",this._beforeRenderScene,this)}});return f}),d("prePass/EnvironmentMap",["require","../core/Base","../math/Vector3","../camera/Perspective","../core/glenum","../FrameBuffer","../texture/TextureCube"],function(a){var b=a("../core/Base"),c=a("../math/Vector3"),d=a("../camera/Perspective"),e=a("../core/glenum"),f=a("../FrameBuffer");a("../texture/TextureCube");var g=["px","nx","py","ny","pz","nz"],h={px:e.TEXTURE_CUBE_MAP_POSITIVE_X,py:e.TEXTURE_CUBE_MAP_POSITIVE_Y,pz:e.TEXTURE_CUBE_MAP_POSITIVE_Z,nx:e.TEXTURE_CUBE_MAP_NEGATIVE_X,ny:e.TEXTURE_CUBE_MAP_NEGATIVE_Y,nz:e.TEXTURE_CUBE_MAP_NEGATIVE_Z},i=b.derive(function(){var a={position:new c,far:1e3,near:.1,texture:null,frameBuffer:new f};return a._cameras={px:new d({fov:90}),nx:new d({fov:90}),py:new d({fov:90}),ny:new d({fov:90}),pz:new d({fov:90}),nz:new d({fov:90})},a._cameras.px.lookAt(c.POSITIVE_X,c.NEGATIVE_Y),a._cameras.nx.lookAt(c.NEGATIVE_X,c.NEGATIVE_Y),a._cameras.py.lookAt(c.POSITIVE_Y,c.POSITIVE_Z),a._cameras.ny.lookAt(c.NEGATIVE_Y,c.NEGATIVE_Z),a._cameras.pz.lookAt(c.POSITIVE_Z,c.NEGATIVE_Y),a._cameras.nz.lookAt(c.NEGATIVE_Z,c.NEGATIVE_Y),a},{render:function(a,b,c){var d=a.gl;b.autoUpdate=!1,c||b.update(!0);for(var e=this.texture.width,f=180*(2*Math.atan(e/(e-.5))/Math.PI),i=0;6>i;i++){var j=g[i],k=this._cameras[j];k.position.copy(this.position),k.far=this.far,k.near=this.near,k.fov=f,this.frameBuffer.attach(d,this.texture,d.COLOR_ATTACHMENT0,h[j]),this.frameBuffer.bind(a),a.render(b,k,!0),this.frameBuffer.unbind(a)}},dispose:function(a){this.frameBuffer.dispose(a._gl)}});return i}),d("prePass/Reflection",["require","../core/Base","../math/Vector4"],function(a){var b=a("../core/Base");a("../math/Vector4");var c=b.derive(function(){},{render:function(){}});return c}),d("prePass/shadowmap.essl",[],function(){return"\n@export buildin.sm.depth.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\n\nattribute vec3 position : POSITION;\n\n#ifdef SKINNING\nattribute vec3 weight : WEIGHT;\nattribute vec4 joint : JOINT;\n\nuniform mat4 invBindMatrix[JOINT_NUMBER] : INV_BIND_MATRIX;\n#endif\n\nvarying vec4 v_ViewPosition;\nvoid main(){\n    \n    vec3 skinnedPosition = position;\n    \n    #ifdef SKINNING\n        mat4 skinMatrix;\n        if (joint.x >= 0.0){\n            skinMatrix = invBindMatrix[int(joint.x)] * weight.x;\n        }\n        if (joint.y >= 0.0){\n            skinMatrix += invBindMatrix[int(joint.y)] * weight.y;\n        }\n        if (joint.z >= 0.0){\n            skinMatrix += invBindMatrix[int(joint.z)] * weight.z;\n        }\n        if (joint.w >= 0.0){\n            skinMatrix += invBindMatrix[int(joint.w)] * (1.0-weight.x-weight.y-weight.z);\n        }\n        skinnedPosition = (skinMatrix * vec4(position, 1.0)).xyz;\n    #endif\n\n    v_ViewPosition = worldViewProjection * vec4(skinnedPosition, 1.0);\n    gl_Position = v_ViewPosition;\n\n}\n@end\n\n@export buildin.sm.depth.fragment\n\nvarying vec4 v_ViewPosition;\nuniform float bias : 0.001;\n\n#extension GL_OES_standard_derivatives : enable\n\n@import buildin.util.pack_depth\n\nvoid main(){\n    // Whats the difference between gl_FragCoord.z and this v_ViewPosition\n    // gl_FragCoord consider the polygon offset ?\n    float depth = v_ViewPosition.z / v_ViewPosition.w;\n    // float depth = gl_FragCoord.z / gl_FragCoord.w;\n\n    #ifdef USE_VSM\n        depth = depth * 0.5 + 0.5;\n        float moment1 = depth;\n        float moment2 = depth * depth;\n\n        // Adjusting moments using partial derivative\n        float dx = dFdx(depth);\n        float dy = dFdy(depth);\n        moment2 += 0.25*(dx*dx+dy*dy);\n\n        gl_FragColor = vec4(moment1, moment2, 0.0, 1.0);\n    #else\n        // Add slope scaled bias using partial derivative\n        depth += max(dFdx(depth), dFdy(depth)) + bias;\n\n        gl_FragColor = packDepth(depth * 0.5 + 0.5);\n    #endif\n}\n@end\n\n@export buildin.sm.debug_depth\n\nuniform sampler2D depthMap;\nvarying vec2 v_Texcoord;\n\n@import buildin.util.unpack_depth\n\nvoid main() {\n    vec4 tex = texture2D(depthMap, v_Texcoord);\n    #ifdef USE_VSM\n        gl_FragColor = vec4(tex.rgb, 1.0);\n    #else\n        float depth = unpackDepth(tex);\n        gl_FragColor = vec4(depth, depth, depth, 1.0);\n    #endif\n}\n\n@end\n\n\n@export buildin.sm.distance.vertex\n\nuniform mat4 worldViewProjection : WORLDVIEWPROJECTION;\nuniform mat4 world : WORLD;\n\nattribute vec3 position : POSITION;\n\n#ifdef SKINNING\nattribute vec3 boneWeight;\nattribute vec4 boneIndex;\n\nuniform mat4 boneMatrices[BONE_MATRICES_NUMBER];\n#endif\n\nvarying vec3 v_WorldPosition;\n\nvoid main(){\n\n    vec3 skinnedPosition = position;\n    #ifdef SKINNING\n        mat4 skinMatrix;\n        if(boneIndex.x >= 0.0){\n            skinMatrix = boneMatrices[int(boneIndex.x)] * boneWeight.x;\n        }\n        if(boneIndex.y >= 0.0){\n            skinMatrix += boneMatrices[int(boneIndex.y)] * boneWeight.y;\n        }\n        if(boneIndex.z >= 0.0){\n            skinMatrix += boneMatrices[int(boneIndex.z)] * boneWeight.z;\n        }\n        if(boneIndex.w >= 0.0){\n            skinMatrix += boneMatrices[int(boneIndex.w)] * (1.0-boneWeight.x-boneWeight.y-boneWeight.z);\n        }\n        skinnedPosition = (skinMatrix * vec4(position, 1.0)).xyz;\n    #endif\n\n    gl_Position = worldViewProjection * vec4(skinnedPosition , 1.0);\n    v_WorldPosition = (world * vec4(skinnedPosition, 1.0)).xyz;\n}\n\n@end\n\n@export buildin.sm.distance.fragment\n\nuniform vec3 lightPosition;\nuniform float range : 100;\n\nvarying vec3 v_WorldPosition;\n\n@import buildin.util.pack_depth\n\nvoid main(){\n    float dist = distance(lightPosition, v_WorldPosition);\n    #ifdef USE_VSM\n        gl_FragColor = vec4(dist, dist * dist, 0.0, 0.0);\n    #else\n        dist = dist / range;\n        gl_FragColor = packDepth(dist);\n    #endif\n}\n@end\n\n@export buildin.plugin.compute_shadow_map\n\n#if defined(SPOT_LIGHT_SHADOWMAP_NUMBER) || defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER) || defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n\n#ifdef SPOT_LIGHT_SHADOWMAP_NUMBER\nuniform sampler2D spotLightShadowMaps[SPOT_LIGHT_SHADOWMAP_NUMBER];\nuniform mat4 spotLightMatrices[SPOT_LIGHT_SHADOWMAP_NUMBER];\n#endif\n\n#ifdef DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER\n#if SHADOW_CASCADE > 1\nuniform sampler2D directionalLightShadowMaps[SHADOW_CASCADE];\nuniform mat4 directionalLightMatrices[SHADOW_CASCADE];\nuniform float shadowCascadeClipsNear[SHADOW_CASCADE];\nuniform float shadowCascadeClipsFar[SHADOW_CASCADE];\n#else\nuniform sampler2D directionalLightShadowMaps[DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER];\nuniform mat4 directionalLightMatrices[DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER];\n#endif\n#endif\n\n#ifdef POINT_LIGHT_SHADOWMAP_NUMBER\nuniform samplerCube pointLightShadowMaps[POINT_LIGHT_SHADOWMAP_NUMBER];\nuniform float pointLightRanges[POINT_LIGHT_SHADOWMAP_NUMBER];\n#endif\n\nuniform bool shadowEnabled : true;\n\n@import buildin.util.unpack_depth\n\n#if defined(DIRECTIONAL_LIGHT_NUMBER) || defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n\nfloat tapShadowMap(sampler2D map, vec2 uv, float z){\n    vec4 tex = texture2D(map, uv);\n    return unpackDepth(tex) * 2.0 - 1.0< z ? 0.0 : 1.0;\n}\n\nfloat pcf(sampler2D map, vec2 uv, float z){\n\n    float shadowContrib = tapShadowMap(map, uv, z);\n    float offset = 1.0/1024.0;\n    shadowContrib += tapShadowMap(map, uv+vec2(offset, 0.0), z);\n    shadowContrib += tapShadowMap(map, uv+vec2(offset, offset), z);\n    shadowContrib += tapShadowMap(map, uv+vec2(-offset, offset), z);\n    shadowContrib += tapShadowMap(map, uv+vec2(0.0, offset), z);\n    shadowContrib += tapShadowMap(map, uv+vec2(-offset, 0.0), z);\n    shadowContrib += tapShadowMap(map, uv+vec2(-offset, -offset), z);\n    shadowContrib += tapShadowMap(map, uv+vec2(offset, -offset), z);\n    shadowContrib += tapShadowMap(map, uv+vec2(0.0, -offset), z);\n\n    return shadowContrib / 9.0;\n}\nfloat chebyshevUpperBound(vec2 moments, float z){\n    float p = 0.0;\n    z = z * 0.5 + 0.5;\n    if (z <= moments.x) {\n        p = 1.0;\n    }\n    float variance = moments.y - moments.x * moments.x;\n    // http://fabiensanglard.net/shadowmappingVSM/\n    variance = max(variance, 0.0000001);\n    // Compute probabilistic upper bound. \n    float mD = moments.x - z;\n    float pMax = variance / (variance + mD * mD);\n    // Now reduce light-bleeding by removing the [0, x] tail and linearly rescaling (x, 1]\n    // TODO : bleedBias parameter ?\n    pMax = clamp((pMax-0.4)/(1.0-0.4), 0.0, 1.0);\n    return max(p, pMax);\n}\nfloat computeShadowContrib(sampler2D map, mat4 lightVPM, vec3 position){\n    \n    vec4 posInLightSpace = lightVPM * vec4(v_WorldPosition, 1.0);\n    posInLightSpace.xyz /= posInLightSpace.w;\n    float z = posInLightSpace.z;\n    // In frustum\n    if(all(greaterThan(posInLightSpace.xyz, vec3(-0.99, -0.99, -1.0))) &&\n        all(lessThan(posInLightSpace.xyz, vec3(0.99, 0.99, 1.0)))){\n        // To texture uv\n        vec2 uv = (posInLightSpace.xy+1.0) / 2.0;\n\n        #ifdef USE_VSM\n            vec2 moments = texture2D(map, uv).xy;\n            return chebyshevUpperBound(moments, z);\n        #else\n            return pcf(map, uv, z);\n        #endif\n    }\n    return 1.0;\n}\n\n#endif\n\n#ifdef POINT_LIGHT_SHADOWMAP_NUMBER\n\nfloat computeShadowOfCube(samplerCube map, vec3 direction, float range){\n    vec4 shadowTex = textureCube(map, direction);\n    float dist = length(direction);\n\n    #ifdef USE_VSM\n        vec2 moments = shadowTex.xy;\n        float variance = moments.y - moments.x * moments.x;\n        float mD = moments.x - dist;\n        float p = variance / (variance + mD * mD);\n        if(moments.x + 0.001 < dist){\n            return clamp(p, 0.0, 1.0);\n        }else{\n            return 1.0;\n        }\n    #else\n        if((unpackDepth(shadowTex) + 0.0002) * range < dist){\n            return 0.0;\n        }else{\n            return 1.0;\n        }\n    #endif\n}\n#endif\n\n#if defined(SPOT_LIGHT_SHADOWMAP_NUMBER)\n\nvoid computeShadowOfSpotLights(vec3 position, inout float shadowContribs[SPOT_LIGHT_NUMBER] ){\n    for(int i = 0; i < SPOT_LIGHT_SHADOWMAP_NUMBER; i++){\n        float shadowContrib = computeShadowContrib(spotLightShadowMaps[i], spotLightMatrices[i], position);\n        shadowContribs[i] = shadowContrib;\n    }\n    // set default fallof of rest lights\n    for(int i = SPOT_LIGHT_SHADOWMAP_NUMBER; i < SPOT_LIGHT_NUMBER; i++){\n        shadowContribs[i] = 1.0;\n    }\n}\n\n#endif\n\n\n#if defined(DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER)\n\nvoid computeShadowOfDirectionalLights(vec3 position, inout float shadowContribs[DIRECTIONAL_LIGHT_NUMBER]){\n    #if SHADOW_CASCADE == 1\n        for(int i = 0; i < DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER; i++){\n            float shadowContrib = computeShadowContrib(directionalLightShadowMaps[i], directionalLightMatrices[i], position);\n            shadowContribs[i] = shadowContrib;\n        }\n    #else\n        // http://www.opengl.org/wiki/Compute_eye_space_from_window_space\n        float depth = (2.0 * gl_FragCoord.z - gl_DepthRange.near - gl_DepthRange.far)\n                        / (gl_DepthRange.far - gl_DepthRange.near);\n        for (int i = 0; i < SHADOW_CASCADE; i++) {\n            if (\n                depth >= shadowCascadeClipsNear[i] &&\n                depth <= shadowCascadeClipsFar[i]\n            ) {\n                float shadowContrib = computeShadowContrib(directionalLightShadowMaps[i], directionalLightMatrices[i], position);\n                shadowContribs[0] = shadowContrib;\n                // shadowContribs[0] = float(i) / float(SHADOW_CASCADE);\n            }\n        }\n    #endif\n    // set default fallof of rest lights\n    for(int i = DIRECTIONAL_LIGHT_SHADOWMAP_NUMBER; i < DIRECTIONAL_LIGHT_NUMBER; i++){\n        shadowContribs[i] = 1.0;\n    }\n}\n\n#endif\n\n\n#if defined(POINT_LIGHT_SHADOWMAP_NUMBER)\n\nvoid computeShadowOfPointLights(vec3 position, inout float shadowContribs[POINT_LIGHT_NUMBER] ){\n    for(int i = 0; i < POINT_LIGHT_SHADOWMAP_NUMBER; i++){\n        vec3 lightPosition = pointLightPosition[i];\n        vec3 direction = position - lightPosition;\n        shadowContribs[i] = computeShadowOfCube(pointLightShadowMaps[i], direction, pointLightRanges[i]);\n    }\n    for(int i = POINT_LIGHT_SHADOWMAP_NUMBER; i < POINT_LIGHT_NUMBER; i++){\n        shadowContribs[i] = 1.0;\n    }\n}\n\n#endif\n\n#endif\n\n@end"}),d("prePass/ShadowMap",["require","../core/Base","../core/glenum","../math/Vector3","../math/BoundingBox","../math/Frustum","../math/Matrix4","../Shader","../Light","../Mesh","../light/Spot","../light/Directional","../light/Point","../shader/library","../Material","../FrameBuffer","../texture/Texture2D","../texture/TextureCube","../camera/Perspective","../camera/Orthographic","../compositor/Pass","../compositor/texturePool","glmatrix","_","./shadowmap.essl"],function(a){var b=a("../core/Base"),c=a("../core/glenum"),d=a("../math/Vector3"),e=a("../math/BoundingBox"),f=a("../math/Frustum"),g=a("../math/Matrix4"),h=a("../Shader");a("../Light"),a("../Mesh");var i=a("../light/Spot"),j=a("../light/Directional"),k=a("../light/Point");a("../shader/library");var l=a("../Material"),m=a("../FrameBuffer"),n=a("../texture/Texture2D"),o=a("../texture/TextureCube"),p=a("../camera/Perspective"),q=a("../camera/Orthographic"),r=a("../compositor/Pass"),s=a("../compositor/texturePool"),t=a("glmatrix"),u=t.mat4;t.vec3,a("_");var v=new m;h.import(a("./shadowmap.essl"));var w=["px","nx","py","ny","pz","nz"],x={px:c.TEXTURE_CUBE_MAP_POSITIVE_X,py:c.TEXTURE_CUBE_MAP_POSITIVE_Y,pz:c.TEXTURE_CUBE_MAP_POSITIVE_Z,nx:c.TEXTURE_CUBE_MAP_NEGATIVE_X,ny:c.TEXTURE_CUBE_MAP_NEGATIVE_Y,nz:c.TEXTURE_CUBE_MAP_NEGATIVE_Z},y=b.derive(function(){return{softShadow:y.PCF,blurSize:1,shadowCascade:1,cascadeSplitLogFactor:.2,_textures:{},_shadowMapNumber:{POINT_LIGHT:0,DIRECTIONAL_LIGHT:0,SPOT_LIGHT:0},_meshMaterials:{},_depthMaterials:{},_distanceMaterials:{},_opaqueCasters:[],_receivers:[],_lightsCastShadow:[],_lightCameras:{}}},function(){this._gaussianPassH=new r({fragment:h.source("buildin.compositor.gaussian_blur_h")}),this._gaussianPassV=new r({fragment:h.source("buildin.compositor.gaussian_blur_v")}),this._gaussianPassH.setUniform("blurSize",this.blurSize),this._gaussianPassV.setUniform("blurSize",this.blurSize),this._outputDepthPass=new r({fragment:h.source("buildin.sm.debug_depth")}),this.softShadow===y.VSM&&this._outputDepthPass.material.shader.define("fragment","USE_VSM")},{render:function(a,b,c){this.trigger("beforerender",this,a,b,c),this._renderShadowPass(a,b,c),this.trigger("afterrender",this,a,b,c)},renderDebug:function(a,b){var d=a.clear;a.clear=c.DEPTH_BUFFER_BIT;var e=a.viewportInfo,f=0,g=0,h=b||e.width/4,i=h;for(var j in this._textures)a.setViewport(f,g,h,i),this._outputDepthPass.setUniform("depthMap",this._textures[j]),this._outputDepthPass.render(a),f+=h;a.setViewport(e),a.clear=d},_bindDepthMaterial:function(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=this._depthMaterials[d.joints.length];d.material!==e&&(e||(e=new l({shader:new h({vertex:h.source("buildin.sm.depth.vertex"),fragment:h.source("buildin.sm.depth.fragment")})}),d.joints.length>0&&(e.shader.define("vertex","SKINNING"),e.shader.define("vertex","JOINT_NUMBER",d.joints.length)),this._depthMaterials[d.joints.length]=e),this._meshMaterials[d.__GUID__]=d.material,d.material=e,this.softShadow===y.VSM?e.shader.define("fragment","USE_VSM"):e.shader.unDefine("fragment","USE_VSM"),e.setUniform("bias",b))}},_bindDistanceMaterial:function(a,b){for(var c=0;c<a.length;c++){var d=a[c],e=this._distanceMaterials[d.joints.length];d.material!==e&&(e||(e=new l({shader:new h({vertex:h.source("buildin.sm.distance.vertex"),fragment:h.source("buildin.sm.distance.fragment")})}),d.joints.length>0&&(e.shader.define("vertex","SKINNING"),e.shader.define("vertex","JOINT_NUMBER",d.joints.length)),this._distanceMaterials[d.joints.length]=e),this._meshMaterials[d.__GUID__]=d.material,d.material=e,this.softShadow===y.VSM?e.shader.define("fragment","USE_VSM"):e.shader.unDefine("fragment","USE_VSM"),e.set("lightPosition",b.position._array),e.set("range",5*b.range))}},_restoreMaterial:function(a){for(var b=0;b<a.length;b++){var c=a[b];c.material=this._meshMaterials[c.__GUID__]}},_update:function(a){for(var b=0;b<a.opaqueQueue.length;b++){var c=a.opaqueQueue[b];c.castShadow&&this._opaqueCasters.push(c),c.receiveShadow?(this._receivers.push(c),c.material.__shadowUniformUpdated=!1,c.material.shader.__shadowDefineUpdated=!1,c.material.set("shadowEnabled",1)):c.material.set("shadowEnabled",0),this.softShadow===y.VSM?c.material.shader.define("fragment","USE_VSM"):c.material.shader.unDefine("fragment","USE_VSM")}for(var b=0;b<a.lights.length;b++){var d=a.lights[b];d.castShadow&&this._lightsCastShadow.push(d)}},_renderShadowPass:function(a,b,c){for(var d in this._shadowMapNumber)this._shadowMapNumber[d]=0;this._lightsCastShadow.length=0,this._opaqueCasters.length=0,this._receivers.length=0;var e=a.gl;if(b.update(),this._update(b),this._lightsCastShadow.length){e.enable(e.DEPTH_TEST),e.depthMask(!0),e.disable(e.BLEND),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);for(var f=[],g=[],h=[],l=[],m=[],n=[],o=[],p=0;p<this._lightsCastShadow.length;p++){var q=this._lightsCastShadow[p];q instanceof j?this._renderDirectionalLightShadow(a,q,b,c,this._opaqueCasters,m,l,h):q instanceof i?this._renderSpotLightShadow(a,q,this._opaqueCasters,g,f):q instanceof k&&this._renderPointLightShadow(a,q,this._opaqueCasters,o,n),this._shadowMapNumber[q.type]++}this._restoreMaterial(this._opaqueCasters),this.shadowCascade>1&&this._shadowMapNumber.DIRECTIONAL_LIGHT>1&&console.warn("There is only one directional light can cast shadow when using cascaded shadow map");var r=m.slice(),s=m.slice();r.pop(),s.shift();for(var p=0;p<this._receivers.length;p++){var t=this._receivers[p],u=t.material;if(!u.__shadowUniformUpdated){var v=u.shader;if(!v.__shadowDefineUpdated){var w=!1;for(var x in this._shadowMapNumber){var y=this._shadowMapNumber[x],z=x+"_SHADOWMAP_NUMBER";v.fragmentDefines[z]!==y&&y>0&&(v.fragmentDefines[z]=y,w=!0)}w&&v.dirty(),v.define("fragment","SHADOW_CASCADE",this.shadowCascade||1),v.__shadowDefineUpdated=!0}f.length>0&&(u.setUniform("spotLightShadowMaps",f),u.setUniform("spotLightMatrices",g)),h.length>0&&(u.setUniform("directionalLightShadowMaps",h),this.shadowCascade>1&&(u.setUniform("shadowCascadeClipsNear",r),u.setUniform("shadowCascadeClipsFar",s)),u.setUniform("directionalLightMatrices",l)),n.length>0&&(u.setUniform("pointLightShadowMaps",n),u.setUniform("pointLightRanges",o)),u.__shadowUniformUpdated=!0}}}},_renderDirectionalLightShadow:function(){var a=new f,b=new g,c=new e,d=new g,h=new g,i=new g;return function(e,f,j,k,l,m,n,o){this._bindDepthMaterial(l,f.shadowBias);var p=k.far;k.far=Math.min(k.far,-k.sceneBoundingBoxLastFrame.min.z),k.far=Math.max(k.near,k.far),k.updateProjectionMatrix(),k.frustum.setFromProjection(k.projectionMatrix);var q=this._getDirectionalLightCamera(f,j,k),r=h._array;u.copy(r,q.worldTransform._array),u.invert(r,r),u.multiply(r,q.projectionMatrix._array,r),u.multiply(r,r,k.worldTransform._array),i.copy(q.projectionMatrix);for(var s=[],t=k.near,w=k.far,x=k.fov/180*Math.PI,z=k.aspect,A=(t+p)/(t-p),B=2*t*p/(t-p),C=0;C<=this.shadowCascade;C++){var D=t*Math.pow(w/t,C/this.shadowCascade),E=t+(w-t)*C/this.shadowCascade,F=D*this.cascadeSplitLogFactor+E*(1-this.cascadeSplitLogFactor);s.push(F),m.push(-(-F*A+B)/-F)}for(var C=0;C<this.shadowCascade;C++){var G=this._getTexture(f.__GUID__+"_"+C,f),H=s[C],I=s[C+1];u.perspective(b._array,x,z,H,I),a.setFromProjection(b),a.getTransformedBoundingBox(c,h);var J=c.min._array,K=c.max._array;d.ortho(J[0],K[0],J[1],K[1],1,-1),q.projectionMatrix.multiplyLeft(d);var L=e.gl;v.attach(L,G),v.bind(e),L.clear(L.COLOR_BUFFER_BIT|L.DEPTH_BUFFER_BIT),e.renderQueue(l,q),v.unbind(e),this.softShadow===y.VSM&&this._gaussianFilter(e,G,G.width);var M=new g;M.copy(q.worldTransform).invert().multiplyLeft(q.projectionMatrix),o.push(G),n.push(M._array),q.projectionMatrix.copy(i)}k.far=p}}(),_renderSpotLightShadow:function(a,b,c,d,e){this._bindDepthMaterial(c,b.shadowBias);var f=this._getTexture(b.__GUID__,b),h=this._getSpotLightCamera(b),i=a.gl;v.attach(i,f),v.bind(a),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),a.renderQueue(c,h),v.unbind(a),this.softShadow===y.VSM&&this._gaussianFilter(a,f,f.width);var j=new g;j.copy(h.worldTransform).invert().multiplyLeft(h.projectionMatrix),e.push(f),d.push(j._array)},_renderPointLightShadow:function(a,b,c,d,e){var f=this._getTexture(b.__GUID__,b),g=a.gl;e.push(f),d.push(5*b.range),this._bindDistanceMaterial(c,b);for(var h=0;6>h;h++){var i=w[h],j=this._getPointLightCamera(b,i);v.attach(a.gl,f,g.COLOR_ATTACHMENT0,x[i]),v.bind(a),g.clear(g.COLOR_BUFFER_BIT|g.DEPTH_BUFFER_BIT),a.renderQueue(c,j),v.unbind(a)}},_gaussianFilter:function(a,b,d){var e={width:d,height:d,type:c.FLOAT},f=a.gl,g=s.get(e);v.attach(f,g),v.bind(a),this._gaussianPassH.setUniform("texture",b),this._gaussianPassH.setUniform("textureHeight",d),this._gaussianPassH.render(a),v.unbind(a),v.attach(f,b),v.bind(a),this._gaussianPassV.setUniform("texture",g),this._gaussianPassV.setUniform("textureWidth",d),this._gaussianPassV.render(a),v.unbind(a),s.put(g)},_getTexture:function(a,b){var d=this._textures[a],e=b.shadowResolution||512;return d||(d=b instanceof k?new o:new n,d.width=e,d.height=e,this.softShadow===y.VSM?(d.type=c.FLOAT,d.anisotropic=4):(d.minFilter=c.NEAREST,d.magFilter=c.NEAREST,d.useMipmap=!1),this._textures[a]=d),d},_getPointLightCamera:function(a,b){this._lightCameras.point||(this._lightCameras.point={px:new p,nx:new p,py:new p,ny:new p,pz:new p,nz:new p});var c=this._lightCameras.point[b];switch(c.worldTransform.copy(a.worldTransform),c.far=a.range,c.fov=90,c.position.set(0,0,0),b){case"px":c.lookAt(d.POSITIVE_X,d.NEGATIVE_Y);break;case"nx":c.lookAt(d.NEGATIVE_X,d.NEGATIVE_Y);break;case"py":c.lookAt(d.POSITIVE_Y,d.POSITIVE_Z);break;case"ny":c.lookAt(d.NEGATIVE_Y,d.NEGATIVE_Z);break;case"pz":c.lookAt(d.POSITIVE_Z,d.NEGATIVE_Y);break;case"nz":c.lookAt(d.NEGATIVE_Z,d.NEGATIVE_Y)}return c.position.copy(a.position),c.update(),c},_getDirectionalLightCamera:function(){var a=new g,b=new e;return function(c,d,e){this._lightCameras.directional||(this._lightCameras.directional=new q);var f=this._lightCameras.directional;f.position.copy(e.frustum.boundingBox.min).add(e.frustum.boundingBox.max).scale(.5).transformMat4(e.worldTransform),f.rotation.copy(c.rotation),f.scale.copy(c.scale),f.updateLocalTransform(),f.updateWorldTransform(),a.copy(f.worldTransform).invert().multiply(e.worldTransform),e.frustum.getTransformedBoundingBox(b,a);var g=b.min._array,h=b.max._array;return f.position.scaleAndAdd(f.worldTransform.forward,h[2]),f.near=0,f.far=-g[2]+h[2],f.left=g[0],f.right=h[0],f.top=h[1],f.bottom=g[1],f.updateLocalTransform(),f.updateWorldTransform(),f.updateProjectionMatrix(),f.frustum.setFromProjection(f.projectionMatrix),f}}(),_getSpotLightCamera:function(a){this._lightCameras.spot||(this._lightCameras.spot=new p);var b=this._lightCameras.spot;return b.fov=2*a.penumbraAngle,b.far=a.range,b.worldTransform.copy(a.worldTransform),b.updateProjectionMatrix(),b},dispose:function(a){for(var b in this._depthMaterials){var c=this._depthMaterials[b];c.dispose()}for(var b in this._distanceMaterials){var c=this._distanceMaterials[b];c.dispose()}for(var d in this._textures)this._textures[d].dispose(a);this._depthMaterials={},this._distanceMaterials={},this._textures={},this._lightCameras={},this._shadowMapNumber={POINT_LIGHT:0,DIRECTIONAL_LIGHT:0,SPOT_LIGHT:0},this._meshMaterials={};for(var e=0;e<this._receivers.length;e++){var f=this._receivers[e],g=f.material,h=g.shader;h.unDefine("fragment","POINT_LIGHT_SHADOW_NUMBER"),h.unDefine("fragment","DIRECTIONAL_LIGHT_SHADOW_NUMBER"),h.unDefine("fragment","AMBIENT_LIGHT_SHADOW_NUMBER"),g.set("shadowEnabled",0)}this._opaqueCasters=[],this._receivers=[],this._lightsCastShadow=[]}});return y.VSM=1,y.PCF=2,y}),d("util/dds",["require","../Texture","../texture/Texture2D","../texture/TextureCube"],function(a){function b(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}a("../Texture"),a("../texture/Texture2D"),a("../texture/TextureCube"),b("DXT1"),b("DXT3"),b("DXT5")}),d("util/hdr",["require","../Texture","../texture/Texture2D"],function(a){function b(a,b,c,d){if(a[3]>0){var e=Math.pow(2,a[3]-128-8+d);b[c+0]=a[0]*e,b[c+1]=a[1]*e,b[c+2]=a[2]*e}else b[c+0]=0,b[c+1]=0,b[c+2]=0;return b[c+3]=1,b}function c(a,b,c){for(var d="",e=b;c>e;e++)d+=h(a[e]);return d}function d(a,b,c,d){for(var e=0,f=0,g=d;g>0;)if(a[f][0]=b[c++],a[f][1]=b[c++],a[f][2]=b[c++],a[f][3]=b[c++],1===a[f][0]&&1===a[f][1]&&1===a[f][2]){for(var h=a[f][3]<<e>>>0;h>0;h--)copy(a[f-1],a[f]),f++,g--;e+=8}else f++,g--,e=0;return c}function e(a,b,c,e){if(i>e|e>j)return d(a,b,c,e);var f=b[c++];if(2!=f)return d(a,b,c-1,e);if(a[0][1]=b[c++],a[0][2]=b[c++],f=b[c++],(a[0][2]<<8>>>0|f)>>>0!==e)return null;for(var f=0;4>f;f++)for(var g=0;e>g;){var h=b[c++];if(h>128){h=(127&h)>>>0;for(var k=b[c++];h--;)a[g++][f]=k}else for(;h--;)a[g++][f]=b[c++]}return c}var f=a("../Texture"),g=a("../texture/Texture2D"),h=String.fromCharCode,i=8,j=32767,k={parseRGBE:function(a,d,i){void 0===i&&(i=0);var j=new Uint8Array(a),k=j.length;if("#?"===c(j,0,2)){for(var l=2;k>l&&("\n"!==h(j[l])||"\n"!==h(j[l+1]));l++);if(!(l>=k)){l+=2;for(var m="";k>l;l++){var n=h(j[l]);if("\n"===n)break;m+=n}var o=m.split(" "),p=parseInt(o[1]),q=parseInt(o[3]);if(q&&p){for(var r=l+1,s=[],t=0;q>t;t++){s[t]=[];for(var u=0;4>u;u++)s[t][u]=0}for(var v=new Float32Array(4*q*p),w=0,x=0;p>x;x++){var r=e(s,j,r,q);if(!r)return null;for(var t=0;q>t;t++)b(s[t],v,w,i),w+=4}return d||(d=new g),d.width=q,d.height=p,d.pixels=v,d.type=f.FLOAT,d}}}},parseRGBEFromPNG:function(){}};return k}),d("util/mesh",["require","../Geometry","../Mesh","../Node","../Material","../Shader","glmatrix","_"],function(a){var b=a("../Geometry"),c=a("../Mesh"),d=a("../Node"),e=a("../Material");a("../Shader");var f=a("glmatrix"),g=a("_");f.mat4;var h=f.vec3,i=Array.prototype.slice,j={merge:function(a,d){function e(a){return d?a&&Array.prototype.slice.call(a):a}if(a.length){var d="undefined"==typeof d?!0:d,f=a[0],i=f.geometry,j=f.material;g.any(a,function(a){return a.material!==j})&&console.warn("Material of meshes to merge is not the same, program will use the material of first mesh by default");var k=new b,l=k.faces;for(var m in i.attributes){var n=i.attributes[m];k.attributes[m]||(k.attributes[m]={value:[],type:n.type})}for(var o=0,p=0!==i.faces.length,q=0;q<a.length;q++){var r=a[q],s=r.geometry;r.updateLocalTransform();var t=s.getVerticesNumber();for(var m in s.attributes){var u=s.attributes[m],v=k.attributes[m];if(u.value.length)for(var w=0;t>w;w++)if("position"===m){var x=e(u.value[w]);h.transformMat4(x,x,r.localTransform._array),v.value.push(x)}else if("normal"===m){var x=e(u.value[w]);v.value.push(x)}else if("tangent"===m){var x=e(u.value[w]);v.value.push(x)}else v.value.push(e(u.value[w]))}if(p){var y=s.faces.length;for(w=0;y>w;w++){var z=[],A=s.faces[w];z[0]=A[0]+o,z[1]=A[1]+o,z[2]=A[2]+o,l.push(z)}}o+=t}return new c({material:j,geometry:k})}},splitByJoints:function(a,f,g){var h=a.geometry,j=a.skeleton,k=a.material,l=k.shader,m=a.joints;if(h&&j&&m.length){if(m.length<f)return a;var n={},o=h.faces;Math.ceil(m.length/f);for(var p=h.faces.length,q=p,r=[],s=h.attributes.joint.value,t=0;p>t;t++)r[t]=!1;for(var u=[],v=[];q>0;){for(var w=[],x=[],y=[],z=0,t=0;t<m.length;t++)x[t]=-1;for(var A=0;p>A;A++)if(!r[A]){for(var B=o[A],C=!0,D=0,t=0;3>t;t++)for(var E=B[t],F=0;4>F;F++){var G=s[E][F];G>=0&&-1===x[G]&&(f>z?(x[G]=z,y[z++]=G,u[D++]=G):C=!1)}if(C)w.push(B),r[A]=!0,q--;else for(var t=0;D>t;t++)x[u[t]]=-1,y.pop(),z--}v.push({faces:w,joints:y.map(function(a){return m[a]}),jointReverseMap:x})}var H=new d({name:a.name}),I=Object.keys(h.getEnabledAttributes());I.splice(I.indexOf("joint"),1);for(var J=[],K=0;K<v.length;K++){var L=v[K],M=L.jointReverseMap,z=L.joints.length,N=n[z];N||(N=l.clone(),N.define("vertex","JOINT_NUMBER",z),n[z]=N);var O=new e({name:[k.name,K].join("-"),shader:N,transparent:k.transparent,depthTest:k.depthTest,depthMask:k.depthMask,blend:k.blend});for(var P in k.uniforms){var Q=k.uniforms[P];O.set(P,Q.value)}for(var R=new b,S=new c({name:[a.name,t].join("-"),material:O,geometry:R,skeleton:j,joints:L.joints.slice()}),T=0,t=0;t<h.getVerticesNumber();t++)J[t]=-1;for(var A=0;A<L.faces.length;A++){for(var B=L.faces[A],U=[],t=0;3>t;t++){var E=B[t];if(-1===J[E]){J[E]=T;for(var V=0;V<I.length;V++){var W=I[V],X=h.attributes[W],Y=R.attributes[W];Y.value[T]=1===X.size?X.value[E]:i.call(X.value[E])}for(var Z=R.attributes.joint.value[T]=[-1,-1,-1,-1],F=0;4>F;F++){var G=h.attributes.joint.value[E][F];G>=0&&(Z[F]=M[G])}T++}U.push(J[E])}R.faces.push(U)}H.add(S)}for(var $=a.children(),t=0;t<$.length;t++)H.add($[t]);if(H.position.copy(a.position),H.rotation.copy(a.rotation),H.scale.copy(a.scale),k.dispose(),g&&a.parent){var _=a.parent;_.remove(a),_.add(H)}return H}}};return j}),d("util/texture",["require","../Texture","../texture/Texture2D","../texture/TextureCube","../core/request","../prePass/EnvironmentMap","../plugin/Skydome","../Scene","./dds","./hdr"],function(a){a("../Texture");var b=a("../texture/Texture2D"),c=a("../texture/TextureCube"),d=a("../core/request"),e=a("../prePass/EnvironmentMap"),f=a("../plugin/Skydome"),g=a("../Scene"),h=a("./dds"),i=a("./hdr"),j=new e,k={loadTexture:function(a,d,e){var f;if("string"==typeof a){if(a.match(/.hdr$/))return f=new b({width:0,height:0}),k._fetchTexture(a,function(a){i.parseRGBE(a,f),f.dirty(),d&&d(f)},e),f;a.match(/.dds$/)?(f=new b({width:0,height:0}),k._fetchTexture(a,function(a){h.parse(a,f),f.dirty(),d&&d(f)},e)):(f=new b,f.load(a),f.success(d),f.error(e))}else if(a instanceof Array){var f=new c;f.load(a),f.success(d),f.error(e)}return f},loadPanorama:function(a,b,c,d,e){var f=this;k.loadTexture(a,function(a){a.flipY=!1,f.panoramaToCubeMap(a,b,c),a.dispose(c.gl),d&&d(b)},e)},panoramaToCubeMap:function(a,b,c){var d=new f({scene:new g});return d.material.set("diffuseMap",a),j.texture=b,j.render(c,d.scene),j.texture=null,b},_fetchTexture:function(a,b,c){d.get({url:a,responseType:"arraybuffer",onload:b,onerror:c})}};return k}),d("qtek/qtek",["require","2d/Camera","2d/CanvasRenderer","2d/Gradient","2d/LinearGradient","2d/Node","2d/Pattern","2d/RadialGradient","2d/Scene","2d/Style","2d/picking/Box","2d/picking/Pixel","2d/shape/Arc","2d/shape/Circle","2d/shape/Ellipse","2d/shape/HTML","2d/shape/Image","2d/shape/Line","2d/shape/Path","2d/shape/Polygon","2d/shape/Rectangle","2d/shape/RoundedRectangle","2d/shape/SVGPath","2d/shape/Sector","2d/shape/Text","2d/shape/TextBox","2d/util","Camera","FrameBuffer","Geometry","Joint","Layer","Light","Material","Mesh","Node","Renderer","Scene","Shader","Skeleton","Stage","Texture","animation/Animation","animation/Clip","animation/easing","camera/Orthographic","camera/Perspective","compositor/Compositor","compositor/Graph","compositor/Group","compositor/Node","compositor/Pass","compositor/SceneNode","compositor/TextureNode","compositor/texturePool","core/Base","core/Cache","core/Event","core/async","core/color","core/glenum","core/glinfo","core/mixin/derive","core/mixin/notifier","core/request","core/util","debug/PointLight","geometry/Cube","geometry/Plane","geometry/Sphere","light/Ambient","light/Directional","light/Point","light/Spot","loader/FX","loader/GLTF","loader/InstantGeometry","loader/SVG","loader/three/Model","math/BoundingBox","math/Frustum","math/Matrix2","math/Matrix2d","math/Matrix3","math/Matrix4","math/Plane","math/Quaternion","math/Ray","math/Value","math/Vector2","math/Vector3","math/Vector4","particleSystem/Emitter","particleSystem/ForceField","particleSystem/GravityField","particleSystem/Particle","particleSystem/ParticleSystem","picking/Pixel","plugin/FirstPersonControl","plugin/OrbitControl","plugin/Skybox","plugin/Skydome","prePass/EnvironmentMap","prePass/Reflection","prePass/ShadowMap","shader/library","texture/Texture2D","texture/TextureCube","util/dds","util/hdr","util/mesh","util/texture","glmatrix"],function(a){var b={"2d":{Camera:a("2d/Camera"),CanvasRenderer:a("2d/CanvasRenderer"),Gradient:a("2d/Gradient"),LinearGradient:a("2d/LinearGradient"),Node:a("2d/Node"),Pattern:a("2d/Pattern"),RadialGradient:a("2d/RadialGradient"),Scene:a("2d/Scene"),Style:a("2d/Style"),picking:{Box:a("2d/picking/Box"),Pixel:a("2d/picking/Pixel")},shape:{Arc:a("2d/shape/Arc"),Circle:a("2d/shape/Circle"),Ellipse:a("2d/shape/Ellipse"),HTML:a("2d/shape/HTML"),Image:a("2d/shape/Image"),Line:a("2d/shape/Line"),Path:a("2d/shape/Path"),Polygon:a("2d/shape/Polygon"),Rectangle:a("2d/shape/Rectangle"),RoundedRectangle:a("2d/shape/RoundedRectangle"),SVGPath:a("2d/shape/SVGPath"),Sector:a("2d/shape/Sector"),Text:a("2d/shape/Text"),TextBox:a("2d/shape/TextBox")},util:a("2d/util")},Camera:a("Camera"),FrameBuffer:a("FrameBuffer"),Geometry:a("Geometry"),Joint:a("Joint"),Layer:a("Layer"),Light:a("Light"),Material:a("Material"),Mesh:a("Mesh"),Node:a("Node"),Renderer:a("Renderer"),Scene:a("Scene"),Shader:a("Shader"),Skeleton:a("Skeleton"),Stage:a("Stage"),Texture:a("Texture"),animation:{Animation:a("animation/Animation"),Clip:a("animation/Clip"),easing:a("animation/easing")},camera:{Orthographic:a("camera/Orthographic"),Perspective:a("camera/Perspective")},compositor:{Compositor:a("compositor/Compositor"),Graph:a("compositor/Graph"),Group:a("compositor/Group"),Node:a("compositor/Node"),Pass:a("compositor/Pass"),SceneNode:a("compositor/SceneNode"),TextureNode:a("compositor/TextureNode"),texturePool:a("compositor/texturePool")},core:{Base:a("core/Base"),Cache:a("core/Cache"),Event:a("core/Event"),async:a("core/async"),color:a("core/color"),glenum:a("core/glenum"),glinfo:a("core/glinfo"),mixin:{derive:a("core/mixin/derive"),notifier:a("core/mixin/notifier")},request:a("core/request"),util:a("core/util")},debug:{PointLight:a("debug/PointLight")},geometry:{Cube:a("geometry/Cube"),Plane:a("geometry/Plane"),Sphere:a("geometry/Sphere")},light:{Ambient:a("light/Ambient"),Directional:a("light/Directional"),Point:a("light/Point"),Spot:a("light/Spot")},loader:{FX:a("loader/FX"),GLTF:a("loader/GLTF"),InstantGeometry:a("loader/InstantGeometry"),SVG:a("loader/SVG"),three:{Model:a("loader/three/Model")}},math:{BoundingBox:a("math/BoundingBox"),Frustum:a("math/Frustum"),Matrix2:a("math/Matrix2"),Matrix2d:a("math/Matrix2d"),Matrix3:a("math/Matrix3"),Matrix4:a("math/Matrix4"),Plane:a("math/Plane"),Quaternion:a("math/Quaternion"),Ray:a("math/Ray"),Value:a("math/Value"),Vector2:a("math/Vector2"),Vector3:a("math/Vector3"),Vector4:a("math/Vector4")},particleSystem:{Emitter:a("particleSystem/Emitter"),ForceField:a("particleSystem/ForceField"),GravityField:a("particleSystem/GravityField"),Particle:a("particleSystem/Particle"),ParticleSystem:a("particleSystem/ParticleSystem")},picking:{Pixel:a("picking/Pixel")},plugin:{FirstPersonControl:a("plugin/FirstPersonControl"),OrbitControl:a("plugin/OrbitControl"),Skybox:a("plugin/Skybox"),Skydome:a("plugin/Skydome")},prePass:{EnvironmentMap:a("prePass/EnvironmentMap"),Reflection:a("prePass/Reflection"),ShadowMap:a("prePass/ShadowMap")},shader:{library:a("shader/library")},texture:{Texture2D:a("texture/Texture2D"),TextureCube:a("texture/TextureCube")},util:{dds:a("util/dds"),hdr:a("util/hdr"),mesh:a("util/mesh"),texture:a("util/texture")}},c=a("glmatrix");
return b.glMatrix=c,b}),d("qtek",["qtek/qtek"],function(a){return a});var e=c("qtek");for(var f in e)a[f]=e[f]});